<!DOCTYPE html><html lang="zh-CN"><head><meta name="viewport" content="width=device-width"/><title>gmp模型</title><meta name="robots" content="follow, index"/><meta charSet="UTF-8"/><meta name="description" content="gmp模型"/><meta property="og:type"/><meta property="og:title" content="gmp模型"/><meta property="og:description" content="gmp模型"/><meta property="og:url" content="https://wwqdrh.github.io/undefined"/><meta name="keywords" content="wwqdrh技术博客"/><meta property="og:locale" content="zh-CN"/><meta property="og:image" content="https://wwqdrh.github.io"/><meta name="twitter:title" content="gmp模型"/><meta name="twitter:description" content="gmp模型"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="https://wwqdrh.github.io"/><link rel="stylesheet" href="/assets/mdrender/editor-render.css"/><meta name="next-head-count" content="17"/><link rel="icon" href="/favicon.ico"/><link rel="apple-touch-icon" sizes="192x192" href="/apple-touch-icon.png"/><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/feed"/><script src="/assets/analizy/clarity.js"></script><link rel="preload" href="/_next/static/media/d83e92f0af8b17e4-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/ed42d1b51efd45f6-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/fba9d678ff638e59-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/e52907b750a6f61e-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/9031250013752d4b-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/eb9adf802b0a60eb-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/81b352a4d7a000ae-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/41b9b3ece820718f-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/d587d1c112526568-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/css/869c7de7c781f904.css" as="style"/><link rel="stylesheet" href="/_next/static/css/869c7de7c781f904.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-fbe37f60a09a330b.js" defer=""></script><script src="/_next/static/chunks/main-082d90b1269d95f6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-494ee9c4b0594b31.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-222bf60d0a2bf3df.js" defer=""></script><script src="/_next/static/PMB5qMppIrri5HN2Gb314/_buildManifest.js" defer=""></script><script src="/_next/static/PMB5qMppIrri5HN2Gb314/_ssgManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css-global c86wz">body{margin:0;padding:0;color:hsl(0, 0%, 9.0%);background-color:hsl(0, 0%, 97.3%);font-family:'__pretendard_6bb8e5','__pretendard_Fallback_6bb8e5';}*{-webkit-print-color-scheme:light;color-scheme:light;box-sizing:border-box;}h1,h2,h3,h4,h5,h6{margin:0;font-weight:inherit;font-style:inherit;}a{all:unset;cursor:pointer;}ul{padding:0;}button{all:unset;cursor:pointer;}input{all:unset;box-sizing:border-box;}textarea{border:none;background-color:transparent;font-family:inherit;padding:0;outline:none;resize:none;color:inherit;}hr{width:100%;border:none;margin:0;border-top:1px solid hsl(0, 0%, 88.7%);}</style><style data-emotion="css 1q70a33">.css-1q70a33{z-index:30;position:-webkit-sticky;position:sticky;top:0;background-color:hsl(0, 0%, 97.3%);box-shadow:0 1px 2px 0 rgba(0, 0, 0, 0.05);}.css-1q70a33 .container{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:100%;height:3rem;margin:0 auto;}@media (min-width: 768px){.css-1q70a33 .container[data-full-width="true"]{padding-left:6rem;padding-right:6rem;}}.css-1q70a33 .container .nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;gap:0.75rem;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-1q70a33 .container .mid{padding-top:0.5rem;padding-bottom:0.5rem;padding-left:1.25rem;padding-right:1.25rem;border-radius:1rem;outline-style:none;width:50%;background-color:hsl(0, 0%, 93.0%);}</style><div class="py-2 css-1q70a33"><div data-full-width="false" class="container"><a aria-label="wwqdrh" class="css-0" href="/">wwqdrh</a><input class="mid" type="text" placeholder="Search Keyword..." value=""/><div class="nav"><style data-emotion="css 1nw6zn9">.css-1nw6zn9{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}.css-1nw6zn9 ul{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}.css-1nw6zn9 ul li{display:block;margin-left:1rem;color:hsl(0, 0%, 43.5%);}</style><div class="css-1nw6zn9"><ul><li><a target="_blank" href="https://space.bilibili.com/538676331">B站</a></li></ul></div><style data-emotion="css 1h5x3dy">.css-1h5x3dy{cursor:pointer;}</style><div class="css-1h5x3dy"><style data-emotion="css p95608">.css-p95608{font-family:'__Noto_Color_Emoji_be1378','__Noto_Color_Emoji_Fallback_be1378',Apple Color Emoji;font-weight:400;font-style:normal;}</style><span class="css-p95608">☀️</span></div></div></div></div><style data-emotion="css lomkhl">.css-lomkhl{margin:0 auto;width:100%;padding:0 3rem;}</style><main class="css-lomkhl"><div class="divide-y bg-white dark:bg-gray-700 p-6 shadow-lg rounded-lg mt-3 divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="max-w-none pt-10 pb-8 prose dark:prose-dark"><div><h1>简介</h1>
<p>gmp模型是golang中并发的基本模型。</p>
<p><code>复用线程</code></p>
<p>goroutines本身就是运行在一组线程之上，不需要频繁的创建、销毁线程，而是对线程的复用。在调度器中复用线程还有2个体现：  </p>
<ul>
<li>work stealing，当本线程无可运行的G时，尝试从其他线程绑定的P偷取G，而不是销毁线程。   </li>
<li>hand off，当本线程因为G进行系统调用阻塞时，线程释放绑定的P，把P转移给其他空闲的线程执行。</li>
</ul>
<h2>goroutine</h2>
<p>其中g表示goroutine, 是程序的一个并发基本粒度，每个goroutine都维护着自己的栈区，栈结构是连续栈，是一块连续的内存，g结构体标记着栈区边界的stack信息，stack里记录着栈区边界的高位内存地址和低位内存地址。(有栈)协程可以理解为一个用户态下的线程，在用户态下进行线程（协程）的上下文切换。</p>
<p>用户可以在堆上模拟出协程的栈空间，当需要进行协程上下文切换的时候，主线程只需要交换栈空间和恢复协程的一些相关的寄存器的状态就可以实现一个用户态的线程上下文切换，没有了从用户态转换到内核态的切换成本，协程的执行也就更加高效。</p>
<h2>processor</h2>
<p>P表示逻辑processor，代表线程M的执行的上下文。</p>
<p>P的最大作用是其拥有的各种G对象队列、链表、cache和状态。</p>
<p>P的数量也代表了golang的执行并发度，即有多少goroutine可以同时运行</p>
<p>对M来说，P提供了相关的执行环境(Context)，如内存分配状态(mcache)，任务队列(G)等</p>
<h2>machine</h2>
<p>真正的执行计算单元</p>
<p>M在绑定有效的P后，进入调度循环，而且M并不保留G状态(由p保存)，这是G可以跨M调度的基础。</p>
<h1>启动流程</h1>
<blockquote>
<p>参考: <a href="https://zboya.github.io/post/go_scheduler/#%E6%B7%B1%E5%85%A5golang-runtime%E7%9A%84%E8%B0%83%E5%BA%A6">https://zboya.github.io/post/go_scheduler/#%E6%B7%B1%E5%85%A5golang-runtime%E7%9A%84%E8%B0%83%E5%BA%A6</a></p>
</blockquote>
<img src="/blog/static/images/blogs/go启动流程.png" />

<p>m0 表示进程启动的第一个线程，也叫主线程。它和其他的m没有什么区别，要说区别的话，它是进程启动通过汇编直接复制给m0的，m0是个全局变量，而其他的m都是runtime内自己创建的。</p>
<p>每个m都有一个g0，因为每个线程有一个系统堆栈，g0 虽然也是g的结构，但和普通的g还是有差别的，最重要的差别就是栈的差别。g0 上的栈是系统分配的栈，在linux上栈大小默认固定8MB，不能扩展，也不能缩小。 而普通g一开始只有2KB大小，可扩展。在 g0 上也没有任何任务函数，也没有任何状态，并且它不能被调度程序抢占。因为调度就是在g0上跑的。</p>
<p>go 关键字创建了G，并插入到P的本地队列或者全局队列，线程M从各个队列中或者从别的P中得到G， 切换到G的执行栈上并执行G上的任务函数，调用goexit做清理工作并回到调度程序，调度程序重新找个可执行的G，并执行，如此反复。 其中 sysmon 会监控整个调度系统，如果某个G长时间占用cpu，会被标记为可抢占。</p>
</div></div></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"\u003ch1\u003e简介\u003c/h1\u003e\n\u003cp\u003egmp模型是golang中并发的基本模型。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e复用线程\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003egoroutines本身就是运行在一组线程之上，不需要频繁的创建、销毁线程，而是对线程的复用。在调度器中复用线程还有2个体现：  \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ework stealing，当本线程无可运行的G时，尝试从其他线程绑定的P偷取G，而不是销毁线程。   \u003c/li\u003e\n\u003cli\u003ehand off，当本线程因为G进行系统调用阻塞时，线程释放绑定的P，把P转移给其他空闲的线程执行。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003egoroutine\u003c/h2\u003e\n\u003cp\u003e其中g表示goroutine, 是程序的一个并发基本粒度，每个goroutine都维护着自己的栈区，栈结构是连续栈，是一块连续的内存，g结构体标记着栈区边界的stack信息，stack里记录着栈区边界的高位内存地址和低位内存地址。(有栈)协程可以理解为一个用户态下的线程，在用户态下进行线程（协程）的上下文切换。\u003c/p\u003e\n\u003cp\u003e用户可以在堆上模拟出协程的栈空间，当需要进行协程上下文切换的时候，主线程只需要交换栈空间和恢复协程的一些相关的寄存器的状态就可以实现一个用户态的线程上下文切换，没有了从用户态转换到内核态的切换成本，协程的执行也就更加高效。\u003c/p\u003e\n\u003ch2\u003eprocessor\u003c/h2\u003e\n\u003cp\u003eP表示逻辑processor，代表线程M的执行的上下文。\u003c/p\u003e\n\u003cp\u003eP的最大作用是其拥有的各种G对象队列、链表、cache和状态。\u003c/p\u003e\n\u003cp\u003eP的数量也代表了golang的执行并发度，即有多少goroutine可以同时运行\u003c/p\u003e\n\u003cp\u003e对M来说，P提供了相关的执行环境(Context)，如内存分配状态(mcache)，任务队列(G)等\u003c/p\u003e\n\u003ch2\u003emachine\u003c/h2\u003e\n\u003cp\u003e真正的执行计算单元\u003c/p\u003e\n\u003cp\u003eM在绑定有效的P后，进入调度循环，而且M并不保留G状态(由p保存)，这是G可以跨M调度的基础。\u003c/p\u003e\n\u003ch1\u003e启动流程\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003e参考: \u003ca href=\"https://zboya.github.io/post/go_scheduler/#%E6%B7%B1%E5%85%A5golang-runtime%E7%9A%84%E8%B0%83%E5%BA%A6\"\u003ehttps://zboya.github.io/post/go_scheduler/#%E6%B7%B1%E5%85%A5golang-runtime%E7%9A%84%E8%B0%83%E5%BA%A6\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cimg src=\"/blog/static/images/blogs/go启动流程.png\" /\u003e\n\n\u003cp\u003em0 表示进程启动的第一个线程，也叫主线程。它和其他的m没有什么区别，要说区别的话，它是进程启动通过汇编直接复制给m0的，m0是个全局变量，而其他的m都是runtime内自己创建的。\u003c/p\u003e\n\u003cp\u003e每个m都有一个g0，因为每个线程有一个系统堆栈，g0 虽然也是g的结构，但和普通的g还是有差别的，最重要的差别就是栈的差别。g0 上的栈是系统分配的栈，在linux上栈大小默认固定8MB，不能扩展，也不能缩小。 而普通g一开始只有2KB大小，可扩展。在 g0 上也没有任何任务函数，也没有任何状态，并且它不能被调度程序抢占。因为调度就是在g0上跑的。\u003c/p\u003e\n\u003cp\u003ego 关键字创建了G，并插入到P的本地队列或者全局队列，线程M从各个队列中或者从别的P中得到G， 切换到G的执行栈上并执行G上的任务函数，调用goexit做清理工作并回到调度程序，调度程序重新找个可执行的G，并执行，如此反复。 其中 sysmon 会监控整个调度系统，如果某个G长时间占用cpu，会被标记为可抢占。\u003c/p\u003e\n","frontMatter":{"readingTime":{"text":"5 min read","minutes":4.54,"time":272400,"words":908},"slug":"gmp模型","fileName":"gmp模型.md","title":"gmp模型","date":"2023-03-01T00:00:00.000Z","tags":["Golang"],"draft":false,"summary":"gmp模型"}},"prev":{"title":"什么是进程","date":"2023-02-28T00:00:00.000Z","tags":["计算机原理"],"draft":false,"summary":"什么是进程","slug":"什么是进程"},"next":{"title":"threejs上手","date":"2023-10-05T00:00:00.000Z","tags":["AR开发"],"draft":false,"summary":"3D模型","slug":"AR开发/threejs上手"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["gmp模型"]},"buildId":"PMB5qMppIrri5HN2Gb314","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>