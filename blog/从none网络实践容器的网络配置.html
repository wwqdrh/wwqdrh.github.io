<!DOCTYPE html><html lang="zh-CN"><head><meta name="viewport" content="width=device-width"/><title>手动建立容器网络实践</title><meta name="robots" content="follow, index"/><meta charSet="UTF-8"/><meta name="description" content="amespace-网络配置实践"/><meta property="og:type"/><meta property="og:title" content="手动建立容器网络实践"/><meta property="og:description" content="amespace-网络配置实践"/><meta property="og:url" content="https://wwqdrh.github.io/undefined"/><meta name="keywords" content="wwqdrh技术博客"/><meta property="og:locale" content="zh-CN"/><meta property="og:image" content="https://wwqdrh.github.io"/><meta name="twitter:title" content="手动建立容器网络实践"/><meta name="twitter:description" content="amespace-网络配置实践"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="https://wwqdrh.github.io"/><link rel="stylesheet" href="/assets/mdrender/editor-render.css"/><meta name="next-head-count" content="17"/><link rel="icon" href="/favicon.ico"/><link rel="apple-touch-icon" sizes="192x192" href="/apple-touch-icon.png"/><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/feed"/><script src="/assets/analizy/clarity.js"></script><link rel="preload" href="/_next/static/media/d83e92f0af8b17e4-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/e52907b750a6f61e-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/ed42d1b51efd45f6-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/9031250013752d4b-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/fba9d678ff638e59-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/eb9adf802b0a60eb-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/81b352a4d7a000ae-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/41b9b3ece820718f-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/d587d1c112526568-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/css/869c7de7c781f904.css" as="style"/><link rel="stylesheet" href="/_next/static/css/869c7de7c781f904.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-fbe37f60a09a330b.js" defer=""></script><script src="/_next/static/chunks/main-082d90b1269d95f6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ebc472ae118a2be0.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-222bf60d0a2bf3df.js" defer=""></script><script src="/_next/static/qwylQn0rAYfx_DG8FLkaO/_buildManifest.js" defer=""></script><script src="/_next/static/qwylQn0rAYfx_DG8FLkaO/_ssgManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css-global c86wz">body{margin:0;padding:0;color:hsl(0, 0%, 9.0%);background-color:hsl(0, 0%, 97.3%);font-family:'__pretendard_6bb8e5','__pretendard_Fallback_6bb8e5';}*{-webkit-print-color-scheme:light;color-scheme:light;box-sizing:border-box;}h1,h2,h3,h4,h5,h6{margin:0;font-weight:inherit;font-style:inherit;}a{all:unset;cursor:pointer;}ul{padding:0;}button{all:unset;cursor:pointer;}input{all:unset;box-sizing:border-box;}textarea{border:none;background-color:transparent;font-family:inherit;padding:0;outline:none;resize:none;color:inherit;}hr{width:100%;border:none;margin:0;border-top:1px solid hsl(0, 0%, 88.7%);}</style><style data-emotion="css 1q70a33">.css-1q70a33{z-index:30;position:-webkit-sticky;position:sticky;top:0;background-color:hsl(0, 0%, 97.3%);box-shadow:0 1px 2px 0 rgba(0, 0, 0, 0.05);}.css-1q70a33 .container{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:100%;height:3rem;margin:0 auto;}@media (min-width: 768px){.css-1q70a33 .container[data-full-width="true"]{padding-left:6rem;padding-right:6rem;}}.css-1q70a33 .container .nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;gap:0.75rem;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-1q70a33 .container .mid{padding-top:0.5rem;padding-bottom:0.5rem;padding-left:1.25rem;padding-right:1.25rem;border-radius:1rem;outline-style:none;width:50%;background-color:hsl(0, 0%, 93.0%);}</style><div class="py-2 css-1q70a33"><div data-full-width="false" class="container"><a aria-label="wwqdrh" class="css-0" href="/">wwqdrh</a><input class="mid" type="text" placeholder="Search Keyword..." value=""/><div class="nav"><style data-emotion="css 1nw6zn9">.css-1nw6zn9{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}.css-1nw6zn9 ul{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}.css-1nw6zn9 ul li{display:block;margin-left:1rem;color:hsl(0, 0%, 43.5%);}</style><div class="css-1nw6zn9"><ul><li><a target="_blank" href="https://space.bilibili.com/538676331">B站</a></li></ul></div><style data-emotion="css 1h5x3dy">.css-1h5x3dy{cursor:pointer;}</style><div class="css-1h5x3dy"><style data-emotion="css p95608">.css-p95608{font-family:'__Noto_Color_Emoji_be1378','__Noto_Color_Emoji_Fallback_be1378',Apple Color Emoji;font-weight:400;font-style:normal;}</style><span class="css-p95608">☀️</span></div></div></div></div><style data-emotion="css lomkhl">.css-lomkhl{margin:0 auto;width:100%;padding:0 3rem;}</style><main class="css-lomkhl"><div class="divide-y bg-white dark:bg-gray-700 p-6 shadow-lg rounded-lg mt-3 divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="max-w-none pt-10 pb-8 prose dark:prose-dark"><div><h1>容器到宿主</h1>
<p>对于容器从自己的 Network Namespace 连接到 Host Network Namespace 的方法，一般来说就只有两类设备接口：一类是veth，另外一类是 macvlan/ipvlan。</p>
<blockquote>
<p>使用centos是因为centos预装了iproute2，可以使用ip命令</p>
</blockquote>
<pre><code class="hljs language-bash">docker run -d --name net-test --network none centos:latest sleep <span class="hljs-number">36000</span>

docker <span class="hljs-built_in">exec</span> -it net-test ip addr
</code></pre><p>就在这个容器的 Network Namespace 里建立 veth</p>
<p>通过 &quot;/proc/$pid/ns/net&quot;这个文件得到 Network Namespace 的 ID，这个 Network Namespace ID 既是这个进程的，也同时属于这个容器。</p>
<p>在&quot;/var/run/netns/&quot;的目录下建立一个符号链接，指向这个容器的 Network Namespace。完成这步操作之后，在后面的&quot;ip netns&quot;操作里，就可以用 pid 的值作为这个容器的 Network Namesapce 的标识了。</p>
<pre><code class="hljs language-bash">pid=$(ps -ef | grep <span class="hljs-string">&quot;sleep 36000&quot;</span> | grep -v grep | awk <span class="hljs-string">&#x27;{print $2}&#x27;</span>)
echo $pid
ln -s /proc/$pid/ns/net /<span class="hljs-keyword">var</span>/run/netns/$pid
</code></pre><p>创建veth虚拟设备，并把其分别放在宿主和容器的命名空间</p>
<p>veth pair设备都有一个ifindex和iflink值，，容器中的eth0设备的ifindex值跟host network namespace中的对应veth pair设备的iflink值相等，反之亦然</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Create a pair of veth interfaces</span>
<span class="hljs-string">ip</span> <span class="hljs-string">link</span> <span class="hljs-string">add</span> <span class="hljs-string">name</span> <span class="hljs-string">veth_host</span> <span class="hljs-string">type</span> <span class="hljs-string">veth</span> <span class="hljs-string">peer</span> <span class="hljs-string">name</span> <span class="hljs-string">veth_container</span>
<span class="hljs-comment"># Put one of them in the new net ns</span>
<span class="hljs-string">ip</span> <span class="hljs-string">link</span> <span class="hljs-string">set</span> <span class="hljs-string">veth_container</span> <span class="hljs-string">netns</span> <span class="hljs-string">$pid</span>

<span class="hljs-comment"># 在次查看容器中的设备会发现已经加入了一个veth</span>
<span class="hljs-attr">63:</span> <span class="hljs-string">veth_container@if64:</span> <span class="hljs-string">&lt;BROADCAST,MULTICAST&gt;</span> <span class="hljs-string">mtu</span> <span class="hljs-number">1500 </span><span class="hljs-string">qdisc</span> <span class="hljs-string">noop</span> <span class="hljs-string">state</span> <span class="hljs-string">DOWN</span> <span class="hljs-string">group</span> <span class="hljs-string">default</span> <span class="hljs-string">qlen</span> <span class="hljs-number">1000</span>
    <span class="hljs-string">link/ether</span> <span class="hljs-number">82</span><span class="hljs-string">:b9:bd:06:99:6b</span> <span class="hljs-string">brd</span> <span class="hljs-string">ff:ff:ff:ff:ff:ff</span> <span class="hljs-string">link-netnsid</span> <span class="hljs-number">0</span>
</code></pre><p>查看docker0所在的网段进行配置，例如</p>
<pre><code class="hljs language-bash"><span class="hljs-number">4</span>: <span class="hljs-attr">docker0</span>: &lt;<span class="hljs-variable constant_">NO</span>-<span class="hljs-variable constant_">CARRIER</span>,<span class="hljs-variable constant_">BROADCAST</span>,<span class="hljs-variable constant_">MULTICAST</span>,<span class="hljs-variable constant_">UP</span>&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue state <span class="hljs-variable constant_">DOWN</span> group <span class="hljs-keyword">default</span>
    link/ether <span class="hljs-number">02</span>:<span class="hljs-number">42</span>:<span class="hljs-attr">ab</span>:<span class="hljs-attr">ee</span>:1<span class="hljs-attr">c</span>:db brd <span class="hljs-attr">ff</span>:<span class="hljs-attr">ff</span>:<span class="hljs-attr">ff</span>:<span class="hljs-attr">ff</span>:<span class="hljs-attr">ff</span>:ff
    inet <span class="hljs-number">172.17</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>/<span class="hljs-number">16</span> brd <span class="hljs-number">172.17</span><span class="hljs-number">.255</span><span class="hljs-number">.255</span> scope <span class="hljs-variable language_">global</span> docker0
       valid_lft forever preferred_lft forever
</code></pre><pre><code class="hljs language-bash"><span class="hljs-comment"># In the container, setup veth_container</span>
ip netns <span class="hljs-built_in">exec</span> $pid ip link <span class="hljs-built_in">set</span> veth_container name eth0
ip netns <span class="hljs-built_in">exec</span> $pid ip addr add <span class="hljs-number">172.17</span><span class="hljs-number">.1</span><span class="hljs-number">.2</span>/<span class="hljs-number">16</span> dev eth0
ip netns <span class="hljs-built_in">exec</span> $pid ip link <span class="hljs-built_in">set</span> eth0 up
ip netns <span class="hljs-built_in">exec</span> $pid ip route add default via <span class="hljs-number">172.17</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>

<span class="hljs-comment"># In the host, set veth_host up</span>
ip link <span class="hljs-built_in">set</span> veth_host up
</code></pre><h1>宿主到eth0</h1>
<p>一个普通 Linux 节点上数据包转发的问题，可以用 nat 来做个转发，或者建立 Overlay 网络发送，也可以通过配置 proxy arp 加路由的方法来实现。</p>
<p>Docker 缺省使用的是 bridge + nat 的转发方式</p>
<p>Docker 程序在节点上安装完之后，就会自动建立了一个 docker0 的 bridge interface。所以我们只需要把第一步中建立的 veth_host 这个设备，接入到 docker0 这个 bridge 上。</p>
<pre><code class="hljs language-bash">ip link <span class="hljs-built_in">set</span> veth_host master docker0
</code></pre><p>要让子网通过宿主机上 eth0 去访问外网的话，加上iptables规则</p>
<pre><code class="hljs language-bash">iptables -P FORWARD ACCEPT
</code></pre><p>由于涉及到docker0到主机eth0之间的转发，所以需要配置ipv4运行转发的选项</p>
<pre><code class="hljs language-bash">echo <span class="hljs-number">1</span> &gt; <span class="hljs-regexp">/proc/</span>sys/net/ipv4/ip_forward
</code></pre><p>接下来就能ping通了</p>
<pre><code class="hljs language-bash">docker <span class="hljs-built_in">exec</span> -it net-test ip addr

docker <span class="hljs-built_in">exec</span> -it net-test ping www.baidu.com
</code></pre><p>清理操作</p>
<pre><code class="hljs language-bash">docker stop net-test &amp;&amp; docker rm net-test

rm /var/run/netns/$pid

<span class="hljs-comment"># ip link delete veth_host, 删除其中一端，另外一端同样会删除，上面直接删除容器，那么这宿主机上的也是会删除的</span>
</code></pre></div></div></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"\u003ch1\u003e容器到宿主\u003c/h1\u003e\n\u003cp\u003e对于容器从自己的 Network Namespace 连接到 Host Network Namespace 的方法，一般来说就只有两类设备接口：一类是veth，另外一类是 macvlan/ipvlan。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e使用centos是因为centos预装了iproute2，可以使用ip命令\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003edocker run -d --name net-test --network none centos:latest sleep \u003cspan class=\"hljs-number\"\u003e36000\u003c/span\u003e\n\ndocker \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e -it net-test ip addr\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e就在这个容器的 Network Namespace 里建立 veth\u003c/p\u003e\n\u003cp\u003e通过 \u0026quot;/proc/$pid/ns/net\u0026quot;这个文件得到 Network Namespace 的 ID，这个 Network Namespace ID 既是这个进程的，也同时属于这个容器。\u003c/p\u003e\n\u003cp\u003e在\u0026quot;/var/run/netns/\u0026quot;的目录下建立一个符号链接，指向这个容器的 Network Namespace。完成这步操作之后，在后面的\u0026quot;ip netns\u0026quot;操作里，就可以用 pid 的值作为这个容器的 Network Namesapce 的标识了。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003epid=$(ps -ef | grep \u003cspan class=\"hljs-string\"\u003e\u0026quot;sleep 36000\u0026quot;\u003c/span\u003e | grep -v grep | awk \u003cspan class=\"hljs-string\"\u003e\u0026#x27;{print $2}\u0026#x27;\u003c/span\u003e)\necho $pid\nln -s /proc/$pid/ns/net /\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e/run/netns/$pid\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e创建veth虚拟设备，并把其分别放在宿主和容器的命名空间\u003c/p\u003e\n\u003cp\u003eveth pair设备都有一个ifindex和iflink值，，容器中的eth0设备的ifindex值跟host network namespace中的对应veth pair设备的iflink值相等，反之亦然\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-comment\"\u003e# Create a pair of veth interfaces\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003eip\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003elink\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eadd\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ename\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eveth_host\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003etype\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eveth\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epeer\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ename\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eveth_container\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# Put one of them in the new net ns\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003eip\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003elink\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eset\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eveth_container\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003enetns\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$pid\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# 在次查看容器中的设备会发现已经加入了一个veth\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003e63:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eveth_container@if64:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026lt;BROADCAST,MULTICAST\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emtu\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1500 \u003c/span\u003e\u003cspan class=\"hljs-string\"\u003eqdisc\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003enoop\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003estate\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eDOWN\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egroup\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edefault\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eqlen\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003elink/ether\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e82\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:b9:bd:06:99:6b\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ebrd\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eff:ff:ff:ff:ff:ff\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003elink-netnsid\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e查看docker0所在的网段进行配置，例如\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e: \u003cspan class=\"hljs-attr\"\u003edocker0\u003c/span\u003e: \u0026lt;\u003cspan class=\"hljs-variable constant_\"\u003eNO\u003c/span\u003e-\u003cspan class=\"hljs-variable constant_\"\u003eCARRIER\u003c/span\u003e,\u003cspan class=\"hljs-variable constant_\"\u003eBROADCAST\u003c/span\u003e,\u003cspan class=\"hljs-variable constant_\"\u003eMULTICAST\u003c/span\u003e,\u003cspan class=\"hljs-variable constant_\"\u003eUP\u003c/span\u003e\u0026gt; mtu \u003cspan class=\"hljs-number\"\u003e1500\u003c/span\u003e qdisc noqueue state \u003cspan class=\"hljs-variable constant_\"\u003eDOWN\u003c/span\u003e group \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e\n    link/ether \u003cspan class=\"hljs-number\"\u003e02\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e42\u003c/span\u003e:\u003cspan class=\"hljs-attr\"\u003eab\u003c/span\u003e:\u003cspan class=\"hljs-attr\"\u003eee\u003c/span\u003e:1\u003cspan class=\"hljs-attr\"\u003ec\u003c/span\u003e:db brd \u003cspan class=\"hljs-attr\"\u003eff\u003c/span\u003e:\u003cspan class=\"hljs-attr\"\u003eff\u003c/span\u003e:\u003cspan class=\"hljs-attr\"\u003eff\u003c/span\u003e:\u003cspan class=\"hljs-attr\"\u003eff\u003c/span\u003e:\u003cspan class=\"hljs-attr\"\u003eff\u003c/span\u003e:ff\n    inet \u003cspan class=\"hljs-number\"\u003e172.17\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e brd \u003cspan class=\"hljs-number\"\u003e172.17\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.255\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.255\u003c/span\u003e scope \u003cspan class=\"hljs-variable language_\"\u003eglobal\u003c/span\u003e docker0\n       valid_lft forever preferred_lft forever\n\u003c/code\u003e\u003c/pre\u003e\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-comment\"\u003e# In the container, setup veth_container\u003c/span\u003e\nip netns \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e $pid ip link \u003cspan class=\"hljs-built_in\"\u003eset\u003c/span\u003e veth_container name eth0\nip netns \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e $pid ip addr add \u003cspan class=\"hljs-number\"\u003e172.17\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.2\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e dev eth0\nip netns \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e $pid ip link \u003cspan class=\"hljs-built_in\"\u003eset\u003c/span\u003e eth0 up\nip netns \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e $pid ip route add default via \u003cspan class=\"hljs-number\"\u003e172.17\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# In the host, set veth_host up\u003c/span\u003e\nip link \u003cspan class=\"hljs-built_in\"\u003eset\u003c/span\u003e veth_host up\n\u003c/code\u003e\u003c/pre\u003e\u003ch1\u003e宿主到eth0\u003c/h1\u003e\n\u003cp\u003e一个普通 Linux 节点上数据包转发的问题，可以用 nat 来做个转发，或者建立 Overlay 网络发送，也可以通过配置 proxy arp 加路由的方法来实现。\u003c/p\u003e\n\u003cp\u003eDocker 缺省使用的是 bridge + nat 的转发方式\u003c/p\u003e\n\u003cp\u003eDocker 程序在节点上安装完之后，就会自动建立了一个 docker0 的 bridge interface。所以我们只需要把第一步中建立的 veth_host 这个设备，接入到 docker0 这个 bridge 上。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eip link \u003cspan class=\"hljs-built_in\"\u003eset\u003c/span\u003e veth_host master docker0\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e要让子网通过宿主机上 eth0 去访问外网的话，加上iptables规则\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eiptables -P FORWARD ACCEPT\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e由于涉及到docker0到主机eth0之间的转发，所以需要配置ipv4运行转发的选项\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eecho \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u0026gt; \u003cspan class=\"hljs-regexp\"\u003e/proc/\u003c/span\u003esys/net/ipv4/ip_forward\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e接下来就能ping通了\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003edocker \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e -it net-test ip addr\n\ndocker \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e -it net-test ping www.baidu.com\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e清理操作\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003edocker stop net-test \u0026amp;\u0026amp; docker rm net-test\n\nrm /var/run/netns/$pid\n\n\u003cspan class=\"hljs-comment\"\u003e# ip link delete veth_host, 删除其中一端，另外一端同样会删除，上面直接删除容器，那么这宿主机上的也是会删除的\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e","frontMatter":{"readingTime":{"text":"5 min read","minutes":4.32,"time":259200,"words":864},"slug":"从none网络实践容器的网络配置","fileName":"从none网络实践容器的网络配置.md","title":"手动建立容器网络实践","date":"2022-10-31T00:00:00.000Z","tags":["实践"],"draft":false,"summary":"amespace-网络配置实践"}},"prev":{"title":"CPU限制实战","date":"2022-10-30T00:00:00.000Z","tags":["实践"],"draft":false,"summary":"cgroup-cpu限制实践","slug":"CPU限制实践"},"next":{"title":"overlay文件系统","date":"2022-11-01T00:00:00.000Z","tags":["实践"],"draft":false,"summary":"overlay文件系统实践，探索容器原理","slug":"overlay文件系统实验"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["从none网络实践容器的网络配置"]},"buildId":"qwylQn0rAYfx_DG8FLkaO","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>