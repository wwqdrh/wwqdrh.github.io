<!DOCTYPE html><html lang="zh-CN"><head><meta name="viewport" content="width=device-width"/><title>操作系统性能分析工具</title><meta name="robots" content="follow, index"/><meta charSet="UTF-8"/><meta name="description" content="操作系统性能分析工具"/><meta property="og:type"/><meta property="og:title" content="操作系统性能分析工具"/><meta property="og:description" content="操作系统性能分析工具"/><meta property="og:url" content="https://wwqdrh.github.io/undefined"/><meta name="keywords" content="wwqdrh技术博客"/><meta property="og:locale" content="zh-CN"/><meta property="og:image" content="https://wwqdrh.github.io"/><meta name="twitter:title" content="操作系统性能分析工具"/><meta name="twitter:description" content="操作系统性能分析工具"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="https://wwqdrh.github.io"/><link rel="stylesheet" href="/assets/mdrender/editor-render.css"/><meta name="next-head-count" content="17"/><link rel="icon" href="/favicon.ico"/><link rel="apple-touch-icon" sizes="192x192" href="/apple-touch-icon.png"/><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/feed"/><script src="/assets/analizy/clarity.js"></script><link rel="preload" href="/_next/static/media/d83e92f0af8b17e4-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/ed42d1b51efd45f6-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/fba9d678ff638e59-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/e52907b750a6f61e-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/9031250013752d4b-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/eb9adf802b0a60eb-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/81b352a4d7a000ae-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/41b9b3ece820718f-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/d587d1c112526568-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/css/869c7de7c781f904.css" as="style"/><link rel="stylesheet" href="/_next/static/css/869c7de7c781f904.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-fbe37f60a09a330b.js" defer=""></script><script src="/_next/static/chunks/main-082d90b1269d95f6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-494ee9c4b0594b31.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-222bf60d0a2bf3df.js" defer=""></script><script src="/_next/static/PMB5qMppIrri5HN2Gb314/_buildManifest.js" defer=""></script><script src="/_next/static/PMB5qMppIrri5HN2Gb314/_ssgManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css-global c86wz">body{margin:0;padding:0;color:hsl(0, 0%, 9.0%);background-color:hsl(0, 0%, 97.3%);font-family:'__pretendard_6bb8e5','__pretendard_Fallback_6bb8e5';}*{-webkit-print-color-scheme:light;color-scheme:light;box-sizing:border-box;}h1,h2,h3,h4,h5,h6{margin:0;font-weight:inherit;font-style:inherit;}a{all:unset;cursor:pointer;}ul{padding:0;}button{all:unset;cursor:pointer;}input{all:unset;box-sizing:border-box;}textarea{border:none;background-color:transparent;font-family:inherit;padding:0;outline:none;resize:none;color:inherit;}hr{width:100%;border:none;margin:0;border-top:1px solid hsl(0, 0%, 88.7%);}</style><style data-emotion="css 1q70a33">.css-1q70a33{z-index:30;position:-webkit-sticky;position:sticky;top:0;background-color:hsl(0, 0%, 97.3%);box-shadow:0 1px 2px 0 rgba(0, 0, 0, 0.05);}.css-1q70a33 .container{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:100%;height:3rem;margin:0 auto;}@media (min-width: 768px){.css-1q70a33 .container[data-full-width="true"]{padding-left:6rem;padding-right:6rem;}}.css-1q70a33 .container .nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;gap:0.75rem;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-1q70a33 .container .mid{padding-top:0.5rem;padding-bottom:0.5rem;padding-left:1.25rem;padding-right:1.25rem;border-radius:1rem;outline-style:none;width:50%;background-color:hsl(0, 0%, 93.0%);}</style><div class="py-2 css-1q70a33"><div data-full-width="false" class="container"><a aria-label="wwqdrh" class="css-0" href="/">wwqdrh</a><input class="mid" type="text" placeholder="Search Keyword..." value=""/><div class="nav"><style data-emotion="css 1nw6zn9">.css-1nw6zn9{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}.css-1nw6zn9 ul{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}.css-1nw6zn9 ul li{display:block;margin-left:1rem;color:hsl(0, 0%, 43.5%);}</style><div class="css-1nw6zn9"><ul><li><a target="_blank" href="https://space.bilibili.com/538676331">B站</a></li></ul></div><style data-emotion="css 1h5x3dy">.css-1h5x3dy{cursor:pointer;}</style><div class="css-1h5x3dy"><style data-emotion="css p95608">.css-p95608{font-family:'__Noto_Color_Emoji_be1378','__Noto_Color_Emoji_Fallback_be1378',Apple Color Emoji;font-weight:400;font-style:normal;}</style><span class="css-p95608">☀️</span></div></div></div></div><style data-emotion="css lomkhl">.css-lomkhl{margin:0 auto;width:100%;padding:0 3rem;}</style><main class="css-lomkhl"><div class="divide-y bg-white dark:bg-gray-700 p-6 shadow-lg rounded-lg mt-3 divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="max-w-none pt-10 pb-8 prose dark:prose-dark"><div><h1>性能分析</h1>
<blockquote>
<p>下面的所有测试都是在ubuntu:22的docker镜像环境下测试的
使用系统自带的工具，对于需要三方安装的工具集会标注出来</p>
</blockquote>
<h2>CPU</h2>
<ul>
<li>CPU使用率<ul>
<li>用户CPU</li>
<li>系统CPU</li>
<li>IOWAIT</li>
<li>软中断</li>
<li>硬中断</li>
<li>窃取CPU</li>
<li>客户CPU</li>
</ul>
</li>
<li>上下文切换<ul>
<li>自愿上下文切换</li>
<li>非自愿上下文切换</li>
</ul>
</li>
<li>平均负载</li>
<li>CPU缓存命中率</li>
</ul>
<blockquote>
<p>systat(<code>apt update &amp;&amp; apt install sysstat</code>): 包含的命令包括iostat、mpstat、pidstat、sar、sadc、sa1、sa2、sadf、nfsiostat、cifsiostat</p>
</blockquote>
<img src="/images/blogs/CPU工具.png" />

<ul>
<li>平均负载: 指系统处于可运行状态和不可中断状态的平均进程数, 数值高CPU使用率不一定高，有可能是由于IO导致</li>
<li>上下文切换: 无法获取资源的自愿切换和系统强制调度时的非自愿切换。过多的切换会导致CPU时间过多消耗在寄存器、内核以及虚拟内存等数据保存和恢复上</li>
<li>CPU使用率: 分为用户、系统、iowait(等待io的cpu使用率)、软/硬中断CPU使用率、steal cpu/ guest cpu(虚拟机占用)</li>
<li>CPU缓存命中率: CPU缓存的复用情况,命中率越高性能越好. 其中L1/L2常用在单核,L3则用在多核中。</li>
<li>对于僵尸问题，用pstree找到父进程，然后看源码检查子进程结束的处理逻辑</li>
<li>软中断线程CPU使用率高的情况下, 可以借助sar和tcpdump等工具分析来源</li>
</ul>
<img src="/images/blogs/CPU工具2.png" />

<h2>优化思路</h2>
<blockquote>
<p>先运行几个支持指标较多的工具, 如top/vmstat/pidstat,根据它们的输出可以得出是哪种类型的性能问题. 定位到进程后再用strace/perf分析调用情况进一步分析. 如果是软中断导致用/proc/softirqs</p>
</blockquote>
<p>1、使用top命令分析系统的整体运行情况</p>
<pre><code class="hljs language-bash"><span class="hljs-string">top</span> <span class="hljs-bullet">-</span> <span class="hljs-number">09</span><span class="hljs-string">:44:56</span> <span class="hljs-string">up</span> <span class="hljs-number">16</span> <span class="hljs-string">days,</span> <span class="hljs-number">21</span><span class="hljs-string">:23,</span>  <span class="hljs-number">1</span> <span class="hljs-string">user,</span>  <span class="hljs-attr">load average:</span> <span class="hljs-number">9.59</span><span class="hljs-string">,</span> <span class="hljs-number">4.75</span><span class="hljs-string">,</span> <span class="hljs-number">1.92</span>
<span class="hljs-attr">Tasks:</span> <span class="hljs-number">145</span> <span class="hljs-string">total,</span>   <span class="hljs-number">2</span> <span class="hljs-string">running,</span> <span class="hljs-number">143</span> <span class="hljs-string">sleeping,</span>   <span class="hljs-number">0</span> <span class="hljs-string">stopped,</span>   <span class="hljs-number">0</span> <span class="hljs-string">zombie</span>
<span class="hljs-string">Cpu(s):</span> <span class="hljs-number">99.8</span><span class="hljs-string">%us,</span>  <span class="hljs-number">0.1</span><span class="hljs-string">%sy,</span>  <span class="hljs-number">0.0</span><span class="hljs-string">%ni,</span>  <span class="hljs-number">0.2</span><span class="hljs-string">%id,</span>  <span class="hljs-number">0.0</span><span class="hljs-string">%wa,</span>  <span class="hljs-number">0.0</span><span class="hljs-string">%hi,</span>  <span class="hljs-number">0.0</span><span class="hljs-string">%si,</span>  <span class="hljs-number">0.0</span><span class="hljs-string">%st</span>
<span class="hljs-attr">Mem:</span>   <span class="hljs-string">4147888k</span> <span class="hljs-string">total,</span>  <span class="hljs-string">2493092k</span> <span class="hljs-string">used,</span>  <span class="hljs-string">1654796k</span> <span class="hljs-string">free,</span>   <span class="hljs-string">158188k</span> <span class="hljs-string">buffers</span>
<span class="hljs-attr">Swap:</span>  <span class="hljs-string">5144568k</span> <span class="hljs-string">total,</span>       <span class="hljs-string">56k</span> <span class="hljs-string">used,</span>  <span class="hljs-string">5144512k</span> <span class="hljs-string">free,</span>  <span class="hljs-string">2013180k</span> <span class="hljs-string">cached</span>
</code></pre><p>上面的执行情况的含义</p>
<ul>
<li>当前时间为<code>9:44:56</code>, 系统运行了16天，有一个用户当前登录</li>
<li>系统负载情况<code>9.59 4.75 1.92</code>（系统在过去 1 分钟内，5 分钟内，15 分钟内的平均负载, 在这段时间内总的进程数与处理的进程数之间的比例）</li>
<li>总进程数145,2个正在运行，143个正在休眠，0个暂停，0个僵死进程</li>
<li>cpu使用率<ul>
<li>us (user): 非 nice 用户进程占用 CPU 的比率</li>
<li>sy (system): 内核、内核进程占用 CPU 的比率</li>
<li>ni (nice): 用户进程空间内改变过优先级的进程占用 CPU 比率</li>
<li>id (idle): CPU 空闲比率，如果系统缓慢而这个值很高，说明系统慢的原因不是 CPU 负载高</li>
<li>wa (iowait): CPU 等待执行 I/O 操作的时间比率，该指标可以用来排查磁盘 I/O 的问题，通常结合 wa 和 id 判断(如果内存充足，但 wa 很高，说明需要检查哪个进程占用了大量的 I/O 资源。如果内存不够就是发生了内存交换导致的)</li>
<li>hi (Hardware IRQ): CPU 处理硬件中断所占时间的比率</li>
<li>si (Software Interrupts): CPU 处理软件中断所占时间的比率</li>
<li>st (steal): 流逝的时间，虚拟机中的其他任务所占 CPU 时间的比率</li>
</ul>
</li>
<li>物理内存总量<code>4147888k</code>, 正在使用<code>2493092k</code>,空闲<code>1654796k</code>, 内核缓存<code>158188k</code></li>
<li>交换区总量<code>5144568k</code>, 正在使用<code>56k</code>, 空闲<code>5144512k</code>,缓冲区的交换总量<code>2013180k</code></li>
</ul>
<p>根据这个运行结果判断具体的瓶颈在那再继续分析</p>
<p>2、使用vmstat查看系统的上下文切换状态</p>
<ul>
<li>进程上下文切换</li>
<li>线程上下文切换</li>
<li>中断上下文切换</li>
</ul>
<p>当每秒上下文切换超过1w次，或者切换次数出现数量级的增长时，系统可能出现了性能问题。此时可以根据上下文切换类型来具体分析是I/O问题还是CPU瓶颈，或者具体哪一类中断导致的异常</p>
<p>3、使用pidstat查看是哪个进程状态导致出现问题</p>
<blockquote>
<p>需要安装systat</p>
</blockquote>
<p>可以查看哪个进程占用了大量的cpu或者io</p>
<pre><code class="hljs language-shell">pidstat -u 5 1
</code></pre><p>4、使用perf查看具体进程的执行情况</p>
<p>5、使用pstree查看进程的层级状态</p>
<h2>网络</h2>
<ul>
<li>应用层<ul>
<li>QPS</li>
<li>套接字缓冲区大小</li>
<li>DNS解析延迟</li>
<li>响应时间</li>
<li>错误数</li>
</ul>
</li>
<li>传输层<ul>
<li>TCP连接数: 全连接、半连接、TIMEWAIT</li>
<li>连接跟踪数</li>
<li>重传数</li>
<li>丢包数</li>
<li>延迟</li>
</ul>
</li>
<li>网络层<ul>
<li>丢包数</li>
<li>TTL</li>
<li>拆包</li>
</ul>
</li>
<li>链路层<ul>
<li>PPS每秒网络帧数</li>
<li>BPS每秒字节数</li>
<li>丢包数</li>
<li>错误数</li>
</ul>
</li>
</ul>
<p>比较常用的指标包括</p>
<ul>
<li>带宽: 最大传输速率 B/s</li>
<li>吞吐量: 用来评估单位时间内成功传输的数据量</li>
<li>网络使用率：吞吐量/带宽</li>
<li>PPS：Packet Per Second（包/秒）,一般用在交换机上，评估数据包的转发能力</li>
<li>延时：表示从网络中发出请求后，到远端响应的延迟时间</li>
</ul>
<img src="/images/blogs/网络分析工具.png" />

<h2>优化思路</h2>
<p>网络性能优化首先要获得网络基准测试报告，然后通过相关性能工具，定位出网络性能瓶颈，再进行优化。可以从应用程序、套接字、传输层、网络层以及链路层分别来看</p>
<p>应用层: 通过优化io模型、dns缓存、数据序列化方式等入手</p>
<p>套接字: 调整每个套接字的缓冲区</p>
<p>传输层: 优化TCP的TIME_WAIT状态，减少net.ipv4.tcp_fin_timeout让尽快让出资源，端口复用net.ipv4.tcp_tw_reuse。对于SYNC FLOOD问题，可以增大TCP半连接的最大数量，或者开启TCP SYN Cookies来绕开半开连接数量限制，或者减少SYN_RECV的重传SYN+ACK次数</p>
<p><code>ulimit -n</code>能够查看当前最大的文件句柄限制</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># 参考: https://blog.csdn.net/whatday/article/details/113427085</span>

<span class="hljs-comment"># /etc/sysctl.d</span>
vim /etc/sysctl.conf

net.ipv4.tcp_tw_reuse = <span class="hljs-number">1</span>  
net.ipv4.tcp_tw_recycle = <span class="hljs-number">1</span>(客户端最好不要设置这个)

<span class="hljs-comment"># 或者</span>
sysctl net.ipv4.tcp_tw_reuse=<span class="hljs-number">1</span>

<span class="hljs-comment"># 查看内核配置</span>
sysctl -a | fgrep tcp
</code></pre><p>在container中修改需要额外注意，如果docker container不是以 –net=”host” 方式启动的，那么它将有自己独立的网络堆栈。修改host的配置将会无效。在container中又无法直接修改/proc，因为docker会以只读的方式重新挂载/proc/sys。 对于这个问题，可以在container启动的时候将/proc挂载到另一可读写位置，譬如</p>
<p><code>docker run -ti -v /proc:/writable-proc ubuntu:14.04 /bin/bash</code></p>
<p>或者</p>
<p><code>docker service update --sysctl-add net.ipv4.tcp_tw_reuse=1 exporterdev</code></p>
<h2>磁盘</h2>
<p>文件系统</p>
<ul>
<li>存储空间容量、使用空间及剩余空间</li>
<li>索引节点容量、使用量及剩余量</li>
<li>缓存<ul>
<li>页缓存</li>
<li>目录项缓存</li>
<li>索引节点缓存</li>
<li>具体文件系统缓存(例如ext4的缓存)</li>
</ul>
</li>
<li>IOPS文件IO每秒io次数</li>
<li>响应时间</li>
<li>吞吐量</li>
</ul>
<p>磁盘</p>
<ul>
<li>使用率</li>
<li>IOPS</li>
<li>吞吐量</li>
<li>响应时间</li>
<li>缓冲区</li>
<li>读写类型(顺序读、随机读)、读写比例、读写大小、存储类型(RAID阵列、本地还是网络)</li>
</ul>
<h2>性能指标</h2>
<p>IOPS是指单位时间内系统能处理的I/O请求数量，I/O请求通常为读或写数据操作请求。随机读写频繁的应用，如OLTP(Online Transaction Processing)，IOPS是关键衡量指标。</p>
<p>数据吞吐量(Throughput)，指单位时间内可以成功传输的数据数量。对于大量顺序读写的应用，如VOD(Video On Demand)，则更关注吞吐量指标。</p>
<blockquote>
<p>每秒 I/O 吞吐量＝ IOPS* 平均 I/O SIZE</p>
</blockquote>
<p>对于随机负载，当遇到余下情况时，我们那通常认为存在 I/O 性能问题：</p>
<ol>
<li>平均读时间大于 15ms
2. 在具有写 cache 的条件下，平均写时间大于 2.5ms</li>
</ol>
<p>对于顺序负载，当遇到余下情况时，我们那通常认为存在 I/O 性能问题：</p>
<ol>
<li>在一个磁盘上有两个连续的 I/O 流</li>
<li>吞吐量不足（即远远小于磁盘 I/O 带宽）</li>
</ol>
<h2>分析工具</h2>
<img src="/images/blogs/io分析工具.png" />

<ul>
<li>先用iostat发现磁盘IO性能瓶颈</li>
<li>再借助pidstat和vmstat定位出导致瓶颈的进程</li>
<li>随后分析进程的IO行为</li>
<li>最后结合应用程序的原理，分析这些IO的来源</li>
</ul>
<h2>内存</h2>
<ul>
<li>系统内存指标<ul>
<li>已用内存</li>
<li>剩余内存</li>
<li>可用内存</li>
<li>缺页异常: 主缺页异常、次缺页异常</li>
<li>缓存区: 使用量、命中率</li>
<li>slabs</li>
</ul>
</li>
<li>进程内存指标<ul>
<li>VSS虚拟内存</li>
<li>RSS常驻内存</li>
<li>PSS按比例分配共享内存后的物理内存</li>
<li>USS独占内存</li>
<li>共享内存</li>
<li>SWAP内存</li>
<li>缺页异常: 主缺页异常、次缺页异常</li>
</ul>
</li>
<li>SWAP<ul>
<li>已用空间</li>
<li>剩余空间</li>
<li>换入速度</li>
<li>换出速度</li>
</ul>
</li>
</ul>
<p>基础性能指标包括，物理内存(RES)、交换区(SWAP)、虚拟内存(VIRT)</p>
<p>• VIRT 进程的虚拟内存大小
• RES 常驻内存的大小，即进程实际使用的物理内存大小，不包括swap和共享内存
• SHR 共享内存大小，与其他进程共享的内存，加载的动态链接库以及程序代码段
• %MEM 进程使用物理内存占系统总内存的百分比</p>
<blockquote>
<p>虚拟内存 = 物理内存 + 交换区</p>
</blockquote>
<p>可以使用top查看各个进程大致的内存使用情况</p>
<blockquote>
<p>执行<strong>top</strong>命令后，通常不会显示<strong>SWAP</strong>列, 需要进入点击f进入列编辑模式，然后按p，这时swap被选中，然后按回车键就可以了</p>
</blockquote>
<p>除了上面这个与进程使用强相关的，还有系统整体的分析指标</p>
<p>totoal(物理内存总大小)、used(已经使用的物理内存大小)、free(空闲的物理内存)、shared(多个进程共享内存的大小)、buffers/cached(作为缓存的内存大小，buffer用来缓存磁盘文件的元数据例如文件属性、目录结构等，cache缓存的是真正的文件内容)、swap(交换空间的使用状态)</p>
<h2>常见问题</h2>
<p>1、空闲空间少不一定是内存不够，linux会尽量提高内存使用率，经常会把磁盘上的内容缓存到内存，用来加速，当内存不足时，linux就会释放缓存部分，让给真正需要的程序使用</p>
<p>2、内存真正存在问题的情形是: 持续的内存换入换出、较多的主缺页中断</p>
<p>可以通过sar工具查看到<code>sar -B 1 3</code></p>
<blockquote>
<p>主缺页中断(majflt): 内存中找不到，需要到磁盘中找
次缺页中断(fault): 在内存中可以找到目标页</p>
</blockquote>
<p>内存的换入换出(pgpgin/pgpgout)</p>
<img src="/images/blogs/sar示例.png" />

<p>vmstat可以查看空闲的物理内存、缓存、以及换入换出之类的</p>
<h2>常用工具</h2>
<img src="/images/blogs/内存分析工具.png" />

<h1>命令概览</h1>
<h2>top</h2>
<p>可以查看进程状态(正在运行、睡眠、停止的)，用户空间占比，内存使用情况(物理内存总量、交换区总量等)</p>
<p>第一行是任务队列信息：当前时间、系统运行时间、当前登录用户数，系统负载(任务队列的平均长度)</p>
<ul>
<li>2500 毫秒刷新一次 TOP 内容，总共 5 次，输出内容存放到 performace.txt 文件中: <code>top -b -d 2.5 -n 5 &gt; performace.txt</code></li>
<li>TOP 默认排序为倒序，如果确实需要升序排序，可以使用大写字母按键：R</li>
</ul>
<h2>vmstat</h2>
<p>可以用于查看进程(运行队列中进程数量，等待IO的进程数量)、内存、IO等系统的整体运行状态</p>
<p>si、so为交换区与内存之间的换入换出，如果长期大于0说明经常发生内存交换，硬盘io和CPU都会消耗，这个时候需要扩大内存</p>
<p>in: 每秒中断数包括时钟中断，cs: 每秒上下文切换数。这两个数值越大，内核消耗的CPU时间越大</p>
<p>wa高说明IO等待比较严重，这可能是由于磁盘大量作随机访问造成，也有可能磁盘出现瓶颈(块操作)</p>
<p>us: 用户进程执行时间百分比(user time)。us的值比较高时，说明用户进程消耗的CPU时间多，但是如果长期超50%的使用，那么我们就该考虑优化程序算法或者进行加速。</p>
<p>sy: 内核系统进程执行时间百分比。sy的值高时，说明系统内核消耗的CPU资源多，这并不是良性表现，我们应该检查原因。</p>
<pre><code class="hljs language-shell"><span class="hljs-string">vmstat</span> <span class="hljs-number">3</span>
<span class="hljs-string">procs</span> <span class="hljs-string">-----------memory----------</span> <span class="hljs-string">---swap--</span> <span class="hljs-string">-----io----</span> <span class="hljs-string">--system--</span> <span class="hljs-string">-----cpu------</span>
 <span class="hljs-string">r</span>  <span class="hljs-string">b</span>   <span class="hljs-string">swpd</span>   <span class="hljs-string">free</span>   <span class="hljs-string">buff</span>  <span class="hljs-string">cache</span>   <span class="hljs-string">si</span>   <span class="hljs-string">so</span>    <span class="hljs-string">bi</span>    <span class="hljs-string">bo</span>   <span class="hljs-string">in</span>   <span class="hljs-string">cs</span> <span class="hljs-string">us</span> <span class="hljs-string">sy</span> <span class="hljs-string">id</span> <span class="hljs-string">wa</span> <span class="hljs-string">st</span>
 <span class="hljs-number">0</span>  <span class="hljs-number">0</span>    <span class="hljs-number">320</span>  <span class="hljs-number">42188</span> <span class="hljs-number">167332</span> <span class="hljs-number">1534368</span>    <span class="hljs-number">0</span>    <span class="hljs-number">0</span>     <span class="hljs-number">4</span>     <span class="hljs-number">7</span>    <span class="hljs-number">1</span>    <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span> <span class="hljs-number">99</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>
 <span class="hljs-number">0</span>  <span class="hljs-number">0</span>    <span class="hljs-number">320</span>  <span class="hljs-number">42188</span> <span class="hljs-number">167332</span> <span class="hljs-number">1534392</span>    <span class="hljs-number">0</span>    <span class="hljs-number">0</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span> <span class="hljs-number">1002   </span><span class="hljs-number">39</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span> <span class="hljs-number">100</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>
 <span class="hljs-number">0</span>  <span class="hljs-number">0</span>    <span class="hljs-number">320</span>  <span class="hljs-number">42188</span> <span class="hljs-number">167336</span> <span class="hljs-number">1534392</span>    <span class="hljs-number">0</span>    <span class="hljs-number">0</span>     <span class="hljs-number">0</span>    <span class="hljs-number">19</span> <span class="hljs-number">1002   </span><span class="hljs-number">44</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span> <span class="hljs-number">100</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>
 <span class="hljs-number">0</span>  <span class="hljs-number">0</span>    <span class="hljs-number">320</span>  <span class="hljs-number">42188</span> <span class="hljs-number">167336</span> <span class="hljs-number">1534392</span>    <span class="hljs-number">0</span>    <span class="hljs-number">0</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span> <span class="hljs-number">1002   </span><span class="hljs-number">41</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span> <span class="hljs-number">100</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>
 <span class="hljs-number">0</span>  <span class="hljs-number">0</span>    <span class="hljs-number">320</span>  <span class="hljs-number">42188</span> <span class="hljs-number">167336</span> <span class="hljs-number">1534392</span>    <span class="hljs-number">0</span>    <span class="hljs-number">0</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span> <span class="hljs-number">1002   </span><span class="hljs-number">41</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span> <span class="hljs-number">100</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>
</code></pre><h2>pidstat</h2>
<ul>
<li>-u：默认的参数，显示各个进程的cpu使用统计</li>
<li>-r：显示各个进程的内存使用统计</li>
<li>-d：显示各个进程的IO使用情况</li>
<li>-p：指定进程号</li>
<li>-w：显示每个进程的上下文切换情况</li>
<li>-t：显示选择任务的线程的统计信息外的额外信息</li>
</ul>
<p><code>pidstat -u 5 1</code>： 查看哪个进程占用了大量的CPU或者io</p>
<p><code>pidstat -u -p ALL</code>: 查看所有进程的CPU使用情况</p>
<p><code>pidstat -r -p [pid] [时间间隔] [收集次数]</code></p>
<h2>lsof</h2>
<p>lsof中<code>-P</code>是禁止将端口转成别名(例如<code>8000 -&gt; irdmi</code>, <code>8001 -&gt; vcom-tunnel</code>)</p>
<p>1、通过端口获取pid: <code>lsof -i:[端口] -P -t</code></p>
<p>2、通过pid获取端口占用情况<code>lsof -i -P | grep [pid]</code></p>
</div></div></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"\u003ch1\u003e性能分析\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003e下面的所有测试都是在ubuntu:22的docker镜像环境下测试的\n使用系统自带的工具，对于需要三方安装的工具集会标注出来\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2\u003eCPU\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eCPU使用率\u003cul\u003e\n\u003cli\u003e用户CPU\u003c/li\u003e\n\u003cli\u003e系统CPU\u003c/li\u003e\n\u003cli\u003eIOWAIT\u003c/li\u003e\n\u003cli\u003e软中断\u003c/li\u003e\n\u003cli\u003e硬中断\u003c/li\u003e\n\u003cli\u003e窃取CPU\u003c/li\u003e\n\u003cli\u003e客户CPU\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e上下文切换\u003cul\u003e\n\u003cli\u003e自愿上下文切换\u003c/li\u003e\n\u003cli\u003e非自愿上下文切换\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e平均负载\u003c/li\u003e\n\u003cli\u003eCPU缓存命中率\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003esystat(\u003ccode\u003eapt update \u0026amp;\u0026amp; apt install sysstat\u003c/code\u003e): 包含的命令包括iostat、mpstat、pidstat、sar、sadc、sa1、sa2、sadf、nfsiostat、cifsiostat\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cimg src=\"/images/blogs/CPU工具.png\" /\u003e\n\n\u003cul\u003e\n\u003cli\u003e平均负载: 指系统处于可运行状态和不可中断状态的平均进程数, 数值高CPU使用率不一定高，有可能是由于IO导致\u003c/li\u003e\n\u003cli\u003e上下文切换: 无法获取资源的自愿切换和系统强制调度时的非自愿切换。过多的切换会导致CPU时间过多消耗在寄存器、内核以及虚拟内存等数据保存和恢复上\u003c/li\u003e\n\u003cli\u003eCPU使用率: 分为用户、系统、iowait(等待io的cpu使用率)、软/硬中断CPU使用率、steal cpu/ guest cpu(虚拟机占用)\u003c/li\u003e\n\u003cli\u003eCPU缓存命中率: CPU缓存的复用情况,命中率越高性能越好. 其中L1/L2常用在单核,L3则用在多核中。\u003c/li\u003e\n\u003cli\u003e对于僵尸问题，用pstree找到父进程，然后看源码检查子进程结束的处理逻辑\u003c/li\u003e\n\u003cli\u003e软中断线程CPU使用率高的情况下, 可以借助sar和tcpdump等工具分析来源\u003c/li\u003e\n\u003c/ul\u003e\n\u003cimg src=\"/images/blogs/CPU工具2.png\" /\u003e\n\n\u003ch2\u003e优化思路\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003e先运行几个支持指标较多的工具, 如top/vmstat/pidstat,根据它们的输出可以得出是哪种类型的性能问题. 定位到进程后再用strace/perf分析调用情况进一步分析. 如果是软中断导致用/proc/softirqs\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e1、使用top命令分析系统的整体运行情况\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-string\"\u003etop\u003c/span\u003e \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e09\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:44:56\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eup\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edays,\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e21\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:23,\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003euser,\u003c/span\u003e  \u003cspan class=\"hljs-attr\"\u003eload average:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e9.59\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e,\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e4.75\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e,\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1.92\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eTasks:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e145\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003etotal,\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003erunning,\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e143\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esleeping,\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003estopped,\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ezombie\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003eCpu(s):\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e99.8\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e%us,\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0.1\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e%sy,\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0.0\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e%ni,\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0.2\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e%id,\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0.0\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e%wa,\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0.0\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e%hi,\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0.0\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e%si,\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0.0\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e%st\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eMem:\u003c/span\u003e   \u003cspan class=\"hljs-string\"\u003e4147888k\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003etotal,\u003c/span\u003e  \u003cspan class=\"hljs-string\"\u003e2493092k\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eused,\u003c/span\u003e  \u003cspan class=\"hljs-string\"\u003e1654796k\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efree,\u003c/span\u003e   \u003cspan class=\"hljs-string\"\u003e158188k\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ebuffers\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eSwap:\u003c/span\u003e  \u003cspan class=\"hljs-string\"\u003e5144568k\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003etotal,\u003c/span\u003e       \u003cspan class=\"hljs-string\"\u003e56k\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eused,\u003c/span\u003e  \u003cspan class=\"hljs-string\"\u003e5144512k\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003efree,\u003c/span\u003e  \u003cspan class=\"hljs-string\"\u003e2013180k\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecached\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e上面的执行情况的含义\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e当前时间为\u003ccode\u003e9:44:56\u003c/code\u003e, 系统运行了16天，有一个用户当前登录\u003c/li\u003e\n\u003cli\u003e系统负载情况\u003ccode\u003e9.59 4.75 1.92\u003c/code\u003e（系统在过去 1 分钟内，5 分钟内，15 分钟内的平均负载, 在这段时间内总的进程数与处理的进程数之间的比例）\u003c/li\u003e\n\u003cli\u003e总进程数145,2个正在运行，143个正在休眠，0个暂停，0个僵死进程\u003c/li\u003e\n\u003cli\u003ecpu使用率\u003cul\u003e\n\u003cli\u003eus (user): 非 nice 用户进程占用 CPU 的比率\u003c/li\u003e\n\u003cli\u003esy (system): 内核、内核进程占用 CPU 的比率\u003c/li\u003e\n\u003cli\u003eni (nice): 用户进程空间内改变过优先级的进程占用 CPU 比率\u003c/li\u003e\n\u003cli\u003eid (idle): CPU 空闲比率，如果系统缓慢而这个值很高，说明系统慢的原因不是 CPU 负载高\u003c/li\u003e\n\u003cli\u003ewa (iowait): CPU 等待执行 I/O 操作的时间比率，该指标可以用来排查磁盘 I/O 的问题，通常结合 wa 和 id 判断(如果内存充足，但 wa 很高，说明需要检查哪个进程占用了大量的 I/O 资源。如果内存不够就是发生了内存交换导致的)\u003c/li\u003e\n\u003cli\u003ehi (Hardware IRQ): CPU 处理硬件中断所占时间的比率\u003c/li\u003e\n\u003cli\u003esi (Software Interrupts): CPU 处理软件中断所占时间的比率\u003c/li\u003e\n\u003cli\u003est (steal): 流逝的时间，虚拟机中的其他任务所占 CPU 时间的比率\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e物理内存总量\u003ccode\u003e4147888k\u003c/code\u003e, 正在使用\u003ccode\u003e2493092k\u003c/code\u003e,空闲\u003ccode\u003e1654796k\u003c/code\u003e, 内核缓存\u003ccode\u003e158188k\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e交换区总量\u003ccode\u003e5144568k\u003c/code\u003e, 正在使用\u003ccode\u003e56k\u003c/code\u003e, 空闲\u003ccode\u003e5144512k\u003c/code\u003e,缓冲区的交换总量\u003ccode\u003e2013180k\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e根据这个运行结果判断具体的瓶颈在那再继续分析\u003c/p\u003e\n\u003cp\u003e2、使用vmstat查看系统的上下文切换状态\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e进程上下文切换\u003c/li\u003e\n\u003cli\u003e线程上下文切换\u003c/li\u003e\n\u003cli\u003e中断上下文切换\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e当每秒上下文切换超过1w次，或者切换次数出现数量级的增长时，系统可能出现了性能问题。此时可以根据上下文切换类型来具体分析是I/O问题还是CPU瓶颈，或者具体哪一类中断导致的异常\u003c/p\u003e\n\u003cp\u003e3、使用pidstat查看是哪个进程状态导致出现问题\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e需要安装systat\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e可以查看哪个进程占用了大量的cpu或者io\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003epidstat -u 5 1\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e4、使用perf查看具体进程的执行情况\u003c/p\u003e\n\u003cp\u003e5、使用pstree查看进程的层级状态\u003c/p\u003e\n\u003ch2\u003e网络\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e应用层\u003cul\u003e\n\u003cli\u003eQPS\u003c/li\u003e\n\u003cli\u003e套接字缓冲区大小\u003c/li\u003e\n\u003cli\u003eDNS解析延迟\u003c/li\u003e\n\u003cli\u003e响应时间\u003c/li\u003e\n\u003cli\u003e错误数\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e传输层\u003cul\u003e\n\u003cli\u003eTCP连接数: 全连接、半连接、TIMEWAIT\u003c/li\u003e\n\u003cli\u003e连接跟踪数\u003c/li\u003e\n\u003cli\u003e重传数\u003c/li\u003e\n\u003cli\u003e丢包数\u003c/li\u003e\n\u003cli\u003e延迟\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e网络层\u003cul\u003e\n\u003cli\u003e丢包数\u003c/li\u003e\n\u003cli\u003eTTL\u003c/li\u003e\n\u003cli\u003e拆包\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e链路层\u003cul\u003e\n\u003cli\u003ePPS每秒网络帧数\u003c/li\u003e\n\u003cli\u003eBPS每秒字节数\u003c/li\u003e\n\u003cli\u003e丢包数\u003c/li\u003e\n\u003cli\u003e错误数\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e比较常用的指标包括\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e带宽: 最大传输速率 B/s\u003c/li\u003e\n\u003cli\u003e吞吐量: 用来评估单位时间内成功传输的数据量\u003c/li\u003e\n\u003cli\u003e网络使用率：吞吐量/带宽\u003c/li\u003e\n\u003cli\u003ePPS：Packet Per Second（包/秒）,一般用在交换机上，评估数据包的转发能力\u003c/li\u003e\n\u003cli\u003e延时：表示从网络中发出请求后，到远端响应的延迟时间\u003c/li\u003e\n\u003c/ul\u003e\n\u003cimg src=\"/images/blogs/网络分析工具.png\" /\u003e\n\n\u003ch2\u003e优化思路\u003c/h2\u003e\n\u003cp\u003e网络性能优化首先要获得网络基准测试报告，然后通过相关性能工具，定位出网络性能瓶颈，再进行优化。可以从应用程序、套接字、传输层、网络层以及链路层分别来看\u003c/p\u003e\n\u003cp\u003e应用层: 通过优化io模型、dns缓存、数据序列化方式等入手\u003c/p\u003e\n\u003cp\u003e套接字: 调整每个套接字的缓冲区\u003c/p\u003e\n\u003cp\u003e传输层: 优化TCP的TIME_WAIT状态，减少net.ipv4.tcp_fin_timeout让尽快让出资源，端口复用net.ipv4.tcp_tw_reuse。对于SYNC FLOOD问题，可以增大TCP半连接的最大数量，或者开启TCP SYN Cookies来绕开半开连接数量限制，或者减少SYN_RECV的重传SYN+ACK次数\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eulimit -n\u003c/code\u003e能够查看当前最大的文件句柄限制\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-comment\"\u003e# 参考: https://blog.csdn.net/whatday/article/details/113427085\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# /etc/sysctl.d\u003c/span\u003e\nvim /etc/sysctl.conf\n\nnet.ipv4.tcp_tw_reuse = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e  \nnet.ipv4.tcp_tw_recycle = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e(客户端最好不要设置这个)\n\n\u003cspan class=\"hljs-comment\"\u003e# 或者\u003c/span\u003e\nsysctl net.ipv4.tcp_tw_reuse=\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# 查看内核配置\u003c/span\u003e\nsysctl -a | fgrep tcp\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e在container中修改需要额外注意，如果docker container不是以 –net=”host” 方式启动的，那么它将有自己独立的网络堆栈。修改host的配置将会无效。在container中又无法直接修改/proc，因为docker会以只读的方式重新挂载/proc/sys。 对于这个问题，可以在container启动的时候将/proc挂载到另一可读写位置，譬如\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003edocker run -ti -v /proc:/writable-proc ubuntu:14.04 /bin/bash\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e或者\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003edocker service update --sysctl-add net.ipv4.tcp_tw_reuse=1 exporterdev\u003c/code\u003e\u003c/p\u003e\n\u003ch2\u003e磁盘\u003c/h2\u003e\n\u003cp\u003e文件系统\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e存储空间容量、使用空间及剩余空间\u003c/li\u003e\n\u003cli\u003e索引节点容量、使用量及剩余量\u003c/li\u003e\n\u003cli\u003e缓存\u003cul\u003e\n\u003cli\u003e页缓存\u003c/li\u003e\n\u003cli\u003e目录项缓存\u003c/li\u003e\n\u003cli\u003e索引节点缓存\u003c/li\u003e\n\u003cli\u003e具体文件系统缓存(例如ext4的缓存)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eIOPS文件IO每秒io次数\u003c/li\u003e\n\u003cli\u003e响应时间\u003c/li\u003e\n\u003cli\u003e吞吐量\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e磁盘\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e使用率\u003c/li\u003e\n\u003cli\u003eIOPS\u003c/li\u003e\n\u003cli\u003e吞吐量\u003c/li\u003e\n\u003cli\u003e响应时间\u003c/li\u003e\n\u003cli\u003e缓冲区\u003c/li\u003e\n\u003cli\u003e读写类型(顺序读、随机读)、读写比例、读写大小、存储类型(RAID阵列、本地还是网络)\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e性能指标\u003c/h2\u003e\n\u003cp\u003eIOPS是指单位时间内系统能处理的I/O请求数量，I/O请求通常为读或写数据操作请求。随机读写频繁的应用，如OLTP(Online Transaction Processing)，IOPS是关键衡量指标。\u003c/p\u003e\n\u003cp\u003e数据吞吐量(Throughput)，指单位时间内可以成功传输的数据数量。对于大量顺序读写的应用，如VOD(Video On Demand)，则更关注吞吐量指标。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e每秒 I/O 吞吐量＝ IOPS* 平均 I/O SIZE\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e对于随机负载，当遇到余下情况时，我们那通常认为存在 I/O 性能问题：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e平均读时间大于 15ms\n2. 在具有写 cache 的条件下，平均写时间大于 2.5ms\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e对于顺序负载，当遇到余下情况时，我们那通常认为存在 I/O 性能问题：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e在一个磁盘上有两个连续的 I/O 流\u003c/li\u003e\n\u003cli\u003e吞吐量不足（即远远小于磁盘 I/O 带宽）\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003e分析工具\u003c/h2\u003e\n\u003cimg src=\"/images/blogs/io分析工具.png\" /\u003e\n\n\u003cul\u003e\n\u003cli\u003e先用iostat发现磁盘IO性能瓶颈\u003c/li\u003e\n\u003cli\u003e再借助pidstat和vmstat定位出导致瓶颈的进程\u003c/li\u003e\n\u003cli\u003e随后分析进程的IO行为\u003c/li\u003e\n\u003cli\u003e最后结合应用程序的原理，分析这些IO的来源\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e内存\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e系统内存指标\u003cul\u003e\n\u003cli\u003e已用内存\u003c/li\u003e\n\u003cli\u003e剩余内存\u003c/li\u003e\n\u003cli\u003e可用内存\u003c/li\u003e\n\u003cli\u003e缺页异常: 主缺页异常、次缺页异常\u003c/li\u003e\n\u003cli\u003e缓存区: 使用量、命中率\u003c/li\u003e\n\u003cli\u003eslabs\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e进程内存指标\u003cul\u003e\n\u003cli\u003eVSS虚拟内存\u003c/li\u003e\n\u003cli\u003eRSS常驻内存\u003c/li\u003e\n\u003cli\u003ePSS按比例分配共享内存后的物理内存\u003c/li\u003e\n\u003cli\u003eUSS独占内存\u003c/li\u003e\n\u003cli\u003e共享内存\u003c/li\u003e\n\u003cli\u003eSWAP内存\u003c/li\u003e\n\u003cli\u003e缺页异常: 主缺页异常、次缺页异常\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eSWAP\u003cul\u003e\n\u003cli\u003e已用空间\u003c/li\u003e\n\u003cli\u003e剩余空间\u003c/li\u003e\n\u003cli\u003e换入速度\u003c/li\u003e\n\u003cli\u003e换出速度\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e基础性能指标包括，物理内存(RES)、交换区(SWAP)、虚拟内存(VIRT)\u003c/p\u003e\n\u003cp\u003e• VIRT 进程的虚拟内存大小\n• RES 常驻内存的大小，即进程实际使用的物理内存大小，不包括swap和共享内存\n• SHR 共享内存大小，与其他进程共享的内存，加载的动态链接库以及程序代码段\n• %MEM 进程使用物理内存占系统总内存的百分比\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e虚拟内存 = 物理内存 + 交换区\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e可以使用top查看各个进程大致的内存使用情况\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e执行\u003cstrong\u003etop\u003c/strong\u003e命令后，通常不会显示\u003cstrong\u003eSWAP\u003c/strong\u003e列, 需要进入点击f进入列编辑模式，然后按p，这时swap被选中，然后按回车键就可以了\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e除了上面这个与进程使用强相关的，还有系统整体的分析指标\u003c/p\u003e\n\u003cp\u003etotoal(物理内存总大小)、used(已经使用的物理内存大小)、free(空闲的物理内存)、shared(多个进程共享内存的大小)、buffers/cached(作为缓存的内存大小，buffer用来缓存磁盘文件的元数据例如文件属性、目录结构等，cache缓存的是真正的文件内容)、swap(交换空间的使用状态)\u003c/p\u003e\n\u003ch2\u003e常见问题\u003c/h2\u003e\n\u003cp\u003e1、空闲空间少不一定是内存不够，linux会尽量提高内存使用率，经常会把磁盘上的内容缓存到内存，用来加速，当内存不足时，linux就会释放缓存部分，让给真正需要的程序使用\u003c/p\u003e\n\u003cp\u003e2、内存真正存在问题的情形是: 持续的内存换入换出、较多的主缺页中断\u003c/p\u003e\n\u003cp\u003e可以通过sar工具查看到\u003ccode\u003esar -B 1 3\u003c/code\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e主缺页中断(majflt): 内存中找不到，需要到磁盘中找\n次缺页中断(fault): 在内存中可以找到目标页\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e内存的换入换出(pgpgin/pgpgout)\u003c/p\u003e\n\u003cimg src=\"/images/blogs/sar示例.png\" /\u003e\n\n\u003cp\u003evmstat可以查看空闲的物理内存、缓存、以及换入换出之类的\u003c/p\u003e\n\u003ch2\u003e常用工具\u003c/h2\u003e\n\u003cimg src=\"/images/blogs/内存分析工具.png\" /\u003e\n\n\u003ch1\u003e命令概览\u003c/h1\u003e\n\u003ch2\u003etop\u003c/h2\u003e\n\u003cp\u003e可以查看进程状态(正在运行、睡眠、停止的)，用户空间占比，内存使用情况(物理内存总量、交换区总量等)\u003c/p\u003e\n\u003cp\u003e第一行是任务队列信息：当前时间、系统运行时间、当前登录用户数，系统负载(任务队列的平均长度)\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e2500 毫秒刷新一次 TOP 内容，总共 5 次，输出内容存放到 performace.txt 文件中: \u003ccode\u003etop -b -d 2.5 -n 5 \u0026gt; performace.txt\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eTOP 默认排序为倒序，如果确实需要升序排序，可以使用大写字母按键：R\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003evmstat\u003c/h2\u003e\n\u003cp\u003e可以用于查看进程(运行队列中进程数量，等待IO的进程数量)、内存、IO等系统的整体运行状态\u003c/p\u003e\n\u003cp\u003esi、so为交换区与内存之间的换入换出，如果长期大于0说明经常发生内存交换，硬盘io和CPU都会消耗，这个时候需要扩大内存\u003c/p\u003e\n\u003cp\u003ein: 每秒中断数包括时钟中断，cs: 每秒上下文切换数。这两个数值越大，内核消耗的CPU时间越大\u003c/p\u003e\n\u003cp\u003ewa高说明IO等待比较严重，这可能是由于磁盘大量作随机访问造成，也有可能磁盘出现瓶颈(块操作)\u003c/p\u003e\n\u003cp\u003eus: 用户进程执行时间百分比(user time)。us的值比较高时，说明用户进程消耗的CPU时间多，但是如果长期超50%的使用，那么我们就该考虑优化程序算法或者进行加速。\u003c/p\u003e\n\u003cp\u003esy: 内核系统进程执行时间百分比。sy的值高时，说明系统内核消耗的CPU资源多，这并不是良性表现，我们应该检查原因。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003e\u003cspan class=\"hljs-string\"\u003evmstat\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003eprocs\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-----------memory----------\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e---swap--\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-----io----\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e--system--\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-----cpu------\u003c/span\u003e\n \u003cspan class=\"hljs-string\"\u003er\u003c/span\u003e  \u003cspan class=\"hljs-string\"\u003eb\u003c/span\u003e   \u003cspan class=\"hljs-string\"\u003eswpd\u003c/span\u003e   \u003cspan class=\"hljs-string\"\u003efree\u003c/span\u003e   \u003cspan class=\"hljs-string\"\u003ebuff\u003c/span\u003e  \u003cspan class=\"hljs-string\"\u003ecache\u003c/span\u003e   \u003cspan class=\"hljs-string\"\u003esi\u003c/span\u003e   \u003cspan class=\"hljs-string\"\u003eso\u003c/span\u003e    \u003cspan class=\"hljs-string\"\u003ebi\u003c/span\u003e    \u003cspan class=\"hljs-string\"\u003ebo\u003c/span\u003e   \u003cspan class=\"hljs-string\"\u003ein\u003c/span\u003e   \u003cspan class=\"hljs-string\"\u003ecs\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eus\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esy\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eid\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ewa\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003est\u003c/span\u003e\n \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e320\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e42188\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e167332\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1534368\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e99\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e320\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e42188\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e167332\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1534392\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1002   \u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e39\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e320\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e42188\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e167336\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1534392\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e19\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1002   \u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e44\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e320\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e42188\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e167336\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1534392\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1002   \u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e41\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e320\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e42188\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e167336\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1534392\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e    \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e     \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1002   \u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e41\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003epidstat\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e-u：默认的参数，显示各个进程的cpu使用统计\u003c/li\u003e\n\u003cli\u003e-r：显示各个进程的内存使用统计\u003c/li\u003e\n\u003cli\u003e-d：显示各个进程的IO使用情况\u003c/li\u003e\n\u003cli\u003e-p：指定进程号\u003c/li\u003e\n\u003cli\u003e-w：显示每个进程的上下文切换情况\u003c/li\u003e\n\u003cli\u003e-t：显示选择任务的线程的统计信息外的额外信息\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ccode\u003epidstat -u 5 1\u003c/code\u003e： 查看哪个进程占用了大量的CPU或者io\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003epidstat -u -p ALL\u003c/code\u003e: 查看所有进程的CPU使用情况\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003epidstat -r -p [pid] [时间间隔] [收集次数]\u003c/code\u003e\u003c/p\u003e\n\u003ch2\u003elsof\u003c/h2\u003e\n\u003cp\u003elsof中\u003ccode\u003e-P\u003c/code\u003e是禁止将端口转成别名(例如\u003ccode\u003e8000 -\u0026gt; irdmi\u003c/code\u003e, \u003ccode\u003e8001 -\u0026gt; vcom-tunnel\u003c/code\u003e)\u003c/p\u003e\n\u003cp\u003e1、通过端口获取pid: \u003ccode\u003elsof -i:[端口] -P -t\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e2、通过pid获取端口占用情况\u003ccode\u003elsof -i -P | grep [pid]\u003c/code\u003e\u003c/p\u003e\n","frontMatter":{"readingTime":{"text":"20 min read","minutes":19.88,"time":1192800,"words":3976},"slug":"操作系统性能分析工具","fileName":"操作系统性能分析工具.md","title":"操作系统性能分析工具","date":"2022-10-10T00:00:00.000Z","tags":["操作系统"],"draft":false,"summary":"操作系统性能分析工具"}},"prev":{"title":"表达时间的格式","date":"2022-10-10T00:00:00.000Z","tags":["操作系统"],"draft":false,"summary":"表达时间的格式","slug":"时间格式"},"next":{"title":"golang编程中常见的问题","date":"2022-10-10T00:00:00.000Z","tags":["Golang"],"draft":false,"summary":"golang编程中常见的问题","slug":"常见编码问题"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["操作系统性能分析工具"]},"buildId":"PMB5qMppIrri5HN2Gb314","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>