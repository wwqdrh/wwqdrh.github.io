<!DOCTYPE html><html lang="zh-CN"><head><meta name="viewport" content="width=device-width"/><title>go-zero微服务实践</title><meta name="robots" content="follow, index"/><meta charSet="UTF-8"/><meta name="description" content="微服务简介以及go-zero如何落地"/><meta property="og:type"/><meta property="og:title" content="go-zero微服务实践"/><meta property="og:description" content="微服务简介以及go-zero如何落地"/><meta property="og:url" content="https://wwqdrh.github.io/undefined"/><meta name="keywords" content="wwqdrh技术博客"/><meta property="og:locale" content="zh-CN"/><meta property="og:image" content="https://wwqdrh.github.io"/><meta name="twitter:title" content="go-zero微服务实践"/><meta name="twitter:description" content="微服务简介以及go-zero如何落地"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="https://wwqdrh.github.io"/><link rel="stylesheet" href="/assets/mdrender/editor-render.css"/><meta name="next-head-count" content="17"/><link rel="icon" href="/favicon.ico"/><link rel="apple-touch-icon" sizes="192x192" href="/apple-touch-icon.png"/><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/feed"/><script src="/assets/analizy/clarity.js"></script><link rel="preload" href="/_next/static/media/d83e92f0af8b17e4-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/e52907b750a6f61e-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/ed42d1b51efd45f6-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/9031250013752d4b-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/fba9d678ff638e59-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/eb9adf802b0a60eb-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/81b352a4d7a000ae-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/41b9b3ece820718f-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/d587d1c112526568-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/css/869c7de7c781f904.css" as="style"/><link rel="stylesheet" href="/_next/static/css/869c7de7c781f904.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-fbe37f60a09a330b.js" defer=""></script><script src="/_next/static/chunks/main-082d90b1269d95f6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ebc472ae118a2be0.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-222bf60d0a2bf3df.js" defer=""></script><script src="/_next/static/qwylQn0rAYfx_DG8FLkaO/_buildManifest.js" defer=""></script><script src="/_next/static/qwylQn0rAYfx_DG8FLkaO/_ssgManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css-global c86wz">body{margin:0;padding:0;color:hsl(0, 0%, 9.0%);background-color:hsl(0, 0%, 97.3%);font-family:'__pretendard_6bb8e5','__pretendard_Fallback_6bb8e5';}*{-webkit-print-color-scheme:light;color-scheme:light;box-sizing:border-box;}h1,h2,h3,h4,h5,h6{margin:0;font-weight:inherit;font-style:inherit;}a{all:unset;cursor:pointer;}ul{padding:0;}button{all:unset;cursor:pointer;}input{all:unset;box-sizing:border-box;}textarea{border:none;background-color:transparent;font-family:inherit;padding:0;outline:none;resize:none;color:inherit;}hr{width:100%;border:none;margin:0;border-top:1px solid hsl(0, 0%, 88.7%);}</style><style data-emotion="css 1q70a33">.css-1q70a33{z-index:30;position:-webkit-sticky;position:sticky;top:0;background-color:hsl(0, 0%, 97.3%);box-shadow:0 1px 2px 0 rgba(0, 0, 0, 0.05);}.css-1q70a33 .container{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:100%;height:3rem;margin:0 auto;}@media (min-width: 768px){.css-1q70a33 .container[data-full-width="true"]{padding-left:6rem;padding-right:6rem;}}.css-1q70a33 .container .nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;gap:0.75rem;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-1q70a33 .container .mid{padding-top:0.5rem;padding-bottom:0.5rem;padding-left:1.25rem;padding-right:1.25rem;border-radius:1rem;outline-style:none;width:50%;background-color:hsl(0, 0%, 93.0%);}</style><div class="py-2 css-1q70a33"><div data-full-width="false" class="container"><a aria-label="wwqdrh" class="css-0" href="/">wwqdrh</a><input class="mid" type="text" placeholder="Search Keyword..." value=""/><div class="nav"><style data-emotion="css 1nw6zn9">.css-1nw6zn9{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}.css-1nw6zn9 ul{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}.css-1nw6zn9 ul li{display:block;margin-left:1rem;color:hsl(0, 0%, 43.5%);}</style><div class="css-1nw6zn9"><ul><li><a target="_blank" href="https://space.bilibili.com/538676331">B站</a></li></ul></div><style data-emotion="css 1h5x3dy">.css-1h5x3dy{cursor:pointer;}</style><div class="css-1h5x3dy"><style data-emotion="css p95608">.css-p95608{font-family:'__Noto_Color_Emoji_be1378','__Noto_Color_Emoji_Fallback_be1378',Apple Color Emoji;font-weight:400;font-style:normal;}</style><span class="css-p95608">☀️</span></div></div></div></div><style data-emotion="css lomkhl">.css-lomkhl{margin:0 auto;width:100%;padding:0 3rem;}</style><main class="css-lomkhl"><div class="divide-y bg-white dark:bg-gray-700 p-6 shadow-lg rounded-lg mt-3 divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="max-w-none pt-10 pb-8 prose dark:prose-dark"><div><h1>简介</h1>
<p>介绍go-zero之前先说明什么是微服务、为什么要用微服务、微服务有哪些缺点</p>
<p>微服务是比代码更高粒度设计模式思想的体现，将功能高度相关的集中在一起是高内聚的体现，通过服务的拆分来降低系统之间的耦合度是低耦合的体现</p>
<p>不仅是代码的可维护、可测试、可扩展重要，应用层面的这些特性同样重要</p>
<p>至于高内聚低耦合、服务分层有什么优点，写过代码的应该都清楚就不赘述</p>
<p>另外，两个要点</p>
<p>1、不要因为代码规模太小而拒绝良好的设计，设计与代码规模无关，只与应用是否可维护、可扩展有关
2、不要为了拆成微服务而拆，没有良好的服务划分，拆出来只会加大服务之间的混乱程度</p>
<h1>微服务需要解决的问题</h1>
<h2>服务注册与发现</h2>
<p>主要就是让服务之间知道某个服务在某个地址，以及做负载均衡等</p>
<h2>日志收集</h2>
<p>各个服务拆分之后日志保存会很分散，一个个的去服务上查看日志显然不合适，需要有日志上报集中查看的功能</p>
<h2>链路追踪</h2>
<p>多个服务之间的调用链条需要有可视化的查看机制</p>
<h2>服务监控</h2>
<p>及时查看服务是否运行正常</p>
<h2>分布式事务</h2>
<p>涉及到数据修改，为了保证数据一致性，避免其中某个服务出错而数据无法回滚到正确的版本</p>
<h2>服务治理</h2>
<p>自适应降级能非常智能的保护服务自身，根据服务自身的系统负载动态判断是否需要降级。保护自身不被调用方压垮</p>
<p>限流，防止突发流量压垮系统</p>
<p>熔断，发起服务调用的时候，如果被调用方返回的错误率超过一定的阈值，那么后续的请求将不会真正发起请求，而是在调用方直接返回错误</p>
<h1>go-zero如何解决这些问题的</h1>
<p>在讲go-zero如何解决上述微服务要点之前，先说说go-zero有什么优点</p>
<h2>代码自动生成</h2>
<p>包括rpc、api、model三部分，其中rpc、api是gateway层，rpc是基于zrpc(grpc的封装)框架的服务之间调用服务。api是给外部用户使用的</p>
<p>model层是模型层+缓存服务的自动生成(但是有个问题，现在只能生成mysql的，但是问题不大，数据层的代码本身就有很多逻辑要自己写，这部分可以照旧使用原来的技术栈)</p>
<ul>
<li><code>goctl api go -dir . -api user.api</code></li>
<li><code>goctl rpc protoc --go_out=. --go-grpc_out=. --zrpc_out=. user.proto</code></li>
<li><code>goctl model mysql ddl -c -dir . -src user.sql</code></li>
</ul>
<p><em>api文件格式</em></p>
<pre><code class="hljs language-go">type (
    <span class="hljs-comment">// 用户登录</span>
    <span class="hljs-title class_">LoginRequest</span> {
        <span class="hljs-title class_">Mobile</span>   string <span class="hljs-string">`json:&quot;mobile&quot;`</span>
        <span class="hljs-title class_">Password</span> string <span class="hljs-string">`json:&quot;password&quot;`</span>
    }
    <span class="hljs-title class_">LoginResponse</span> {
        <span class="hljs-title class_">AccessToken</span>  string <span class="hljs-string">`json:&quot;accessToken&quot;`</span>
        <span class="hljs-title class_">AccessExpire</span> int64  <span class="hljs-string">`json:&quot;accessExpire&quot;`</span>
    }
    <span class="hljs-comment">// 用户登录</span>

    <span class="hljs-comment">// 用户注册</span>
    <span class="hljs-title class_">RegisterRequest</span> {
        <span class="hljs-title class_">Name</span>     string <span class="hljs-string">`json:&quot;name&quot;`</span>
        <span class="hljs-title class_">Gender</span>   int64  <span class="hljs-string">`json:&quot;gender&quot;`</span>
        <span class="hljs-title class_">Mobile</span>   string <span class="hljs-string">`json:&quot;mobile&quot;`</span>
        <span class="hljs-title class_">Password</span> string <span class="hljs-string">`json:&quot;password&quot;`</span>
    }
    <span class="hljs-title class_">RegisterResponse</span> {
        <span class="hljs-title class_">Id</span>     int64  <span class="hljs-string">`json:&quot;id&quot;`</span>
        <span class="hljs-title class_">Name</span>   string <span class="hljs-string">`json:&quot;name&quot;`</span>
        <span class="hljs-title class_">Gender</span> int64  <span class="hljs-string">`json:&quot;gender&quot;`</span>
        <span class="hljs-title class_">Mobile</span> string <span class="hljs-string">`json:&quot;mobile&quot;`</span>
    }
    <span class="hljs-comment">// 用户注册</span>

    <span class="hljs-comment">// 用户信息</span>
    <span class="hljs-title class_">UserInfoResponse</span> {
        <span class="hljs-title class_">Id</span>     int64  <span class="hljs-string">`json:&quot;id&quot;`</span>
        <span class="hljs-title class_">Name</span>   string <span class="hljs-string">`json:&quot;name&quot;`</span>
        <span class="hljs-title class_">Gender</span> int64  <span class="hljs-string">`json:&quot;gender&quot;`</span>
        <span class="hljs-title class_">Mobile</span> string <span class="hljs-string">`json:&quot;mobile&quot;`</span>
    }
    <span class="hljs-comment">// 用户信息</span>
)

service <span class="hljs-title class_">User</span> {
    @handler <span class="hljs-title class_">Login</span>
    post /api/user/login (<span class="hljs-title class_">LoginRequest</span>) returns (<span class="hljs-title class_">LoginResponse</span>)
    
    @handler <span class="hljs-title class_">Register</span>
    post /api/user/register (<span class="hljs-title class_">RegisterRequest</span>) returns (<span class="hljs-title class_">RegisterResponse</span>)
}

@<span class="hljs-title function_">server</span>(
    <span class="hljs-attr">jwt</span>: <span class="hljs-title class_">Auth</span>
)
service <span class="hljs-title class_">User</span> {
    @handler <span class="hljs-title class_">UserInfo</span>
    post /api/user/userinfo () returns (<span class="hljs-title class_">UserInfoResponse</span>)
}
</code></pre><h2>容器文件自动生成</h2>
<p>创建Dockerfile, <code>goctl docker -go hello.go</code></p>
<p>docker build -t .... 创建镜像</p>
<h2>k8s服务文件自动生成</h2>
<p><code>goctl kube deploy -name redis -namespace adhoc -image redis:6-alpine -o redis.yaml -port 6379</code></p>
<p>这条命令的含义就是在adhoc命名空间中创建Deployment类型的资源，名字叫做redis，使用的镜像为<code>redis:6-alpine</code>, containerPort为6379</p>
<p>接下来是go-zero中如何解决上文所说的问题</p>
<h2>服务注册与发现</h2>
<p>部署etcd(这里为了简单仅部署单节点)</p>
<pre><code class="hljs language-bash"><span class="hljs-string">docker</span> <span class="hljs-string">pull</span> <span class="hljs-string">bitnami/etcd:3.5.3</span>

<span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-string">-d</span> <span class="hljs-string">-p</span> <span class="hljs-number">2379</span><span class="hljs-string">:2379</span> <span class="hljs-string">-p</span> <span class="hljs-number">2380</span><span class="hljs-string">:2380</span> <span class="hljs-string">\</span>
<span class="hljs-string">-e</span> <span class="hljs-string">ETCD_ROOT_PASSWORD=123456</span> <span class="hljs-string">\</span>
<span class="hljs-string">--name</span> <span class="hljs-string">etcd3</span> <span class="hljs-string">bitnami/etcd:3.5.3</span>
</code></pre><p>go-zero中配置(配置文件也是由上文的goctl自动生成的，执行一遍就知道了)</p>
<pre><code class="hljs language-yaml"><span class="hljs-string">//</span> <span class="hljs-string">注册者</span>
<span class="hljs-attr">Etcd:</span>
  <span class="hljs-attr">Hosts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:2379</span>
  <span class="hljs-attr">Key:</span> <span class="hljs-string">user.rpc</span>
  <span class="hljs-attr">User:</span> <span class="hljs-string">root</span>
  <span class="hljs-attr">Pass:</span> <span class="hljs-string">&quot;123456&quot;</span>
</code></pre><p>其中Key就是该服务注册到etcd中的名字</p>
<p>调用者,首先修改配置以及修改go中的结构体</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">UserRpc:</span>
  <span class="hljs-attr">Etcd:</span>
    <span class="hljs-attr">Hosts:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:2379</span>
    <span class="hljs-attr">Key:</span> <span class="hljs-string">user.rpc</span>
    <span class="hljs-attr">User:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">Pass:</span> <span class="hljs-string">&quot;123456&quot;</span>
</code></pre><pre><code class="hljs language-go"><span class="hljs-built_in">type</span> Config struct {
    ...
    UserRpc zrpc.RpcClientConf
}
</code></pre><p>然后将服务初始化到上下文中</p>
<pre><code class="hljs language-go">type ServiceContext <span class="hljs-keyword">struct</span> {
    Config  config.Config
    UserRpc user.User
}

<span class="hljs-function">func <span class="hljs-title">NewServiceContext</span><span class="hljs-params">(c config.Config)</span> *ServiceContext </span>{
    <span class="hljs-keyword">return</span> &amp;ServiceContext{
        Config:  c,
        UserRpc: user.<span class="hljs-built_in">NewUser</span>(zrpc.<span class="hljs-built_in">MustNewClient</span>(c.UserRpc)),
    }
}
</code></pre><p>之后就可以直接使用UserRpc进行rpc调用</p>
<h2>日志收集</h2>
<p>部署EFK架构，当然如果只是为了将日志集中起来方便查看，可以暂时需要elasticsearch+kibana</p>
<p>部署fluentd</p>
<pre><code class="hljs language-bash">docker pull fluent/<span class="hljs-attr">fluentd</span>:v1<span class="hljs-number">.14</span>-debian

docker run -d -p <span class="hljs-number">24224</span>:<span class="hljs-number">24224</span> -v ${conf}:<span class="hljs-regexp">/fluentd/</span>etc/fluent.<span class="hljs-property">conf</span> fluent/<span class="hljs-attr">fluentd</span>:v1<span class="hljs-number">.14</span>-debian
</code></pre><p>示例配置文件</p>
<p>参考: <a href="https://docs.fluentd.org/configuration/config-file">https://docs.fluentd.org/configuration/config-file</a></p>
<pre><code class="hljs language-conf"><span class="hljs-string">&lt;source&gt;</span>
  <span class="hljs-string">@type</span>   <span class="hljs-string">forward</span>
<span class="hljs-string">&lt;/source&gt;</span>
<span class="hljs-string">&lt;match</span> <span class="hljs-string">*&gt;</span>
  <span class="hljs-string">@type</span>              <span class="hljs-string">file</span>
  <span class="hljs-string">path</span>               <span class="hljs-string">/fluentd/log/${tag}</span>
  <span class="hljs-string">append</span>             <span class="hljs-literal">true</span>
  <span class="hljs-string">&lt;format&gt;</span>
    <span class="hljs-string">@type</span>            <span class="hljs-string">single_value</span>
    <span class="hljs-string">message_key</span>      <span class="hljs-string">log</span>
  <span class="hljs-string">&lt;/format&gt;</span>
  <span class="hljs-string">&lt;buffer</span> <span class="hljs-string">tag,time&gt;</span>
    <span class="hljs-string">@type</span>             <span class="hljs-string">file</span>
    <span class="hljs-string">timekey</span>           <span class="hljs-string">1d</span>
    <span class="hljs-string">timekey_wait</span>      <span class="hljs-string">10m</span>
    <span class="hljs-string">flush_mode</span>        <span class="hljs-string">interval</span>
    <span class="hljs-string">flush_interval</span>    <span class="hljs-string">30s</span>
  <span class="hljs-string">&lt;/buffer&gt;</span>
<span class="hljs-string">&lt;/match&gt;</span>
</code></pre><p>将上传到flutend的操作封装进基础logger库的可选项以及包装成go-zero可使用的模式</p>
<p>参考: github.com/wwqdrh/logger</p>
<pre><code class="hljs language-go"><span class="hljs-keyword">import</span> (
    mylogx <span class="hljs-string">&quot;github.com/wwqdrh/logger/logx&quot;</span>
    <span class="hljs-string">&quot;github.com/zeromicro/go-zero/core/conf&quot;</span>
    <span class="hljs-string">&quot;github.com/zeromicro/go-zero/core/logx&quot;</span>
)

func <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) {
    l := logger.<span class="hljs-title class_">NewLogger</span>(
        logger.<span class="hljs-title class_">WithLevel</span>(zapcore.<span class="hljs-property">WarnLevel</span>),
        logger.<span class="hljs-title class_">WithLogPath</span>(<span class="hljs-string">&quot;./logs/info.log&quot;</span>),
        logger.<span class="hljs-title class_">WithName</span>(<span class="hljs-string">&quot;info&quot;</span>),
        logger.<span class="hljs-title class_">WithFluentd</span>(<span class="hljs-literal">true</span>, <span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">24224</span>),
        logger.<span class="hljs-title class_">WithConsole</span>(<span class="hljs-literal">false</span>),
    )

    writer, _ := mylogx.<span class="hljs-title class_">NewZeroWriter</span>(l)
    logx.<span class="hljs-title class_">Must</span>(err)
    logx.<span class="hljs-title class_">SetWriter</span>(writer)
}
</code></pre><p>之后使用logx.Infof就可以将日志上传至服务中, 所有的服务的日志就已经收集到了flutend容器中</p>
<h2>链路追踪</h2>
<p>go-zero已经封装了，仅需部署jaeger之后修改服务的配置项进行启用</p>
<p>部署jaeger</p>
<pre><code class="hljs language-bash"><span class="hljs-string">docker</span> <span class="hljs-string">pull</span> <span class="hljs-string">jaegertracing/all-in-one:1.34</span>

<span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-string">-d</span> <span class="hljs-string">--name</span> <span class="hljs-string">jaeger</span> <span class="hljs-string">\</span>
<span class="hljs-string">-e</span> <span class="hljs-string">COLLECTOR_ZIPKIN_HTTP_PORT=9411</span> <span class="hljs-string">\</span>
<span class="hljs-string">-p</span> <span class="hljs-number">5775</span><span class="hljs-string">:5775/udp</span> <span class="hljs-string">\</span>
<span class="hljs-string">-p</span> <span class="hljs-number">6831</span><span class="hljs-string">:6831/udp</span> <span class="hljs-string">\</span>
<span class="hljs-string">-p</span> <span class="hljs-number">6832</span><span class="hljs-string">:6832/udp</span> <span class="hljs-string">\</span>
<span class="hljs-string">-p</span> <span class="hljs-number">5778</span><span class="hljs-string">:5778</span> <span class="hljs-string">\</span>
<span class="hljs-string">-p</span> <span class="hljs-number">16686</span><span class="hljs-string">:16686</span> <span class="hljs-string">\</span>
<span class="hljs-string">-p</span> <span class="hljs-number">14268</span><span class="hljs-string">:14268</span> <span class="hljs-string">\</span>
<span class="hljs-string">-p</span> <span class="hljs-number">9411</span><span class="hljs-string">:9411</span> <span class="hljs-string">\</span>
<span class="hljs-string">jaegertracing/all-in-one:1.34</span>
</code></pre><p>修改配置</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">Telemetry:</span>
  <span class="hljs-attr">Name:</span> <span class="hljs-string">user.api</span>
  <span class="hljs-attr">Endpoint:</span> <span class="hljs-string">http://127.0.0.1:14268/api/traces</span>
  <span class="hljs-attr">Sampler:</span> <span class="hljs-number">1.0</span>
  <span class="hljs-attr">Batcher:</span> <span class="hljs-string">jaeger</span>
</code></pre><p>效果</p>
<img src="/images/blogs/jaeger-1.png" />

<img src="/images/blogs/jaeger-2.png" />

<h2>服务监控</h2>
<p>go-zero已经集成</p>
<p>部署prometheus</p>
<pre><code class="hljs language-bash">docker pull bitnami/<span class="hljs-attr">prometheus</span>:<span class="hljs-number">2.9</span><span class="hljs-number">.2</span>

docker run --name prometheus \
-v ${<span class="hljs-variable constant_">CURDIR</span>}<span class="hljs-string">&quot;/env/prometheus/prometheus.yml&quot;</span>:<span class="hljs-regexp">/opt/</span>bitnami/prometheus/data \
-p <span class="hljs-number">9090</span>:<span class="hljs-number">9090</span> \
    bitnami/<span class="hljs-attr">prometheus</span>:<span class="hljs-number">2.9</span><span class="hljs-number">.2</span>
</code></pre><p>进行配置</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">Prometheus:</span>
  <span class="hljs-attr">Host:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
  <span class="hljs-attr">Port:</span> <span class="hljs-number">9081</span>
  <span class="hljs-attr">Path:</span> <span class="hljs-string">/metrics</span>
</code></pre><p>修改prometheus监听的服务配置（上文的prometheus.yml）</p>
<pre><code class="hljs language-yaml"><span class="hljs-comment"># my global config</span>
<span class="hljs-attr">global:</span>
  <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span> <span class="hljs-comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute. </span>
  <span class="hljs-attr">evaluation_interval:</span> <span class="hljs-string">15s</span> <span class="hljs-comment"># Evaluate rules every 15 seconds. The default is every 1 minute.     </span>
  <span class="hljs-comment"># scrape_timeout is set to the global default (10s).</span>

<span class="hljs-comment"># Alertmanager configuration</span>
<span class="hljs-attr">alerting:</span>
  <span class="hljs-attr">alertmanagers:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">static_configs:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span>
          <span class="hljs-comment"># - alertmanager:9093</span>

<span class="hljs-comment"># Load rules once and periodically evaluate them according to the global &#x27;evaluation_interval&#x27;.  </span>
<span class="hljs-attr">rule_files:</span>
  <span class="hljs-comment"># - &quot;first_rules.yml&quot;</span>
  <span class="hljs-comment"># - &quot;second_rules.yml&quot;</span>

<span class="hljs-comment"># A scrape configuration containing exactly one endpoint to scrape:</span>
<span class="hljs-comment"># Here it&#x27;s Prometheus itself.</span>
<span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&quot;prometheus&quot;</span>

    <span class="hljs-comment"># metrics_path defaults to &#x27;/metrics&#x27;</span>
    <span class="hljs-comment"># scheme defaults to &#x27;http&#x27;.</span>

    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&quot;localhost:9090&quot;</span>]

  <span class="hljs-comment"># 我们自己的商城项目配置</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;mall&#x27;</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-comment"># 目标的采集地址</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;192.168.110.113:9081&#x27;</span>]
        <span class="hljs-attr">labels:</span>
          <span class="hljs-comment"># 自定义标签</span>
          <span class="hljs-attr">app:</span> <span class="hljs-string">&#x27;user-api&#x27;</span>
          <span class="hljs-attr">env:</span> <span class="hljs-string">&#x27;test&#x27;</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;192.168.110.113:9091&#x27;</span>]
        <span class="hljs-attr">labels:</span>
          <span class="hljs-attr">app:</span> <span class="hljs-string">&#x27;user-rpc&#x27;</span>
          <span class="hljs-attr">env:</span> <span class="hljs-string">&#x27;test&#x27;</span>
</code></pre><p>效果</p>
<img src="/images/blogs/prometheus-1.png" />

<h2>分布式事务</h2>
<p>使用dtm</p>
<p>比较大的部分，详细文档查看: <a href="https://go-zero.dev/cn/docs/eco/distributed-transaction">https://go-zero.dev/cn/docs/eco/distributed-transaction</a></p>
<h2>服务治理</h2>
<p>熔断器使用文档: <a href="https://go-zero.dev/cn/docs/blog/governance/breaker-algorithms">https://go-zero.dev/cn/docs/blog/governance/breaker-algorithms</a></p>
<p>自适应降级文档: <a href="https://go-zero.dev/cn/docs/blog/governance/loadshedding">https://go-zero.dev/cn/docs/blog/governance/loadshedding</a></p>
<p>限流文档: <a href="https://go-zero.dev/cn/docs/blog/governance/periodlimit">https://go-zero.dev/cn/docs/blog/governance/periodlimit</a></p>
</div></div></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"\u003ch1\u003e简介\u003c/h1\u003e\n\u003cp\u003e介绍go-zero之前先说明什么是微服务、为什么要用微服务、微服务有哪些缺点\u003c/p\u003e\n\u003cp\u003e微服务是比代码更高粒度设计模式思想的体现，将功能高度相关的集中在一起是高内聚的体现，通过服务的拆分来降低系统之间的耦合度是低耦合的体现\u003c/p\u003e\n\u003cp\u003e不仅是代码的可维护、可测试、可扩展重要，应用层面的这些特性同样重要\u003c/p\u003e\n\u003cp\u003e至于高内聚低耦合、服务分层有什么优点，写过代码的应该都清楚就不赘述\u003c/p\u003e\n\u003cp\u003e另外，两个要点\u003c/p\u003e\n\u003cp\u003e1、不要因为代码规模太小而拒绝良好的设计，设计与代码规模无关，只与应用是否可维护、可扩展有关\n2、不要为了拆成微服务而拆，没有良好的服务划分，拆出来只会加大服务之间的混乱程度\u003c/p\u003e\n\u003ch1\u003e微服务需要解决的问题\u003c/h1\u003e\n\u003ch2\u003e服务注册与发现\u003c/h2\u003e\n\u003cp\u003e主要就是让服务之间知道某个服务在某个地址，以及做负载均衡等\u003c/p\u003e\n\u003ch2\u003e日志收集\u003c/h2\u003e\n\u003cp\u003e各个服务拆分之后日志保存会很分散，一个个的去服务上查看日志显然不合适，需要有日志上报集中查看的功能\u003c/p\u003e\n\u003ch2\u003e链路追踪\u003c/h2\u003e\n\u003cp\u003e多个服务之间的调用链条需要有可视化的查看机制\u003c/p\u003e\n\u003ch2\u003e服务监控\u003c/h2\u003e\n\u003cp\u003e及时查看服务是否运行正常\u003c/p\u003e\n\u003ch2\u003e分布式事务\u003c/h2\u003e\n\u003cp\u003e涉及到数据修改，为了保证数据一致性，避免其中某个服务出错而数据无法回滚到正确的版本\u003c/p\u003e\n\u003ch2\u003e服务治理\u003c/h2\u003e\n\u003cp\u003e自适应降级能非常智能的保护服务自身，根据服务自身的系统负载动态判断是否需要降级。保护自身不被调用方压垮\u003c/p\u003e\n\u003cp\u003e限流，防止突发流量压垮系统\u003c/p\u003e\n\u003cp\u003e熔断，发起服务调用的时候，如果被调用方返回的错误率超过一定的阈值，那么后续的请求将不会真正发起请求，而是在调用方直接返回错误\u003c/p\u003e\n\u003ch1\u003ego-zero如何解决这些问题的\u003c/h1\u003e\n\u003cp\u003e在讲go-zero如何解决上述微服务要点之前，先说说go-zero有什么优点\u003c/p\u003e\n\u003ch2\u003e代码自动生成\u003c/h2\u003e\n\u003cp\u003e包括rpc、api、model三部分，其中rpc、api是gateway层，rpc是基于zrpc(grpc的封装)框架的服务之间调用服务。api是给外部用户使用的\u003c/p\u003e\n\u003cp\u003emodel层是模型层+缓存服务的自动生成(但是有个问题，现在只能生成mysql的，但是问题不大，数据层的代码本身就有很多逻辑要自己写，这部分可以照旧使用原来的技术栈)\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003egoctl api go -dir . -api user.api\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egoctl rpc protoc --go_out=. --go-grpc_out=. --zrpc_out=. user.proto\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egoctl model mysql ddl -c -dir . -src user.sql\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cem\u003eapi文件格式\u003c/em\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-go\"\u003etype (\n    \u003cspan class=\"hljs-comment\"\u003e// 用户登录\u003c/span\u003e\n    \u003cspan class=\"hljs-title class_\"\u003eLoginRequest\u003c/span\u003e {\n        \u003cspan class=\"hljs-title class_\"\u003eMobile\u003c/span\u003e   string \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;mobile\u0026quot;`\u003c/span\u003e\n        \u003cspan class=\"hljs-title class_\"\u003ePassword\u003c/span\u003e string \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;password\u0026quot;`\u003c/span\u003e\n    }\n    \u003cspan class=\"hljs-title class_\"\u003eLoginResponse\u003c/span\u003e {\n        \u003cspan class=\"hljs-title class_\"\u003eAccessToken\u003c/span\u003e  string \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;accessToken\u0026quot;`\u003c/span\u003e\n        \u003cspan class=\"hljs-title class_\"\u003eAccessExpire\u003c/span\u003e int64  \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;accessExpire\u0026quot;`\u003c/span\u003e\n    }\n    \u003cspan class=\"hljs-comment\"\u003e// 用户登录\u003c/span\u003e\n\n    \u003cspan class=\"hljs-comment\"\u003e// 用户注册\u003c/span\u003e\n    \u003cspan class=\"hljs-title class_\"\u003eRegisterRequest\u003c/span\u003e {\n        \u003cspan class=\"hljs-title class_\"\u003eName\u003c/span\u003e     string \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;name\u0026quot;`\u003c/span\u003e\n        \u003cspan class=\"hljs-title class_\"\u003eGender\u003c/span\u003e   int64  \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;gender\u0026quot;`\u003c/span\u003e\n        \u003cspan class=\"hljs-title class_\"\u003eMobile\u003c/span\u003e   string \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;mobile\u0026quot;`\u003c/span\u003e\n        \u003cspan class=\"hljs-title class_\"\u003ePassword\u003c/span\u003e string \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;password\u0026quot;`\u003c/span\u003e\n    }\n    \u003cspan class=\"hljs-title class_\"\u003eRegisterResponse\u003c/span\u003e {\n        \u003cspan class=\"hljs-title class_\"\u003eId\u003c/span\u003e     int64  \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;id\u0026quot;`\u003c/span\u003e\n        \u003cspan class=\"hljs-title class_\"\u003eName\u003c/span\u003e   string \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;name\u0026quot;`\u003c/span\u003e\n        \u003cspan class=\"hljs-title class_\"\u003eGender\u003c/span\u003e int64  \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;gender\u0026quot;`\u003c/span\u003e\n        \u003cspan class=\"hljs-title class_\"\u003eMobile\u003c/span\u003e string \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;mobile\u0026quot;`\u003c/span\u003e\n    }\n    \u003cspan class=\"hljs-comment\"\u003e// 用户注册\u003c/span\u003e\n\n    \u003cspan class=\"hljs-comment\"\u003e// 用户信息\u003c/span\u003e\n    \u003cspan class=\"hljs-title class_\"\u003eUserInfoResponse\u003c/span\u003e {\n        \u003cspan class=\"hljs-title class_\"\u003eId\u003c/span\u003e     int64  \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;id\u0026quot;`\u003c/span\u003e\n        \u003cspan class=\"hljs-title class_\"\u003eName\u003c/span\u003e   string \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;name\u0026quot;`\u003c/span\u003e\n        \u003cspan class=\"hljs-title class_\"\u003eGender\u003c/span\u003e int64  \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;gender\u0026quot;`\u003c/span\u003e\n        \u003cspan class=\"hljs-title class_\"\u003eMobile\u003c/span\u003e string \u003cspan class=\"hljs-string\"\u003e`json:\u0026quot;mobile\u0026quot;`\u003c/span\u003e\n    }\n    \u003cspan class=\"hljs-comment\"\u003e// 用户信息\u003c/span\u003e\n)\n\nservice \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e {\n    @handler \u003cspan class=\"hljs-title class_\"\u003eLogin\u003c/span\u003e\n    post /api/user/login (\u003cspan class=\"hljs-title class_\"\u003eLoginRequest\u003c/span\u003e) returns (\u003cspan class=\"hljs-title class_\"\u003eLoginResponse\u003c/span\u003e)\n    \n    @handler \u003cspan class=\"hljs-title class_\"\u003eRegister\u003c/span\u003e\n    post /api/user/register (\u003cspan class=\"hljs-title class_\"\u003eRegisterRequest\u003c/span\u003e) returns (\u003cspan class=\"hljs-title class_\"\u003eRegisterResponse\u003c/span\u003e)\n}\n\n@\u003cspan class=\"hljs-title function_\"\u003eserver\u003c/span\u003e(\n    \u003cspan class=\"hljs-attr\"\u003ejwt\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eAuth\u003c/span\u003e\n)\nservice \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e {\n    @handler \u003cspan class=\"hljs-title class_\"\u003eUserInfo\u003c/span\u003e\n    post /api/user/userinfo () returns (\u003cspan class=\"hljs-title class_\"\u003eUserInfoResponse\u003c/span\u003e)\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003e容器文件自动生成\u003c/h2\u003e\n\u003cp\u003e创建Dockerfile, \u003ccode\u003egoctl docker -go hello.go\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003edocker build -t .... 创建镜像\u003c/p\u003e\n\u003ch2\u003ek8s服务文件自动生成\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003egoctl kube deploy -name redis -namespace adhoc -image redis:6-alpine -o redis.yaml -port 6379\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e这条命令的含义就是在adhoc命名空间中创建Deployment类型的资源，名字叫做redis，使用的镜像为\u003ccode\u003eredis:6-alpine\u003c/code\u003e, containerPort为6379\u003c/p\u003e\n\u003cp\u003e接下来是go-zero中如何解决上文所说的问题\u003c/p\u003e\n\u003ch2\u003e服务注册与发现\u003c/h2\u003e\n\u003cp\u003e部署etcd(这里为了简单仅部署单节点)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-string\"\u003edocker\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epull\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ebitnami/etcd:3.5.3\u003c/span\u003e\n\n\u003cspan class=\"hljs-string\"\u003edocker\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003erun\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-d\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-p\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2379\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:2379\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-p\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2380\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:2380\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e-e\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eETCD_ROOT_PASSWORD=123456\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e--name\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eetcd3\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ebitnami/etcd:3.5.3\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003ego-zero中配置(配置文件也是由上文的goctl自动生成的，执行一遍就知道了)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-string\"\u003e//\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e注册者\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eEtcd:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eHosts:\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:2379\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eKey:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003euser.rpc\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eUser:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eroot\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003ePass:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;123456\u0026quot;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e其中Key就是该服务注册到etcd中的名字\u003c/p\u003e\n\u003cp\u003e调用者,首先修改配置以及修改go中的结构体\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003eUserRpc:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eEtcd:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eHosts:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:2379\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eKey:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003euser.rpc\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eUser:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eroot\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ePass:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;123456\u0026quot;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cpre\u003e\u003ccode class=\"hljs language-go\"\u003e\u003cspan class=\"hljs-built_in\"\u003etype\u003c/span\u003e Config struct {\n    ...\n    UserRpc zrpc.RpcClientConf\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e然后将服务初始化到上下文中\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-go\"\u003etype ServiceContext \u003cspan class=\"hljs-keyword\"\u003estruct\u003c/span\u003e {\n    Config  config.Config\n    UserRpc user.User\n}\n\n\u003cspan class=\"hljs-function\"\u003efunc \u003cspan class=\"hljs-title\"\u003eNewServiceContext\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(c config.Config)\u003c/span\u003e *ServiceContext \u003c/span\u003e{\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u0026amp;ServiceContext{\n        Config:  c,\n        UserRpc: user.\u003cspan class=\"hljs-built_in\"\u003eNewUser\u003c/span\u003e(zrpc.\u003cspan class=\"hljs-built_in\"\u003eMustNewClient\u003c/span\u003e(c.UserRpc)),\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e之后就可以直接使用UserRpc进行rpc调用\u003c/p\u003e\n\u003ch2\u003e日志收集\u003c/h2\u003e\n\u003cp\u003e部署EFK架构，当然如果只是为了将日志集中起来方便查看，可以暂时需要elasticsearch+kibana\u003c/p\u003e\n\u003cp\u003e部署fluentd\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003edocker pull fluent/\u003cspan class=\"hljs-attr\"\u003efluentd\u003c/span\u003e:v1\u003cspan class=\"hljs-number\"\u003e.14\u003c/span\u003e-debian\n\ndocker run -d -p \u003cspan class=\"hljs-number\"\u003e24224\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e24224\u003c/span\u003e -v ${conf}:\u003cspan class=\"hljs-regexp\"\u003e/fluentd/\u003c/span\u003eetc/fluent.\u003cspan class=\"hljs-property\"\u003econf\u003c/span\u003e fluent/\u003cspan class=\"hljs-attr\"\u003efluentd\u003c/span\u003e:v1\u003cspan class=\"hljs-number\"\u003e.14\u003c/span\u003e-debian\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e示例配置文件\u003c/p\u003e\n\u003cp\u003e参考: \u003ca href=\"https://docs.fluentd.org/configuration/config-file\"\u003ehttps://docs.fluentd.org/configuration/config-file\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-conf\"\u003e\u003cspan class=\"hljs-string\"\u003e\u0026lt;source\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-string\"\u003e@type\u003c/span\u003e   \u003cspan class=\"hljs-string\"\u003eforward\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e\u0026lt;/source\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e\u0026lt;match\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e*\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-string\"\u003e@type\u003c/span\u003e              \u003cspan class=\"hljs-string\"\u003efile\u003c/span\u003e\n  \u003cspan class=\"hljs-string\"\u003epath\u003c/span\u003e               \u003cspan class=\"hljs-string\"\u003e/fluentd/log/${tag}\u003c/span\u003e\n  \u003cspan class=\"hljs-string\"\u003eappend\u003c/span\u003e             \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"hljs-string\"\u003e\u0026lt;format\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e@type\u003c/span\u003e            \u003cspan class=\"hljs-string\"\u003esingle_value\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003emessage_key\u003c/span\u003e      \u003cspan class=\"hljs-string\"\u003elog\u003c/span\u003e\n  \u003cspan class=\"hljs-string\"\u003e\u0026lt;/format\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-string\"\u003e\u0026lt;buffer\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003etag,time\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e@type\u003c/span\u003e             \u003cspan class=\"hljs-string\"\u003efile\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003etimekey\u003c/span\u003e           \u003cspan class=\"hljs-string\"\u003e1d\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003etimekey_wait\u003c/span\u003e      \u003cspan class=\"hljs-string\"\u003e10m\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eflush_mode\u003c/span\u003e        \u003cspan class=\"hljs-string\"\u003einterval\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eflush_interval\u003c/span\u003e    \u003cspan class=\"hljs-string\"\u003e30s\u003c/span\u003e\n  \u003cspan class=\"hljs-string\"\u003e\u0026lt;/buffer\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e\u0026lt;/match\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e将上传到flutend的操作封装进基础logger库的可选项以及包装成go-zero可使用的模式\u003c/p\u003e\n\u003cp\u003e参考: github.com/wwqdrh/logger\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-go\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e (\n    mylogx \u003cspan class=\"hljs-string\"\u003e\u0026quot;github.com/wwqdrh/logger/logx\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;github.com/zeromicro/go-zero/core/conf\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;github.com/zeromicro/go-zero/core/logx\u0026quot;\u003c/span\u003e\n)\n\nfunc \u003cspan class=\"hljs-title function_\"\u003einit\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n    l := logger.\u003cspan class=\"hljs-title class_\"\u003eNewLogger\u003c/span\u003e(\n        logger.\u003cspan class=\"hljs-title class_\"\u003eWithLevel\u003c/span\u003e(zapcore.\u003cspan class=\"hljs-property\"\u003eWarnLevel\u003c/span\u003e),\n        logger.\u003cspan class=\"hljs-title class_\"\u003eWithLogPath\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;./logs/info.log\u0026quot;\u003c/span\u003e),\n        logger.\u003cspan class=\"hljs-title class_\"\u003eWithName\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;info\u0026quot;\u003c/span\u003e),\n        logger.\u003cspan class=\"hljs-title class_\"\u003eWithFluentd\u003c/span\u003e(\u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;127.0.0.1\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e24224\u003c/span\u003e),\n        logger.\u003cspan class=\"hljs-title class_\"\u003eWithConsole\u003c/span\u003e(\u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e),\n    )\n\n    writer, _ := mylogx.\u003cspan class=\"hljs-title class_\"\u003eNewZeroWriter\u003c/span\u003e(l)\n    logx.\u003cspan class=\"hljs-title class_\"\u003eMust\u003c/span\u003e(err)\n    logx.\u003cspan class=\"hljs-title class_\"\u003eSetWriter\u003c/span\u003e(writer)\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e之后使用logx.Infof就可以将日志上传至服务中, 所有的服务的日志就已经收集到了flutend容器中\u003c/p\u003e\n\u003ch2\u003e链路追踪\u003c/h2\u003e\n\u003cp\u003ego-zero已经封装了，仅需部署jaeger之后修改服务的配置项进行启用\u003c/p\u003e\n\u003cp\u003e部署jaeger\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-string\"\u003edocker\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003epull\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ejaegertracing/all-in-one:1.34\u003c/span\u003e\n\n\u003cspan class=\"hljs-string\"\u003edocker\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003erun\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-d\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e--name\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ejaeger\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e-e\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eCOLLECTOR_ZIPKIN_HTTP_PORT=9411\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e-p\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e5775\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:5775/udp\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e-p\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e6831\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:6831/udp\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e-p\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e6832\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:6832/udp\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e-p\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e5778\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:5778\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e-p\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e16686\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:16686\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e-p\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e14268\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:14268\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e-p\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e9411\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:9411\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\\\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003ejaegertracing/all-in-one:1.34\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e修改配置\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003eTelemetry:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eName:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003euser.api\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eEndpoint:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ehttp://127.0.0.1:14268/api/traces\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eSampler:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1.0\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eBatcher:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ejaeger\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e效果\u003c/p\u003e\n\u003cimg src=\"/images/blogs/jaeger-1.png\" /\u003e\n\n\u003cimg src=\"/images/blogs/jaeger-2.png\" /\u003e\n\n\u003ch2\u003e服务监控\u003c/h2\u003e\n\u003cp\u003ego-zero已经集成\u003c/p\u003e\n\u003cp\u003e部署prometheus\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003edocker pull bitnami/\u003cspan class=\"hljs-attr\"\u003eprometheus\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e2.9\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.2\u003c/span\u003e\n\ndocker run --name prometheus \\\n-v ${\u003cspan class=\"hljs-variable constant_\"\u003eCURDIR\u003c/span\u003e}\u003cspan class=\"hljs-string\"\u003e\u0026quot;/env/prometheus/prometheus.yml\u0026quot;\u003c/span\u003e:\u003cspan class=\"hljs-regexp\"\u003e/opt/\u003c/span\u003ebitnami/prometheus/data \\\n-p \u003cspan class=\"hljs-number\"\u003e9090\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e9090\u003c/span\u003e \\\n    bitnami/\u003cspan class=\"hljs-attr\"\u003eprometheus\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e2.9\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.2\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e进行配置\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-attr\"\u003ePrometheus:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eHost:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003ePort:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e9081\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003ePath:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e/metrics\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e修改prometheus监听的服务配置（上文的prometheus.yml）\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-comment\"\u003e# my global config\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eglobal:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003escrape_interval:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e15s\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e# Set the scrape interval to every 15 seconds. Default is every 1 minute. \u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eevaluation_interval:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e15s\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e# Evaluate rules every 15 seconds. The default is every 1 minute.     \u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e# scrape_timeout is set to the global default (10s).\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# Alertmanager configuration\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003ealerting:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003ealertmanagers:\u003c/span\u003e\n    \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003estatic_configs:\u003c/span\u003e\n        \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etargets:\u003c/span\u003e\n          \u003cspan class=\"hljs-comment\"\u003e# - alertmanager:9093\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# Load rules once and periodically evaluate them according to the global \u0026#x27;evaluation_interval\u0026#x27;.  \u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003erule_files:\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e# - \u0026quot;first_rules.yml\u0026quot;\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e# - \u0026quot;second_rules.yml\u0026quot;\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# A scrape configuration containing exactly one endpoint to scrape:\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# Here it\u0026#x27;s Prometheus itself.\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003escrape_configs:\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e# The job name is added as a label `job=\u0026lt;job_name\u0026gt;` to any timeseries scraped from this config.\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ejob_name:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;prometheus\u0026quot;\u003c/span\u003e\n\n    \u003cspan class=\"hljs-comment\"\u003e# metrics_path defaults to \u0026#x27;/metrics\u0026#x27;\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e# scheme defaults to \u0026#x27;http\u0026#x27;.\u003c/span\u003e\n\n    \u003cspan class=\"hljs-attr\"\u003estatic_configs:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etargets:\u003c/span\u003e [\u003cspan class=\"hljs-string\"\u003e\u0026quot;localhost:9090\u0026quot;\u003c/span\u003e]\n\n  \u003cspan class=\"hljs-comment\"\u003e# 我们自己的商城项目配置\u003c/span\u003e\n  \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ejob_name:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;mall\u0026#x27;\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003estatic_configs:\u003c/span\u003e\n      \u003cspan class=\"hljs-comment\"\u003e# 目标的采集地址\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etargets:\u003c/span\u003e [\u003cspan class=\"hljs-string\"\u003e\u0026#x27;192.168.110.113:9081\u0026#x27;\u003c/span\u003e]\n        \u003cspan class=\"hljs-attr\"\u003elabels:\u003c/span\u003e\n          \u003cspan class=\"hljs-comment\"\u003e# 自定义标签\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eapp:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;user-api\u0026#x27;\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eenv:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;test\u0026#x27;\u003c/span\u003e\n\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etargets:\u003c/span\u003e [\u003cspan class=\"hljs-string\"\u003e\u0026#x27;192.168.110.113:9091\u0026#x27;\u003c/span\u003e]\n        \u003cspan class=\"hljs-attr\"\u003elabels:\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eapp:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;user-rpc\u0026#x27;\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eenv:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;test\u0026#x27;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e效果\u003c/p\u003e\n\u003cimg src=\"/images/blogs/prometheus-1.png\" /\u003e\n\n\u003ch2\u003e分布式事务\u003c/h2\u003e\n\u003cp\u003e使用dtm\u003c/p\u003e\n\u003cp\u003e比较大的部分，详细文档查看: \u003ca href=\"https://go-zero.dev/cn/docs/eco/distributed-transaction\"\u003ehttps://go-zero.dev/cn/docs/eco/distributed-transaction\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003e服务治理\u003c/h2\u003e\n\u003cp\u003e熔断器使用文档: \u003ca href=\"https://go-zero.dev/cn/docs/blog/governance/breaker-algorithms\"\u003ehttps://go-zero.dev/cn/docs/blog/governance/breaker-algorithms\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e自适应降级文档: \u003ca href=\"https://go-zero.dev/cn/docs/blog/governance/loadshedding\"\u003ehttps://go-zero.dev/cn/docs/blog/governance/loadshedding\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e限流文档: \u003ca href=\"https://go-zero.dev/cn/docs/blog/governance/periodlimit\"\u003ehttps://go-zero.dev/cn/docs/blog/governance/periodlimit\u003c/a\u003e\u003c/p\u003e\n","frontMatter":{"readingTime":{"text":"11 min read","minutes":10.98,"time":658800,"words":2196},"slug":"go-zero微服务实践","fileName":"go-zero微服务实践.md","title":"go-zero微服务实践","date":"2022-06-20T00:00:00.000Z","tags":["实践","云原生"],"draft":false,"summary":"微服务简介以及go-zero如何落地"}},"prev":{"title":"tekton使用示例","date":"2022-06-06T00:00:00.000Z","tags":["中间件"],"draft":false,"summary":"缓存一致性的解决方法与思路","slug":"缓存一致性问题"},"next":{"title":"golang工程化纵览","date":"2022-07-03T00:00:00.000Z","tags":["Golang"],"draft":false,"summary":"golang工程化所用到的工具概览","slug":"golang工程化总览"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["go-zero微服务实践"]},"buildId":"qwylQn0rAYfx_DG8FLkaO","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>