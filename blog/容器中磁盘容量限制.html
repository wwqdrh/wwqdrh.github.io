<!DOCTYPE html><html lang="zh-CN"><head><meta name="viewport" content="width=device-width"/><title>容器中磁盘容量限制实践</title><meta name="robots" content="follow, index"/><meta charSet="UTF-8"/><meta name="description" content="容器中磁盘容量限制实践"/><meta property="og:type"/><meta property="og:title" content="容器中磁盘容量限制实践"/><meta property="og:description" content="容器中磁盘容量限制实践"/><meta property="og:url" content="https://wwqdrh.github.io/undefined"/><meta name="keywords" content="wwqdrh技术博客"/><meta property="og:locale" content="zh-CN"/><meta property="og:image" content="https://wwqdrh.github.io"/><meta name="twitter:title" content="容器中磁盘容量限制实践"/><meta name="twitter:description" content="容器中磁盘容量限制实践"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="https://wwqdrh.github.io"/><link rel="stylesheet" href="/assets/mdrender/editor-render.css"/><meta name="next-head-count" content="17"/><link rel="icon" href="/favicon.ico"/><link rel="apple-touch-icon" sizes="192x192" href="/apple-touch-icon.png"/><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/feed"/><script src="/assets/analizy/clarity.js"></script><link rel="preload" href="/_next/static/media/d83e92f0af8b17e4-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/ed42d1b51efd45f6-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/fba9d678ff638e59-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/e52907b750a6f61e-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/9031250013752d4b-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/eb9adf802b0a60eb-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/81b352a4d7a000ae-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/41b9b3ece820718f-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/d587d1c112526568-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/css/869c7de7c781f904.css" as="style"/><link rel="stylesheet" href="/_next/static/css/869c7de7c781f904.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-fbe37f60a09a330b.js" defer=""></script><script src="/_next/static/chunks/main-082d90b1269d95f6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-494ee9c4b0594b31.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-222bf60d0a2bf3df.js" defer=""></script><script src="/_next/static/xycpTPo5G1XEQLx5GlDdu/_buildManifest.js" defer=""></script><script src="/_next/static/xycpTPo5G1XEQLx5GlDdu/_ssgManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css-global c86wz">body{margin:0;padding:0;color:hsl(0, 0%, 9.0%);background-color:hsl(0, 0%, 97.3%);font-family:'__pretendard_6bb8e5','__pretendard_Fallback_6bb8e5';}*{-webkit-print-color-scheme:light;color-scheme:light;box-sizing:border-box;}h1,h2,h3,h4,h5,h6{margin:0;font-weight:inherit;font-style:inherit;}a{all:unset;cursor:pointer;}ul{padding:0;}button{all:unset;cursor:pointer;}input{all:unset;box-sizing:border-box;}textarea{border:none;background-color:transparent;font-family:inherit;padding:0;outline:none;resize:none;color:inherit;}hr{width:100%;border:none;margin:0;border-top:1px solid hsl(0, 0%, 88.7%);}</style><style data-emotion="css 1q70a33">.css-1q70a33{z-index:30;position:-webkit-sticky;position:sticky;top:0;background-color:hsl(0, 0%, 97.3%);box-shadow:0 1px 2px 0 rgba(0, 0, 0, 0.05);}.css-1q70a33 .container{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:100%;height:3rem;margin:0 auto;}@media (min-width: 768px){.css-1q70a33 .container[data-full-width="true"]{padding-left:6rem;padding-right:6rem;}}.css-1q70a33 .container .nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;gap:0.75rem;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-1q70a33 .container .mid{padding-top:0.5rem;padding-bottom:0.5rem;padding-left:1.25rem;padding-right:1.25rem;border-radius:1rem;outline-style:none;width:50%;background-color:hsl(0, 0%, 93.0%);}</style><div class="py-2 css-1q70a33"><div data-full-width="false" class="container"><a aria-label="wwqdrh" class="css-0" href="/">wwqdrh</a><input class="mid" type="text" placeholder="Search Keyword..." value=""/><div class="nav"><style data-emotion="css 1nw6zn9">.css-1nw6zn9{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}.css-1nw6zn9 ul{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}.css-1nw6zn9 ul li{display:block;margin-left:1rem;color:hsl(0, 0%, 43.5%);}</style><div class="css-1nw6zn9"><ul><li><a target="_blank" href="https://space.bilibili.com/538676331">B站</a></li></ul></div><style data-emotion="css 1h5x3dy">.css-1h5x3dy{cursor:pointer;}</style><div class="css-1h5x3dy"><style data-emotion="css p95608">.css-p95608{font-family:'__Noto_Color_Emoji_be1378','__Noto_Color_Emoji_Fallback_be1378',Apple Color Emoji;font-weight:400;font-style:normal;}</style><span class="css-p95608">☀️</span></div></div></div></div><style data-emotion="css lomkhl">.css-lomkhl{margin:0 auto;width:100%;padding:0 3rem;}</style><main class="css-lomkhl"><div class="divide-y bg-white dark:bg-gray-700 p-6 shadow-lg rounded-lg mt-3 divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="max-w-none pt-10 pb-8 prose dark:prose-dark"><div><h1>背景</h1>
<p>容器与宿主机共享磁盘空间，如果不做容量限制，会存在写满宿主机的可能</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># 下面的就是在容器中查看到的，实际的空间量就是宿主机上的</span>
$ df -h
Filesystem      Size  Used Avail Use% Mounted on
overlay          49G   22G   25G  <span class="hljs-number">47</span>% /
</code></pre><p>overlay文件系统中并没有直接限制磁盘quota的功能</p>
<p>当使用docker时限制的操作，也就是用 XFS Quota 来限制容器的 OverlayFS 大小，限制upperdir的目录大小</p>
<blockquote>
<p>swarm模式下不支持限制容器的磁盘quota(或者暂时不知道🤔</p>
</blockquote>
<pre><code class="hljs language-bash"><span class="hljs-comment"># docker模式下</span>
$docker run -it --rm --storage-opt size=10M ubuntu:<span class="hljs-number">22.10</span> bash
docker: Error response <span class="hljs-keyword">from</span> daemon: --storage-opt <span class="hljs-keyword">is</span> supported only <span class="hljs-keyword">for</span> overlay over xfs <span class="hljs-keyword">with</span> <span class="hljs-string">&#x27;pquota&#x27;</span> mount option.
</code></pre><p>查看docker源码中会发现使用了xfs的project机制,下面是核心代码</p>
<pre><code class="hljs language-go"><span class="hljs-comment">// moby/quota/projectquota.go</span>
<span class="hljs-comment">// setProjectQuota - set the quota for project id on xfs block device</span>
<span class="hljs-function">func <span class="hljs-title">setProjectQuota</span><span class="hljs-params">(backingFsBlockDev string, projectID uint32, quota Quota)</span> error </span>{
    var d C.<span class="hljs-type">fs_disk_quota_t</span>
    d.d_version = C.FS_DQUOT_VERSION
    d.d_id = C.__u32(projectID)
    d.d_flags = C.XFS_PROJ_QUOTA

    d.d_fieldmask = C.FS_DQ_BHARD | C.FS_DQ_BSOFT
    d.d_blk_hardlimit = C.__u64(quota.Size / <span class="hljs-number">512</span>)
    d.d_blk_softlimit = d.d_blk_hardlimit

    var cs = C.<span class="hljs-built_in">CString</span>(backingFsBlockDev)
    defer C.<span class="hljs-built_in">free</span>(unsafe.<span class="hljs-built_in">Pointer</span>(cs))

    _, _, errno := unix.<span class="hljs-built_in">Syscall6</span>(unix.SYS_QUOTACTL, C.Q_XSETPQLIM,
        <span class="hljs-built_in">uintptr</span>(unsafe.<span class="hljs-built_in">Pointer</span>(cs)), <span class="hljs-built_in">uintptr</span>(d.d_id),
        <span class="hljs-built_in">uintptr</span>(unsafe.<span class="hljs-built_in">Pointer</span>(&amp;d)), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    <span class="hljs-keyword">if</span> errno != <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> errors.<span class="hljs-built_in">Wrapf</span>(errno, <span class="hljs-string">&quot;failed to set quota limit for projid %d on %s&quot;</span>,
            projectID, backingFsBlockDev)
    }

    <span class="hljs-keyword">return</span> nil
}
</code></pre><h1>docker环境下实验</h1>
<p>前面看到不做特殊处理的docker是无法使用磁盘quota限制的</p>
<pre><code class="hljs language-bash"><span class="hljs-string">$</span> <span class="hljs-string">docker</span> <span class="hljs-string">info</span>
<span class="hljs-string">...</span>
<span class="hljs-attr">Storage Driver:</span> <span class="hljs-string">overlay2</span>
  <span class="hljs-attr">Backing Filesystem:</span> <span class="hljs-string">extfs</span>
  <span class="hljs-attr">Supports d_type:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">Native Overlay Diff:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">userxattr:</span> <span class="hljs-literal">false</span>
<span class="hljs-string">...</span>
</code></pre><p>目前后端的文件系统是extfs，需要切换至xfs</p>
<pre><code class="hljs language-bash">$ docker info | grep <span class="hljs-string">&quot;Docker Root Dir&quot;</span>
<span class="hljs-title class_">Docker</span> <span class="hljs-title class_">Root</span> <span class="hljs-title class_">Dir</span>: <span class="hljs-regexp">/var/</span>lib/docker

$ df -T -h /<span class="hljs-keyword">var</span>/lib/docker
<span class="hljs-title class_">Filesystem</span>     <span class="hljs-title class_">Type</span>  <span class="hljs-title class_">Size</span>  <span class="hljs-title class_">Used</span> <span class="hljs-title class_">Avail</span> <span class="hljs-title class_">Use</span>% <span class="hljs-title class_">Mounted</span> on
/dev/sda3      ext4   49G   22G   25G  <span class="hljs-number">47</span>% /
</code></pre><blockquote>
<p>蚌埠住了, docker直接安装在的根目录，文件系统是ext4，也就是必须重新安装docker在xfs文件系统的挂载点上</p>
</blockquote>
<h1>在xfs文件系统上实验</h1>
<p>实验一下手动限制</p>
<p>要使用 XFS Quota 特性，必须在文件系统挂载的时候加上对应的 Quota 选项，比如需要配置 Project Quota，那么这个挂载参数就是&quot;pquota&quot;。</p>
<blockquote>
<p>对于根目录来说，这个参数必须作为一个内核启动的参数&quot;rootflags=pquota&quot;，这样设置就可以保证根目录在启动挂载的时候，带上 XFS Quota 的特性并且支持 Project 模式。</p>
</blockquote>
<p>由于我的根目录是ext4文件格式，所以新创建一个分区，格式化为xfs系统，并且配置为project quota</p>
<blockquote>
<p>This disk is currently in use - repartitioning is probably a bad idea.
It&#39;s recommended to umount all file systems, and swapoff all swap
partitions on this disk.
为正在使用的磁盘建立分区不是一个好主意，要么新建一个磁盘，我这里由于使用的是虚拟机，就用虚拟机添加一块硬盘</p>
</blockquote>
<pre><code class="hljs language-bash">$ sudo apt-get install xfsprogs  <span class="hljs-comment"># xfs文件系统相关工具集</span>

$ fdisk -l

$ fdisk /dev/sdb
Command (m <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>): n     &lt;- 新建分区
Command action              &lt;- 选择要创建的分区类型
   e   extended &lt;- 扩展分区
   p   primary partition (<span class="hljs-number">1</span>-<span class="hljs-number">4</span>) &lt;- 主分区
p &lt;- 输入建立主分区
Partition number (<span class="hljs-number">1</span>-<span class="hljs-number">4</span>):<span class="hljs-number">1</span>    &lt;- 分区编号
First sector (<span class="hljs-number">2048</span>-<span class="hljs-number">20971519</span>, default <span class="hljs-number">2048</span>): &lt;- 直接回车默认
Last sector, +/-sectors <span class="hljs-keyword">or</span> +/-size{K,M,G,T,P} (<span class="hljs-number">2048</span>-<span class="hljs-number">20971519</span>, default <span class="hljs-number">20971519</span>):     +1G  &lt;-分区大小
Command (m <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>): w     &lt;- 保存分区表, 完毕会退出fdisk命令
The partition table has been altered!

Calling ioctl() to re-read partition table.
Syncing disks.

$ fdisk /dev/sdb <span class="hljs-comment"># 查看分区是否创建成功</span>
Command (m <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>): p     &lt;- 打印当前磁盘的分区信息
...
Device     Boot Start     End Sectors Size Id <span class="hljs-type">Type</span>
/dev/sdb1        <span class="hljs-number">2048</span> <span class="hljs-number">2099199</span> <span class="hljs-number">2097152</span>   1G <span class="hljs-number">83</span> Linux
...

$ mkfs.xfs /dev/sdb1 <span class="hljs-comment"># 为分区格式化文件系统, 如果出现`The device apparently does not exist; did you specify it correctly?`,需要重启系统然后格式化</span>
</code></pre><p>挂载分区，要使用Project Quota 功能，需要在挂载时指定<code>-o prjquota</code>参数，并且这个参数还不能和usrquota、grpquota一起使用，也就是说，如果开启Project Quota就无法使用针对用户和用户组的配额限制。</p>
<pre><code class="hljs language-bash">$ rm -rf /xfstest &amp;&amp; mkdir /xfstest &amp;&amp; mount -o prjquota /dev/sdb1 /xfstest

$ rm -rf /xfstest &amp;&amp; mkdir /xfstest &amp;&amp; mount -o pquota /dev/sdb1 /xfstest

$ df -lhT
Filesystem     <span class="hljs-type">Type</span>     Size  Used Avail Use% Mounted on
...
/dev/sdb1      xfs     1014M   40M  975M   <span class="hljs-number">4</span>% /xfstest

$ cat /proc/mounts | grep prjquota <span class="hljs-comment"># 检验是否生效</span>
/dev/sdb1 /xfstest xfs rw,relatime,attr2,inode64,logbufs=<span class="hljs-number">8</span>,logbsize=32k,prjquota <span class="hljs-number">0</span> <span class="hljs-number">0</span>
</code></pre><p>给一个指定的目录打上一个 Project ID，对打好project id的做上资源限制</p>
<pre><code class="hljs language-bash">$ mkdir -p /xfstest/xfs_prjquota 

$ xfs_quota -x -c <span class="hljs-string">&#x27;project -s -p /xfstest/xfs_prjquota 1&#x27;</span> <span class="hljs-comment"># 为文件夹分配ProjectID 1</span>

$ xfs_quota -x -c <span class="hljs-string">&#x27;limit -p bhard=10m 1&#x27;</span> /xfstest  <span class="hljs-comment"># 后面的/xfstest就是这个xfs文件系统的挂载点</span>
</code></pre><p>实验一下能否完成资源限制</p>
<pre><code class="hljs language-bash">$ dd <span class="hljs-keyword">if</span>=/dev/zero of=/xfstest/xfs_prjquota/test.file bs=<span class="hljs-number">1024</span> count=<span class="hljs-number">20000</span>  <span class="hljs-comment"># 20000个1024大小的区块，20m</span>
dd: error writing <span class="hljs-string">&#x27;/xfstest/xfs_prjquota/test.file&#x27;</span>: No space left on device
<span class="hljs-number">10241</span>+<span class="hljs-number">0</span> records <span class="hljs-keyword">in</span>
<span class="hljs-number">10240</span>+<span class="hljs-number">0</span> records out
<span class="hljs-number">10485760</span> <span class="hljs-built_in">bytes</span> (<span class="hljs-number">10</span> MB, <span class="hljs-number">10</span> MiB) copied, <span class="hljs-number">0.0514849</span> s, <span class="hljs-number">204</span> MB/s

$ du -h /xfstest
10M	/xfstest/xfs_prjquota
10M	/xfstest
</code></pre><p>实验成功</p>
<blockquote>
<p>docker部分重新安装那代价有点大，下次有空再试😂</p>
</blockquote>
</div></div></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"\u003ch1\u003e背景\u003c/h1\u003e\n\u003cp\u003e容器与宿主机共享磁盘空间，如果不做容量限制，会存在写满宿主机的可能\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-comment\"\u003e# 下面的就是在容器中查看到的，实际的空间量就是宿主机上的\u003c/span\u003e\n$ df -h\nFilesystem      Size  Used Avail Use% Mounted on\noverlay          49G   22G   25G  \u003cspan class=\"hljs-number\"\u003e47\u003c/span\u003e% /\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eoverlay文件系统中并没有直接限制磁盘quota的功能\u003c/p\u003e\n\u003cp\u003e当使用docker时限制的操作，也就是用 XFS Quota 来限制容器的 OverlayFS 大小，限制upperdir的目录大小\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eswarm模式下不支持限制容器的磁盘quota(或者暂时不知道🤔\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-comment\"\u003e# docker模式下\u003c/span\u003e\n$docker run -it --rm --storage-opt size=10M ubuntu:\u003cspan class=\"hljs-number\"\u003e22.10\u003c/span\u003e bash\ndocker: Error response \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e daemon: --storage-opt \u003cspan class=\"hljs-keyword\"\u003eis\u003c/span\u003e supported only \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e overlay over xfs \u003cspan class=\"hljs-keyword\"\u003ewith\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;pquota\u0026#x27;\u003c/span\u003e mount option.\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e查看docker源码中会发现使用了xfs的project机制,下面是核心代码\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-go\"\u003e\u003cspan class=\"hljs-comment\"\u003e// moby/quota/projectquota.go\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e// setProjectQuota - set the quota for project id on xfs block device\u003c/span\u003e\n\u003cspan class=\"hljs-function\"\u003efunc \u003cspan class=\"hljs-title\"\u003esetProjectQuota\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(backingFsBlockDev string, projectID uint32, quota Quota)\u003c/span\u003e error \u003c/span\u003e{\n    var d C.\u003cspan class=\"hljs-type\"\u003efs_disk_quota_t\u003c/span\u003e\n    d.d_version = C.FS_DQUOT_VERSION\n    d.d_id = C.__u32(projectID)\n    d.d_flags = C.XFS_PROJ_QUOTA\n\n    d.d_fieldmask = C.FS_DQ_BHARD | C.FS_DQ_BSOFT\n    d.d_blk_hardlimit = C.__u64(quota.Size / \u003cspan class=\"hljs-number\"\u003e512\u003c/span\u003e)\n    d.d_blk_softlimit = d.d_blk_hardlimit\n\n    var cs = C.\u003cspan class=\"hljs-built_in\"\u003eCString\u003c/span\u003e(backingFsBlockDev)\n    defer C.\u003cspan class=\"hljs-built_in\"\u003efree\u003c/span\u003e(unsafe.\u003cspan class=\"hljs-built_in\"\u003ePointer\u003c/span\u003e(cs))\n\n    _, _, errno := unix.\u003cspan class=\"hljs-built_in\"\u003eSyscall6\u003c/span\u003e(unix.SYS_QUOTACTL, C.Q_XSETPQLIM,\n        \u003cspan class=\"hljs-built_in\"\u003euintptr\u003c/span\u003e(unsafe.\u003cspan class=\"hljs-built_in\"\u003ePointer\u003c/span\u003e(cs)), \u003cspan class=\"hljs-built_in\"\u003euintptr\u003c/span\u003e(d.d_id),\n        \u003cspan class=\"hljs-built_in\"\u003euintptr\u003c/span\u003e(unsafe.\u003cspan class=\"hljs-built_in\"\u003ePointer\u003c/span\u003e(\u0026amp;d)), \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e errno != \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e errors.\u003cspan class=\"hljs-built_in\"\u003eWrapf\u003c/span\u003e(errno, \u003cspan class=\"hljs-string\"\u003e\u0026quot;failed to set quota limit for projid %d on %s\u0026quot;\u003c/span\u003e,\n            projectID, backingFsBlockDev)\n    }\n\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e nil\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch1\u003edocker环境下实验\u003c/h1\u003e\n\u003cp\u003e前面看到不做特殊处理的docker是无法使用磁盘quota限制的\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-string\"\u003e$\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edocker\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003einfo\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e...\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eStorage Driver:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eoverlay2\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eBacking Filesystem:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eextfs\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eSupports d_type:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eNative Overlay Diff:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003euserxattr:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e目前后端的文件系统是extfs，需要切换至xfs\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e$ docker info | grep \u003cspan class=\"hljs-string\"\u003e\u0026quot;Docker Root Dir\u0026quot;\u003c/span\u003e\n\u003cspan class=\"hljs-title class_\"\u003eDocker\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRoot\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDir\u003c/span\u003e: \u003cspan class=\"hljs-regexp\"\u003e/var/\u003c/span\u003elib/docker\n\n$ df -T -h /\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e/lib/docker\n\u003cspan class=\"hljs-title class_\"\u003eFilesystem\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eType\u003c/span\u003e  \u003cspan class=\"hljs-title class_\"\u003eSize\u003c/span\u003e  \u003cspan class=\"hljs-title class_\"\u003eUsed\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eAvail\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUse\u003c/span\u003e% \u003cspan class=\"hljs-title class_\"\u003eMounted\u003c/span\u003e on\n/dev/sda3      ext4   49G   22G   25G  \u003cspan class=\"hljs-number\"\u003e47\u003c/span\u003e% /\n\u003c/code\u003e\u003c/pre\u003e\u003cblockquote\u003e\n\u003cp\u003e蚌埠住了, docker直接安装在的根目录，文件系统是ext4，也就是必须重新安装docker在xfs文件系统的挂载点上\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch1\u003e在xfs文件系统上实验\u003c/h1\u003e\n\u003cp\u003e实验一下手动限制\u003c/p\u003e\n\u003cp\u003e要使用 XFS Quota 特性，必须在文件系统挂载的时候加上对应的 Quota 选项，比如需要配置 Project Quota，那么这个挂载参数就是\u0026quot;pquota\u0026quot;。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e对于根目录来说，这个参数必须作为一个内核启动的参数\u0026quot;rootflags=pquota\u0026quot;，这样设置就可以保证根目录在启动挂载的时候，带上 XFS Quota 的特性并且支持 Project 模式。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e由于我的根目录是ext4文件格式，所以新创建一个分区，格式化为xfs系统，并且配置为project quota\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eThis disk is currently in use - repartitioning is probably a bad idea.\nIt\u0026#39;s recommended to umount all file systems, and swapoff all swap\npartitions on this disk.\n为正在使用的磁盘建立分区不是一个好主意，要么新建一个磁盘，我这里由于使用的是虚拟机，就用虚拟机添加一块硬盘\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e$ sudo apt-get install xfsprogs  \u003cspan class=\"hljs-comment\"\u003e# xfs文件系统相关工具集\u003c/span\u003e\n\n$ fdisk -l\n\n$ fdisk /dev/sdb\nCommand (m \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003ehelp\u003c/span\u003e): n     \u0026lt;- 新建分区\nCommand action              \u0026lt;- 选择要创建的分区类型\n   e   extended \u0026lt;- 扩展分区\n   p   primary partition (\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e) \u0026lt;- 主分区\np \u0026lt;- 输入建立主分区\nPartition number (\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e):\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e    \u0026lt;- 分区编号\nFirst sector (\u003cspan class=\"hljs-number\"\u003e2048\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e20971519\u003c/span\u003e, default \u003cspan class=\"hljs-number\"\u003e2048\u003c/span\u003e): \u0026lt;- 直接回车默认\nLast sector, +/-sectors \u003cspan class=\"hljs-keyword\"\u003eor\u003c/span\u003e +/-size{K,M,G,T,P} (\u003cspan class=\"hljs-number\"\u003e2048\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e20971519\u003c/span\u003e, default \u003cspan class=\"hljs-number\"\u003e20971519\u003c/span\u003e):     +1G  \u0026lt;-分区大小\nCommand (m \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003ehelp\u003c/span\u003e): w     \u0026lt;- 保存分区表, 完毕会退出fdisk命令\nThe partition table has been altered!\n\nCalling ioctl() to re-read partition table.\nSyncing disks.\n\n$ fdisk /dev/sdb \u003cspan class=\"hljs-comment\"\u003e# 查看分区是否创建成功\u003c/span\u003e\nCommand (m \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003ehelp\u003c/span\u003e): p     \u0026lt;- 打印当前磁盘的分区信息\n...\nDevice     Boot Start     End Sectors Size Id \u003cspan class=\"hljs-type\"\u003eType\u003c/span\u003e\n/dev/sdb1        \u003cspan class=\"hljs-number\"\u003e2048\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2099199\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2097152\u003c/span\u003e   1G \u003cspan class=\"hljs-number\"\u003e83\u003c/span\u003e Linux\n...\n\n$ mkfs.xfs /dev/sdb1 \u003cspan class=\"hljs-comment\"\u003e# 为分区格式化文件系统, 如果出现`The device apparently does not exist; did you specify it correctly?`,需要重启系统然后格式化\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e挂载分区，要使用Project Quota 功能，需要在挂载时指定\u003ccode\u003e-o prjquota\u003c/code\u003e参数，并且这个参数还不能和usrquota、grpquota一起使用，也就是说，如果开启Project Quota就无法使用针对用户和用户组的配额限制。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e$ rm -rf /xfstest \u0026amp;\u0026amp; mkdir /xfstest \u0026amp;\u0026amp; mount -o prjquota /dev/sdb1 /xfstest\n\n$ rm -rf /xfstest \u0026amp;\u0026amp; mkdir /xfstest \u0026amp;\u0026amp; mount -o pquota /dev/sdb1 /xfstest\n\n$ df -lhT\nFilesystem     \u003cspan class=\"hljs-type\"\u003eType\u003c/span\u003e     Size  Used Avail Use% Mounted on\n...\n/dev/sdb1      xfs     1014M   40M  975M   \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e% /xfstest\n\n$ cat /proc/mounts | grep prjquota \u003cspan class=\"hljs-comment\"\u003e# 检验是否生效\u003c/span\u003e\n/dev/sdb1 /xfstest xfs rw,relatime,attr2,inode64,logbufs=\u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e,logbsize=32k,prjquota \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e给一个指定的目录打上一个 Project ID，对打好project id的做上资源限制\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e$ mkdir -p /xfstest/xfs_prjquota \n\n$ xfs_quota -x -c \u003cspan class=\"hljs-string\"\u003e\u0026#x27;project -s -p /xfstest/xfs_prjquota 1\u0026#x27;\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e# 为文件夹分配ProjectID 1\u003c/span\u003e\n\n$ xfs_quota -x -c \u003cspan class=\"hljs-string\"\u003e\u0026#x27;limit -p bhard=10m 1\u0026#x27;\u003c/span\u003e /xfstest  \u003cspan class=\"hljs-comment\"\u003e# 后面的/xfstest就是这个xfs文件系统的挂载点\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e实验一下能否完成资源限制\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e$ dd \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e=/dev/zero of=/xfstest/xfs_prjquota/test.file bs=\u003cspan class=\"hljs-number\"\u003e1024\u003c/span\u003e count=\u003cspan class=\"hljs-number\"\u003e20000\u003c/span\u003e  \u003cspan class=\"hljs-comment\"\u003e# 20000个1024大小的区块，20m\u003c/span\u003e\ndd: error writing \u003cspan class=\"hljs-string\"\u003e\u0026#x27;/xfstest/xfs_prjquota/test.file\u0026#x27;\u003c/span\u003e: No space left on device\n\u003cspan class=\"hljs-number\"\u003e10241\u003c/span\u003e+\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e records \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e\n\u003cspan class=\"hljs-number\"\u003e10240\u003c/span\u003e+\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e records out\n\u003cspan class=\"hljs-number\"\u003e10485760\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003ebytes\u003c/span\u003e (\u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e MB, \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e MiB) copied, \u003cspan class=\"hljs-number\"\u003e0.0514849\u003c/span\u003e s, \u003cspan class=\"hljs-number\"\u003e204\u003c/span\u003e MB/s\n\n$ du -h /xfstest\n10M\t/xfstest/xfs_prjquota\n10M\t/xfstest\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e实验成功\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003edocker部分重新安装那代价有点大，下次有空再试😂\u003c/p\u003e\n\u003c/blockquote\u003e\n","frontMatter":{"readingTime":{"text":"7 min read","minutes":6.87,"time":412200,"words":1374},"slug":"容器中磁盘容量限制","fileName":"容器中磁盘容量限制.md","title":"容器中磁盘容量限制实践","date":"2022-11-02T00:00:00.000Z","tags":["实践"],"draft":false,"summary":"容器中磁盘容量限制实践"}},"prev":{"title":"overlay文件系统","date":"2022-11-01T00:00:00.000Z","tags":["实践"],"draft":false,"summary":"overlay文件系统实践，探索容器原理","slug":"overlay文件系统实验"},"next":{"title":"什么是进程","date":"2023-02-28T00:00:00.000Z","tags":["计算机原理"],"draft":false,"summary":"什么是进程","slug":"什么是进程"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["容器中磁盘容量限制"]},"buildId":"xycpTPo5G1XEQLx5GlDdu","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>