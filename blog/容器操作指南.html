<!DOCTYPE html><html lang="zh-CN"><head><meta name="viewport" content="width=device-width"/><title>容器的操作指南</title><meta name="robots" content="follow, index"/><meta charSet="UTF-8"/><meta name="description" content="容器的操作指南"/><meta property="og:type"/><meta property="og:title" content="容器的操作指南"/><meta property="og:description" content="容器的操作指南"/><meta property="og:url" content="https://wwqdrh.github.io/undefined"/><meta name="keywords" content="wwqdrh技术博客"/><meta property="og:locale" content="zh-CN"/><meta property="og:image" content="https://wwqdrh.github.io"/><meta name="twitter:title" content="容器的操作指南"/><meta name="twitter:description" content="容器的操作指南"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="https://wwqdrh.github.io"/><link rel="stylesheet" href="/assets/mdrender/editor-render.css"/><meta name="next-head-count" content="17"/><link rel="icon" href="/favicon.ico"/><link rel="apple-touch-icon" sizes="192x192" href="/apple-touch-icon.png"/><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/feed"/><script src="/assets/analizy/clarity.js"></script><link rel="preload" href="/_next/static/media/d83e92f0af8b17e4-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/e52907b750a6f61e-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/ed42d1b51efd45f6-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/9031250013752d4b-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/fba9d678ff638e59-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/eb9adf802b0a60eb-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/81b352a4d7a000ae-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/41b9b3ece820718f-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/d587d1c112526568-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/css/869c7de7c781f904.css" as="style"/><link rel="stylesheet" href="/_next/static/css/869c7de7c781f904.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-fbe37f60a09a330b.js" defer=""></script><script src="/_next/static/chunks/main-082d90b1269d95f6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ebc472ae118a2be0.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-222bf60d0a2bf3df.js" defer=""></script><script src="/_next/static/qwylQn0rAYfx_DG8FLkaO/_buildManifest.js" defer=""></script><script src="/_next/static/qwylQn0rAYfx_DG8FLkaO/_ssgManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css-global c86wz">body{margin:0;padding:0;color:hsl(0, 0%, 9.0%);background-color:hsl(0, 0%, 97.3%);font-family:'__pretendard_6bb8e5','__pretendard_Fallback_6bb8e5';}*{-webkit-print-color-scheme:light;color-scheme:light;box-sizing:border-box;}h1,h2,h3,h4,h5,h6{margin:0;font-weight:inherit;font-style:inherit;}a{all:unset;cursor:pointer;}ul{padding:0;}button{all:unset;cursor:pointer;}input{all:unset;box-sizing:border-box;}textarea{border:none;background-color:transparent;font-family:inherit;padding:0;outline:none;resize:none;color:inherit;}hr{width:100%;border:none;margin:0;border-top:1px solid hsl(0, 0%, 88.7%);}</style><style data-emotion="css 1q70a33">.css-1q70a33{z-index:30;position:-webkit-sticky;position:sticky;top:0;background-color:hsl(0, 0%, 97.3%);box-shadow:0 1px 2px 0 rgba(0, 0, 0, 0.05);}.css-1q70a33 .container{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:100%;height:3rem;margin:0 auto;}@media (min-width: 768px){.css-1q70a33 .container[data-full-width="true"]{padding-left:6rem;padding-right:6rem;}}.css-1q70a33 .container .nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;gap:0.75rem;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-1q70a33 .container .mid{padding-top:0.5rem;padding-bottom:0.5rem;padding-left:1.25rem;padding-right:1.25rem;border-radius:1rem;outline-style:none;width:50%;background-color:hsl(0, 0%, 93.0%);}</style><div class="py-2 css-1q70a33"><div data-full-width="false" class="container"><a aria-label="wwqdrh" class="css-0" href="/">wwqdrh</a><input class="mid" type="text" placeholder="Search Keyword..." value=""/><div class="nav"><style data-emotion="css 1nw6zn9">.css-1nw6zn9{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}.css-1nw6zn9 ul{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}.css-1nw6zn9 ul li{display:block;margin-left:1rem;color:hsl(0, 0%, 43.5%);}</style><div class="css-1nw6zn9"><ul><li><a target="_blank" href="https://space.bilibili.com/538676331">B站</a></li></ul></div><style data-emotion="css 1h5x3dy">.css-1h5x3dy{cursor:pointer;}</style><div class="css-1h5x3dy"><style data-emotion="css p95608">.css-p95608{font-family:'__Noto_Color_Emoji_be1378','__Noto_Color_Emoji_Fallback_be1378',Apple Color Emoji;font-weight:400;font-style:normal;}</style><span class="css-p95608">☀️</span></div></div></div></div><style data-emotion="css lomkhl">.css-lomkhl{margin:0 auto;width:100%;padding:0 3rem;}</style><main class="css-lomkhl"><div class="divide-y bg-white dark:bg-gray-700 p-6 shadow-lg rounded-lg mt-3 divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="max-w-none pt-10 pb-8 prose dark:prose-dark"><div><h2>如何查看cgroup版本</h2>
<p>cgroupv1和v2有所区别，groupv2各项指标是混在一个group下的，而不是在具体的指标下再分组</p>
<pre><code class="hljs language-bash">$mount | grep cgroup

cgroup2 on /sys/fs/cgroup <span class="hljs-built_in">type</span> cgroup2 (rw,nosuid,nodev,noexec,relatime,nsdelegate,memory_recursiveprot)
</code></pre><h2>如何创建与删除cgroup</h2>
<p>cgroupv2</p>
<pre><code class="hljs language-bash">mkdir [name]

rmdir [name] <span class="hljs-comment"># ! 不能rm -rf之类的</span>
</code></pre><h2>如何查看一个容器中有哪些进程(宿主机pid)</h2>
<p><code>cat /sys/fs/cgroup/system.slice/docker-[pid].scope/cgroup.procs</code></p>
<h2>如何查看一个pid有哪些命名空间</h2>
<p><code>ls /proc/[pid]/ns</code></p>
<h2>如何进入一个命名空间</h2>
<p>进入已经存在的进程的指定空间</p>
<p><code>nsenter --target 58212 --mount --uts --ipc --net --pid -- env --ignore-environment -- /bin/bash</code></p>
<p>创建并进入新的命名空间并执行命令</p>
<p><code>unshare --mount --ipc --pid --net --mount-proc=/proc --fork /bin/bash</code></p>
<h2>关于命名空间的函数</h2>
<p>在每一个进程的 task_struct 里面，有一个指向 namespace 结构体的指针 nsproxy。</p>
<pre><code class="hljs language-c"><span class="hljs-comment">// 创建一个新的进程，并把它放到新的 namespace 中。</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">clone</span><span class="hljs-params">(<span class="hljs-type">int</span> (*fn)(<span class="hljs-type">void</span> *), <span class="hljs-type">void</span> *child_stack, <span class="hljs-type">int</span> flags, <span class="hljs-type">void</span> *arg)</span></span>;

<span class="hljs-comment">// 用于将当前进程加入到已有的 namespace 中</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">setns</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> nstype)</span></span>;

<span class="hljs-comment">// 它可以使当前进程退出当前的 namespace，并加入到新创建的 namespace</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">unshare</span><span class="hljs-params">(<span class="hljs-type">int</span> flags)</span></span>;
</code></pre><h1>资源限制</h1>
<blockquote>
<p>参考: <a href="https://docs.kernel.org/admin-guide/cgroup-v2.html#cpu">https://docs.kernel.org/admin-guide/cgroup-v2.html#cpu</a></p>
</blockquote>
<p><code>v1与v2各个指标的变化</code></p>
<ul>
<li>&quot;cpu.shares&quot; =&gt; &quot;cpu.weight&quot;</li>
<li>&quot;cpu.cfs_quota_us&quot; + &quot;cpu.cfs_period_us&quot; =&gt; &quot;cpu.max&quot;</li>
</ul>
<h2>加入进程到cgroup中</h2>
<p>将进程移动到指定 cgroup：将 PID 写到相应 cgroup 的 cgroup.procs 文件即可。</p>
<h2>如何限制容器的CPU使用</h2>
<p>v1</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># 限制成1.5个CPU 150000(150ms,一个cfs周期可以使用的时间) / 100000(一个cfs周期的时间) = 1.5</span>
echo [pid] &gt;&gt; /sys/fs/cgroup/[group]/cgroup.procs
echo <span class="hljs-number">100</span> &gt;&gt; /sys/fs/cgroup/[group]/cpu.cfs_period_us
echo <span class="hljs-number">150000</span> &gt;&gt; /sys/fs/cgroup/[group]/cpu.cfs_quota_us
</code></pre><p>v2</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># 限制成1.5个CPU 150000(150ms,一个cfs周期可以使用的时间) / 100000(一个cfs周期的时间) = 1.5</span>
echo [pid] &gt;&gt; /sys/fs/cgroup/[group]/cgroup.procs
echo <span class="hljs-number">100</span> &gt;&gt; /sys/fs/cgroup/[group]/cpu.weight <span class="hljs-comment"># default also 100</span>
echo <span class="hljs-number">150000</span> &gt;&gt; /sys/fs/cgroup/[group]/cpu.<span class="hljs-built_in">max</span> <span class="hljs-comment"># default is 100000</span>
</code></pre><h2>如何控制一个容器的最大内存使用量</h2>
<p>假设设置上限为2g(<code>2*1024*1024*1024 = 2147483648</code>)，</p>
<p><code>echo memory.limit_in_bytes &gt; /sys/fs/cgroup/system.slice/docker-[pid].scope/memory.limit_in_bytes</code></p>
</div></div></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"\u003ch2\u003e如何查看cgroup版本\u003c/h2\u003e\n\u003cp\u003ecgroupv1和v2有所区别，groupv2各项指标是混在一个group下的，而不是在具体的指标下再分组\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e$mount | grep cgroup\n\ncgroup2 on /sys/fs/cgroup \u003cspan class=\"hljs-built_in\"\u003etype\u003c/span\u003e cgroup2 (rw,nosuid,nodev,noexec,relatime,nsdelegate,memory_recursiveprot)\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003e如何创建与删除cgroup\u003c/h2\u003e\n\u003cp\u003ecgroupv2\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003emkdir [name]\n\nrmdir [name] \u003cspan class=\"hljs-comment\"\u003e# ! 不能rm -rf之类的\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003e如何查看一个容器中有哪些进程(宿主机pid)\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003ecat /sys/fs/cgroup/system.slice/docker-[pid].scope/cgroup.procs\u003c/code\u003e\u003c/p\u003e\n\u003ch2\u003e如何查看一个pid有哪些命名空间\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003els /proc/[pid]/ns\u003c/code\u003e\u003c/p\u003e\n\u003ch2\u003e如何进入一个命名空间\u003c/h2\u003e\n\u003cp\u003e进入已经存在的进程的指定空间\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ensenter --target 58212 --mount --uts --ipc --net --pid -- env --ignore-environment -- /bin/bash\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e创建并进入新的命名空间并执行命令\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eunshare --mount --ipc --pid --net --mount-proc=/proc --fork /bin/bash\u003c/code\u003e\u003c/p\u003e\n\u003ch2\u003e关于命名空间的函数\u003c/h2\u003e\n\u003cp\u003e在每一个进程的 task_struct 里面，有一个指向 namespace 结构体的指针 nsproxy。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-c\"\u003e\u003cspan class=\"hljs-comment\"\u003e// 创建一个新的进程，并把它放到新的 namespace 中。\u003c/span\u003e\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-type\"\u003eint\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eclone\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(\u003cspan class=\"hljs-type\"\u003eint\u003c/span\u003e (*fn)(\u003cspan class=\"hljs-type\"\u003evoid\u003c/span\u003e *), \u003cspan class=\"hljs-type\"\u003evoid\u003c/span\u003e *child_stack, \u003cspan class=\"hljs-type\"\u003eint\u003c/span\u003e flags, \u003cspan class=\"hljs-type\"\u003evoid\u003c/span\u003e *arg)\u003c/span\u003e\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e// 用于将当前进程加入到已有的 namespace 中\u003c/span\u003e\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-type\"\u003eint\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003esetns\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(\u003cspan class=\"hljs-type\"\u003eint\u003c/span\u003e fd, \u003cspan class=\"hljs-type\"\u003eint\u003c/span\u003e nstype)\u003c/span\u003e\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e// 它可以使当前进程退出当前的 namespace，并加入到新创建的 namespace\u003c/span\u003e\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-type\"\u003eint\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eunshare\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(\u003cspan class=\"hljs-type\"\u003eint\u003c/span\u003e flags)\u003c/span\u003e\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\u003ch1\u003e资源限制\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003e参考: \u003ca href=\"https://docs.kernel.org/admin-guide/cgroup-v2.html#cpu\"\u003ehttps://docs.kernel.org/admin-guide/cgroup-v2.html#cpu\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u003ccode\u003ev1与v2各个指标的变化\u003c/code\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u0026quot;cpu.shares\u0026quot; =\u0026gt; \u0026quot;cpu.weight\u0026quot;\u003c/li\u003e\n\u003cli\u003e\u0026quot;cpu.cfs_quota_us\u0026quot; + \u0026quot;cpu.cfs_period_us\u0026quot; =\u0026gt; \u0026quot;cpu.max\u0026quot;\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e加入进程到cgroup中\u003c/h2\u003e\n\u003cp\u003e将进程移动到指定 cgroup：将 PID 写到相应 cgroup 的 cgroup.procs 文件即可。\u003c/p\u003e\n\u003ch2\u003e如何限制容器的CPU使用\u003c/h2\u003e\n\u003cp\u003ev1\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-comment\"\u003e# 限制成1.5个CPU 150000(150ms,一个cfs周期可以使用的时间) / 100000(一个cfs周期的时间) = 1.5\u003c/span\u003e\necho [pid] \u0026gt;\u0026gt; /sys/fs/cgroup/[group]/cgroup.procs\necho \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e \u0026gt;\u0026gt; /sys/fs/cgroup/[group]/cpu.cfs_period_us\necho \u003cspan class=\"hljs-number\"\u003e150000\u003c/span\u003e \u0026gt;\u0026gt; /sys/fs/cgroup/[group]/cpu.cfs_quota_us\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003ev2\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-comment\"\u003e# 限制成1.5个CPU 150000(150ms,一个cfs周期可以使用的时间) / 100000(一个cfs周期的时间) = 1.5\u003c/span\u003e\necho [pid] \u0026gt;\u0026gt; /sys/fs/cgroup/[group]/cgroup.procs\necho \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e \u0026gt;\u0026gt; /sys/fs/cgroup/[group]/cpu.weight \u003cspan class=\"hljs-comment\"\u003e# default also 100\u003c/span\u003e\necho \u003cspan class=\"hljs-number\"\u003e150000\u003c/span\u003e \u0026gt;\u0026gt; /sys/fs/cgroup/[group]/cpu.\u003cspan class=\"hljs-built_in\"\u003emax\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e# default is 100000\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003e如何控制一个容器的最大内存使用量\u003c/h2\u003e\n\u003cp\u003e假设设置上限为2g(\u003ccode\u003e2*1024*1024*1024 = 2147483648\u003c/code\u003e)，\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eecho memory.limit_in_bytes \u0026gt; /sys/fs/cgroup/system.slice/docker-[pid].scope/memory.limit_in_bytes\u003c/code\u003e\u003c/p\u003e\n","frontMatter":{"readingTime":{"text":"3 min read","minutes":2.73,"time":163800,"words":546},"slug":"容器操作指南","fileName":"容器操作指南.md","title":"容器的操作指南","date":"2022-10-17T00:00:00.000Z","tags":["容器"],"draft":false,"summary":"容器的操作指南"}},"prev":{"title":"golang编译原理","date":"2022-10-10T00:00:00.000Z","tags":["Golang"],"draft":false,"summary":"golang编译原理","slug":"Go的编译原理"},"next":{"title":"docker-swarm的工作原理","date":"2022-10-26T00:00:00.000Z","tags":["云原生"],"draft":false,"summary":"docker-swarm的工作原理","slug":"swarm工作模式"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["容器操作指南"]},"buildId":"qwylQn0rAYfx_DG8FLkaO","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>