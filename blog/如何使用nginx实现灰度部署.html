<!DOCTYPE html><html lang="zh-CN"><head><meta name="viewport" content="width=device-width"/><title>如何使用nginx实现灰度部署</title><meta name="robots" content="follow, index"/><meta charSet="UTF-8"/><meta name="description" content="灰度部署"/><meta property="og:type"/><meta property="og:title" content="如何使用nginx实现灰度部署"/><meta property="og:description" content="灰度部署"/><meta property="og:url" content="https://wwqdrh.github.io/undefined"/><meta name="keywords" content="wwqdrh技术博客"/><meta property="og:locale" content="zh-CN"/><meta property="og:image" content="https://wwqdrh.github.io"/><meta name="twitter:title" content="如何使用nginx实现灰度部署"/><meta name="twitter:description" content="灰度部署"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="https://wwqdrh.github.io"/><link rel="stylesheet" href="/assets/mdrender/editor-render.css"/><meta name="next-head-count" content="17"/><link rel="icon" href="/favicon.ico"/><link rel="apple-touch-icon" sizes="192x192" href="/apple-touch-icon.png"/><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/feed"/><script src="/assets/analizy/clarity.js"></script><link rel="preload" href="/_next/static/media/d83e92f0af8b17e4-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/ed42d1b51efd45f6-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/fba9d678ff638e59-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/e52907b750a6f61e-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/9031250013752d4b-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/eb9adf802b0a60eb-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/81b352a4d7a000ae-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/41b9b3ece820718f-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/d587d1c112526568-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/css/869c7de7c781f904.css" as="style"/><link rel="stylesheet" href="/_next/static/css/869c7de7c781f904.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-fbe37f60a09a330b.js" defer=""></script><script src="/_next/static/chunks/main-082d90b1269d95f6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-494ee9c4b0594b31.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-222bf60d0a2bf3df.js" defer=""></script><script src="/_next/static/xycpTPo5G1XEQLx5GlDdu/_buildManifest.js" defer=""></script><script src="/_next/static/xycpTPo5G1XEQLx5GlDdu/_ssgManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css-global c86wz">body{margin:0;padding:0;color:hsl(0, 0%, 9.0%);background-color:hsl(0, 0%, 97.3%);font-family:'__pretendard_6bb8e5','__pretendard_Fallback_6bb8e5';}*{-webkit-print-color-scheme:light;color-scheme:light;box-sizing:border-box;}h1,h2,h3,h4,h5,h6{margin:0;font-weight:inherit;font-style:inherit;}a{all:unset;cursor:pointer;}ul{padding:0;}button{all:unset;cursor:pointer;}input{all:unset;box-sizing:border-box;}textarea{border:none;background-color:transparent;font-family:inherit;padding:0;outline:none;resize:none;color:inherit;}hr{width:100%;border:none;margin:0;border-top:1px solid hsl(0, 0%, 88.7%);}</style><style data-emotion="css 1q70a33">.css-1q70a33{z-index:30;position:-webkit-sticky;position:sticky;top:0;background-color:hsl(0, 0%, 97.3%);box-shadow:0 1px 2px 0 rgba(0, 0, 0, 0.05);}.css-1q70a33 .container{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:100%;height:3rem;margin:0 auto;}@media (min-width: 768px){.css-1q70a33 .container[data-full-width="true"]{padding-left:6rem;padding-right:6rem;}}.css-1q70a33 .container .nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;gap:0.75rem;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-1q70a33 .container .mid{padding-top:0.5rem;padding-bottom:0.5rem;padding-left:1.25rem;padding-right:1.25rem;border-radius:1rem;outline-style:none;width:50%;background-color:hsl(0, 0%, 93.0%);}</style><div class="py-2 css-1q70a33"><div data-full-width="false" class="container"><a aria-label="wwqdrh" class="css-0" href="/">wwqdrh</a><input class="mid" type="text" placeholder="Search Keyword..." value=""/><div class="nav"><style data-emotion="css 1nw6zn9">.css-1nw6zn9{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}.css-1nw6zn9 ul{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}.css-1nw6zn9 ul li{display:block;margin-left:1rem;color:hsl(0, 0%, 43.5%);}</style><div class="css-1nw6zn9"><ul><li><a target="_blank" href="https://space.bilibili.com/538676331">B站</a></li></ul></div><style data-emotion="css 1h5x3dy">.css-1h5x3dy{cursor:pointer;}</style><div class="css-1h5x3dy"><style data-emotion="css p95608">.css-p95608{font-family:'__Noto_Color_Emoji_be1378','__Noto_Color_Emoji_Fallback_be1378',Apple Color Emoji;font-weight:400;font-style:normal;}</style><span class="css-p95608">☀️</span></div></div></div></div><style data-emotion="css lomkhl">.css-lomkhl{margin:0 auto;width:100%;padding:0 3rem;}</style><main class="css-lomkhl"><div class="divide-y bg-white dark:bg-gray-700 p-6 shadow-lg rounded-lg mt-3 divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="max-w-none pt-10 pb-8 prose dark:prose-dark"><div><h1>如何使用nginx实现灰度部署</h1>
<br />

<img src="/images/blogs/nginx简介.png" />

<h2>什么是灰度部署</h2>
<br/>

<p>在应用部署中，存在停机部署和不停机部署两种。不停机部署中分为蓝绿与灰度部署，蓝绿是非黑即白，蓝色为当前版本的实时流量，绿色是最新版本的环境，任何时候只有一套环境有实时流量。在这套环境里做最终的测试，只有当确认新版本完全没有问题之后，才会将流量切到新版本的代码环境中。</p>
<p>灰度部署是将流量逐渐迁移到最新的代码中，1%、5%、10%、25%，在确认代码能够正常运行时再不断扩大。主旨就是用很少的流量验证某个版本是否正常。（金丝雀部署同理，不断试错，如果没有问题就加大流量，如果有问题可以及时告警，同时只是很少的流量会经过这里，即用最小的成本进行试错了）</p>
<br/>

<h2>实现灰度部署需要考虑的点</h2>
<br/>

<ol>
<li>什么样的流量让其进入新版本(带权值的负载均衡、带特定标识的header、jwt解析后属于特定用户的流量)</li>
<li>当接口错误时如何进行警告，通知开发人员进行修复，并自动降低进入新版本流量的权值</li>
<li>当新流量权值变为100或者0时对应用自动进行切换，执行完全的回退或者推进</li>
</ol>
<br/>

<h2>最小实践</h2>
<br/>

<p>针对上文指出需要注意的点，这里列出样例(只是提供一种思路，每一个步骤其实都可以自定义，自己控制流量何时伸展，何时收缩)</p>
<ol>
<li>如何定义路由: 部署新容器时，自动修改nginx的配置，配置权重，每隔一段时间进行检查没有异常则不断扩大权重直至完全切换</li>
<li>如何定义接口产生异常: 修改nginx配置，每次检查时直接进行简单计数，新版本地址与发生500异常，如果大于0了直接进行版本回退</li>
</ol>
<br/>

<img src="/images/blogs/不停机更新.png" />

<br/>

<pre><code class="hljs language-sh"><span class="hljs-comment">#!/bin/sh</span>

<span class="hljs-comment"># TODO 需要解析log日志判断是否需要动态伸缩容量</span>

<span class="hljs-comment"># 当前进程的pid 用于停止旧命令</span>
<span class="hljs-string">C_PID=$$</span>
<span class="hljs-string">C_DIR=$(</span>
    <span class="hljs-string">cd</span> <span class="hljs-string">$(dirname</span> <span class="hljs-string">$0)</span>
    <span class="hljs-string">pwd</span>
<span class="hljs-string">)</span>
<span class="hljs-comment"># flag文件目录 判断当前是否已经有脚本在执行了</span>
<span class="hljs-string">C_FLAG=$C_DIR&quot;/.deployed&quot;</span>
<span class="hljs-string">C_INGRESS_CONF=&quot;/etc/nginx/conf.d/ingres.conf&quot;</span> <span class="hljs-comment"># nginx配置文件写入路径</span>
<span class="hljs-string">C_LOG_PATH=$C_DIR&quot;/access.log&quot;</span>

<span class="hljs-comment"># 初始值</span>
<span class="hljs-string">checktime=10</span>
<span class="hljs-string">weight1=90</span>
<span class="hljs-string">weight2=10</span>
<span class="hljs-string">step=10</span> <span class="hljs-comment"># 步数</span>

<span class="hljs-string">function</span> <span class="hljs-string">weight_factory()</span> {
    <span class="hljs-string">wei=$1</span>
    <span class="hljs-string">if</span> [ <span class="hljs-string">$wei</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
        <span class="hljs-string">echo</span> <span class="hljs-string">&quot;down&quot;</span>
    <span class="hljs-string">else</span>
        <span class="hljs-string">echo</span> <span class="hljs-string">&quot;weight=$wei&quot;</span>
    <span class="hljs-string">fi</span>
}

<span class="hljs-string">function</span> <span class="hljs-string">usage_factory()</span> {
    <span class="hljs-string">echo</span> <span class="hljs-string">&quot;$(
        cat &lt;&lt;-EOF
Usage:
    deploy: 执行部署
EOF
    )&quot;</span>
}

<span class="hljs-string">function</span> <span class="hljs-string">ingress_ori_factory()</span> {
    <span class="hljs-string">echo</span> <span class="hljs-string">&quot;$(
        cat &lt;&lt;-EOF
upstream nginx_gray_test {
    server 127.0.0.1:8004 weight=100 fail_timeout=30;
    server 127.0.0.1:8005 down fail_timeout=30;
}

server {
    listen       8080;
    server_name  192.168.110.114;

    location / {
        proxy_set_header Host nginx_gray_test;
        proxy_http_version 1.1;
        proxy_pass http://nginx_gray_test;
    }
}
EOF
    )&quot;</span>
}

<span class="hljs-string">function</span> <span class="hljs-string">ingress_factory()</span> {
    <span class="hljs-string">echo</span> <span class="hljs-string">&quot;$(
        cat &lt;&lt;-EOF
log_format  debug &#x27;\$upstream_addr|\$status|\$upstream_response_time&#x27;;

upstream nginx_gray_test {
    server 127.0.0.1:8004 $(weight_factory $weight1) fail_timeout=30;
    server 127.0.0.1:8005 $(weight_factory $weight2) fail_timeout=30;
}

server {
    listen       8080;
    server_name  192.168.110.114;

    # 指定access_log的存放路径、格式和缓存大小
    access_log  $C_LOG_PATH debug;

    location / {
        proxy_set_header Host nginx_gray_test;
        proxy_http_version 1.1;
        proxy_pass http://nginx_gray_test;
    }
}
EOF
    )&quot;</span>
}

<span class="hljs-string">function</span> <span class="hljs-string">deploy1_factory()</span> {
    <span class="hljs-string">echo</span> <span class="hljs-string">&quot;$(
        cat &lt;&lt;-EOF
docker pull 192.168.110.114:5000/library/deployecho:latest
docker rm -fv deployecho1
docker run -d --name=deployecho1 --restart=always \
    -p 127.0.0.1:8004:8080 \
    192.168.110.114:5000/library/deployecho:latest
EOF
    )&quot;</span>
}

<span class="hljs-string">function</span> <span class="hljs-string">deploy1_exist()</span> {
    <span class="hljs-string">echo</span> <span class="hljs-string">&quot;$(
        cat &lt;&lt;-EOF
docker ps | grep deployecho1
EOF
    )&quot;</span>
}

<span class="hljs-string">function</span> <span class="hljs-string">deploy1_remove()</span> {
    <span class="hljs-string">echo</span> <span class="hljs-string">&quot;$(
        cat &lt;&lt;-EOF
docker stop deployecho1
docker rm -fv deployecho1
EOF
    )&quot;</span>
}

<span class="hljs-string">function</span> <span class="hljs-string">deploy2_factory()</span> {
    <span class="hljs-string">echo</span> <span class="hljs-string">&quot;$(
        cat &lt;&lt;-EOF
docker pull 192.168.110.114:5000/library/deployecho:latest
docker rm -fv deployecho2
docker run -d --name=deployecho2 --restart=always \
    -p 127.0.0.1:8005:8080 \
    192.168.110.114:5000/library/deployecho:latest
EOF
    )&quot;</span>
}

<span class="hljs-string">function</span> <span class="hljs-string">deploy2_exist()</span> {
    <span class="hljs-string">echo</span> <span class="hljs-string">&quot;$(
        cat &lt;&lt;-EOF
docker ps | grep deployecho2
EOF
    )&quot;</span>
}

<span class="hljs-string">function</span> <span class="hljs-string">deploy2_remove()</span> {
    <span class="hljs-string">echo</span> <span class="hljs-string">&quot;$(
        cat &lt;&lt;-EOF
docker rm -fv deployecho2
EOF
    )&quot;</span>
}

<span class="hljs-comment"># 多行字符串，按照换行进行分割后执行</span>
<span class="hljs-comment"># TODO 无法实现多行字符串按照换行符分割</span>
<span class="hljs-comment"># 写入临时变量后执行</span>
<span class="hljs-comment"># 示例</span>
<span class="hljs-comment"># function deploe() {</span>
<span class="hljs-comment">#     echo &quot;$(</span>
<span class="hljs-comment">#         cat &lt;&lt;-EOF</span>
<span class="hljs-comment"># echo 1</span>
<span class="hljs-comment"># echo 2</span>
<span class="hljs-comment"># EOF</span>
<span class="hljs-comment">#     )&quot;</span>
<span class="hljs-comment"># }</span>
<span class="hljs-comment"># res=$(run_str_shell &quot;$(deploe)&quot;)</span>
<span class="hljs-comment"># echo &quot;$res&quot;</span>
<span class="hljs-string">function</span> <span class="hljs-string">run_str_shell()</span> {
    <span class="hljs-comment"># fun_str=&quot;$1&quot;</span>
    <span class="hljs-comment"># array=(${fun_str//\n/ })</span>
    <span class="hljs-comment"># for var in ${array[@]}; do</span>
    <span class="hljs-comment">#     echo $var</span>
    <span class="hljs-comment"># done</span>
    <span class="hljs-string">echo</span> <span class="hljs-string">&quot;$1&quot;</span> <span class="hljs-string">&gt;&gt;$C_DIR&quot;/tmp.sh&quot;</span>
    <span class="hljs-string">chmod</span> <span class="hljs-string">+x</span> <span class="hljs-string">$C_DIR&quot;/tmp.sh&quot;</span>
    <span class="hljs-string">sh</span> <span class="hljs-string">-x</span> <span class="hljs-string">$C_DIR&quot;/tmp.sh&quot;</span>
    <span class="hljs-string">status=$?</span> <span class="hljs-comment"># 获取上一步执行完成的状态码</span>
    <span class="hljs-string">rm</span> <span class="hljs-string">-f</span> <span class="hljs-string">$C_DIR&quot;/tmp.sh&quot;</span>
    <span class="hljs-comment"># echo &quot;status: $status&quot;</span>
}

<span class="hljs-comment"># 入口函数</span>
<span class="hljs-comment"># 需要检查当前脚本只能同时有一个在运行</span>
<span class="hljs-comment"># 1、gray 手动设置新旧节点的阈值</span>
<span class="hljs-comment"># 2、deploy 执行部署</span>
<span class="hljs-comment"># (1、只要新节点不出错立马切换</span>
<span class="hljs-comment"># (2、固定运行一段时间，时间越长，新节点错误日志越少，阈值调得越大</span>
<span class="hljs-string">function</span> <span class="hljs-string">main()</span> {
    <span class="hljs-comment"># 需要注意的是如果执行kill -9 ，这个信号(强制终止)是不能被处理或忽略的，所以最好是使用15(简单终止)</span>
    <span class="hljs-comment"># 如果手动退出 将镜像回退</span>
    <span class="hljs-string">trap</span> <span class="hljs-string">&quot;rm -f $C_FLAG; exit&quot;</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">14</span> <span class="hljs-number">15</span>

    <span class="hljs-string">case</span> <span class="hljs-string">$1</span> <span class="hljs-string">in</span>
    <span class="hljs-string">&quot;deploy&quot;</span><span class="hljs-string">)</span>
        <span class="hljs-string">check_single</span>
        <span class="hljs-string">echo</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-string">&gt;$C_LOG_PATH</span>
        <span class="hljs-string">trap</span> <span class="hljs-string">&quot;rollback; rm -f $C_FLAG $C_LOG_PATH; exit&quot;</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">14</span> <span class="hljs-number">15</span>
        <span class="hljs-string">commond_deploy</span> <span class="hljs-string">$2</span> <span class="hljs-string">$3</span>
        <span class="hljs-string">;;</span>
    <span class="hljs-string">&quot;set&quot;</span><span class="hljs-string">)</span>
        <span class="hljs-string">commond_set</span>
        <span class="hljs-string">;;</span>
    <span class="hljs-string">&quot;-h&quot;</span><span class="hljs-string">)</span>
        <span class="hljs-string">echo</span> <span class="hljs-string">&quot;$(usage_factory)&quot;</span>
        <span class="hljs-string">;;</span>
    <span class="hljs-string">*)</span>
        <span class="hljs-string">echo</span> <span class="hljs-string">&quot;error&quot;</span>
        <span class="hljs-string">exit</span> <span class="hljs-number">1</span>
        <span class="hljs-string">;;</span>
    <span class="hljs-string">esac</span>
    <span class="hljs-string">exit</span> <span class="hljs-number">0</span>
}

<span class="hljs-comment"># 1、部署镜像启动新的应用实例</span>
<span class="hljs-comment"># 2、修改nginx的策略 并不断查看当前新应用的状态并动态修改权重</span>
<span class="hljs-comment"># 网关配置，</span>
<span class="hljs-comment"># 1、每隔一段时间检查，如果新节点依然存在，将流量转到新节点的阈值调大</span>
<span class="hljs-comment"># 2、每隔一段时间检查，如果新节点已经退出，将流量阈值设为0 流量回退到新节点</span>
<span class="hljs-comment"># 根据上面的nginx配置，判断新节点的端口占用是否导致了50x过多，当超过阈值就将其回退，当没有问题就随着时间不断扩大阈值</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># 现有问题:</span>
<span class="hljs-comment"># 1、如何判断当前应用的健康状态？简单的凭借应用是否存在并不妥当，还需要判断各个接口的流量情况，</span>
<span class="hljs-comment">#   也就是说需要专门的判断各个接口的运行状态</span>
<span class="hljs-comment"># 2、是否需要提供手动设置权重的接口</span>
<span class="hljs-comment"># 3、如果多次发布以谁为准(直接更新替换新节点，因为旧节点是100%没有问题的)</span>
<span class="hljs-string">function</span> <span class="hljs-string">commond_deploy()</span> {
    <span class="hljs-comment"># @args</span>
    <span class="hljs-comment"># 循环，不断获取应用的状态更新状态</span>
    <span class="hljs-string">run_str_shell</span> <span class="hljs-string">&quot;$(deploy2_factory)&quot;</span>
    <span class="hljs-string">update_nginx</span> <span class="hljs-comment"># 初始状态</span>

    <span class="hljs-string">for</span> <span class="hljs-string">((i</span> <span class="hljs-string">=</span> <span class="hljs-number">1</span><span class="hljs-string">;</span> <span class="hljs-string">;</span> <span class="hljs-string">i++));</span> <span class="hljs-string">do</span>
        <span class="hljs-string">sleep</span> <span class="hljs-string">$checktime</span> <span class="hljs-comment"># 正式环境设为3m</span>
        <span class="hljs-string">status=$(check_status)</span>
        <span class="hljs-comment"># 检测当前状态是否正常，正常的话就进行扩充流量</span>
        <span class="hljs-string">if</span> [ <span class="hljs-string">$status</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
            <span class="hljs-string">grayupdate</span>
        <span class="hljs-string">elif</span> [ <span class="hljs-string">$status</span> <span class="hljs-string">==</span> <span class="hljs-number">1</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
            <span class="hljs-string">rollback</span>
            <span class="hljs-string">break</span>
        <span class="hljs-string">elif</span> [ <span class="hljs-string">$status</span> <span class="hljs-string">==</span> <span class="hljs-number">2</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
            <span class="hljs-string">switch</span>
            <span class="hljs-string">break</span>
        <span class="hljs-string">fi</span>
    <span class="hljs-string">done</span>
    <span class="hljs-string">echo</span> <span class="hljs-string">&quot;do here&quot;</span>
    <span class="hljs-string">echo</span> <span class="hljs-number">0</span>
}

<span class="hljs-comment"># 手动修改nginx的weight配置</span>
<span class="hljs-string">function</span> <span class="hljs-string">commond_set()</span> {
    <span class="hljs-string">echo</span> <span class="hljs-number">0</span>
}

<span class="hljs-comment"># 保证只有一个脚本实例在执行</span>
<span class="hljs-string">function</span> <span class="hljs-string">check_single()</span> {
    <span class="hljs-string">if</span> [ <span class="hljs-string">-s</span> <span class="hljs-string">$C_FLAG</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span> <span class="hljs-comment"># 存在文件且非空</span>
        <span class="hljs-string">old_pid=$(cat</span> <span class="hljs-string">$C_FLAG)</span>
        <span class="hljs-string">kill</span> <span class="hljs-number">-9</span> <span class="hljs-string">$old_pid</span>
    <span class="hljs-string">fi</span>

    <span class="hljs-string">echo</span> <span class="hljs-string">$C_PID</span> <span class="hljs-string">&gt;$C_FLAG</span>
}

<span class="hljs-comment"># 判断当前的流量状况 0正常扩容 1新环境错误进行回退 2新环境无问题直接切换</span>
<span class="hljs-string">function</span> <span class="hljs-string">check_status()</span> {
    <span class="hljs-string">res=$(run_str_shell</span> <span class="hljs-string">&quot;$(deploy2_exist)&quot;</span><span class="hljs-string">)</span>
    <span class="hljs-string">if</span> [ <span class="hljs-string">-z</span> <span class="hljs-string">&quot;$res&quot;</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
        <span class="hljs-string">echo</span> <span class="hljs-number">1</span>
    <span class="hljs-string">elif</span> [ <span class="hljs-string">$(error_strategy)</span> <span class="hljs-string">==</span> <span class="hljs-number">1</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
        <span class="hljs-string">echo</span> <span class="hljs-number">1</span>
    <span class="hljs-string">elif</span> [ <span class="hljs-string">$weight2</span> <span class="hljs-string">==</span> <span class="hljs-number">100</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
        <span class="hljs-string">echo</span> <span class="hljs-number">2</span>
    <span class="hljs-string">else</span>
        <span class="hljs-string">echo</span> <span class="hljs-number">0</span>
    <span class="hljs-string">fi</span>
}

<span class="hljs-comment"># 判断新节点出错的依据</span>
<span class="hljs-string">function</span> <span class="hljs-string">error_strategy()</span> {
    <span class="hljs-string">cnt=$(grep</span> <span class="hljs-string">&quot;^127.0.0.1:8005|500&quot;</span> <span class="hljs-string">-c</span> <span class="hljs-string">$C_LOG_PATH)</span>
    <span class="hljs-string">if</span> [ <span class="hljs-string">$cnt</span> <span class="hljs-string">-gt</span> <span class="hljs-number">0</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
        <span class="hljs-string">echo</span> <span class="hljs-number">1</span>
    <span class="hljs-string">else</span>
        <span class="hljs-string">echo</span> <span class="hljs-number">0</span>
    <span class="hljs-string">fi</span>
}

<span class="hljs-comment"># 更新nginx配置</span>
<span class="hljs-string">function</span> <span class="hljs-string">update_nginx()</span> {
    <span class="hljs-string">echo</span> <span class="hljs-string">&quot;$(ingress_factory)&quot;</span> <span class="hljs-string">&gt;$C_INGRESS_CONF</span>
    <span class="hljs-string">nginx</span> <span class="hljs-string">-s</span> <span class="hljs-string">reload</span>
}

<span class="hljs-comment"># 回退nginx配置</span>
<span class="hljs-string">function</span> <span class="hljs-string">single_nginx()</span> {
    <span class="hljs-string">echo</span> <span class="hljs-string">&quot;$(ingress_ori_factory)&quot;</span> <span class="hljs-string">&gt;$C_INGRESS_CONF</span>
    <span class="hljs-string">nginx</span> <span class="hljs-string">-s</span> <span class="hljs-string">reload</span>
}

<span class="hljs-comment"># 灰度更新 渐渐扩大流量</span>
<span class="hljs-string">function</span> <span class="hljs-string">grayupdate()</span> {
    <span class="hljs-string">weight1=$((weight1</span> <span class="hljs-bullet">-</span> <span class="hljs-string">step))</span>
    <span class="hljs-string">weight2=$((weight2</span> <span class="hljs-string">+</span> <span class="hljs-string">step))</span>
    <span class="hljs-string">update_nginx</span>
}

<span class="hljs-comment"># 将流量添加到新的节点中</span>
<span class="hljs-comment"># 1、根据新镜像创建容器1</span>
<span class="hljs-comment"># 2、weight1为100 weight2为0</span>
<span class="hljs-comment"># 3、删除新节点的容器</span>
<span class="hljs-string">function</span> <span class="hljs-string">switch()</span> {
    <span class="hljs-string">res=$(run_str_shell</span> <span class="hljs-string">&quot;$(deploy1_factory)&quot;</span><span class="hljs-string">)</span>
    <span class="hljs-string">single_nginx</span>
    <span class="hljs-string">res=$(run_str_shell</span> <span class="hljs-string">&quot;$(deploy2_remove)&quot;</span><span class="hljs-string">)</span>
}

<span class="hljs-comment"># 回退流量到原来的版本</span>
<span class="hljs-comment"># 1、将weight1全部为100 weight2为0</span>
<span class="hljs-comment"># 2、删除新节点的容器</span>
<span class="hljs-string">function</span> <span class="hljs-string">rollback()</span> {
    <span class="hljs-string">single_nginx</span>
    <span class="hljs-string">res=$(run_str_shell</span> <span class="hljs-string">&quot;$(deploy2_remove)&quot;</span><span class="hljs-string">)</span>
}

<span class="hljs-string">main</span> <span class="hljs-string">$@</span>
</code></pre></div></div></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"\u003ch1\u003e如何使用nginx实现灰度部署\u003c/h1\u003e\n\u003cbr /\u003e\n\n\u003cimg src=\"/images/blogs/nginx简介.png\" /\u003e\n\n\u003ch2\u003e什么是灰度部署\u003c/h2\u003e\n\u003cbr/\u003e\n\n\u003cp\u003e在应用部署中，存在停机部署和不停机部署两种。不停机部署中分为蓝绿与灰度部署，蓝绿是非黑即白，蓝色为当前版本的实时流量，绿色是最新版本的环境，任何时候只有一套环境有实时流量。在这套环境里做最终的测试，只有当确认新版本完全没有问题之后，才会将流量切到新版本的代码环境中。\u003c/p\u003e\n\u003cp\u003e灰度部署是将流量逐渐迁移到最新的代码中，1%、5%、10%、25%，在确认代码能够正常运行时再不断扩大。主旨就是用很少的流量验证某个版本是否正常。（金丝雀部署同理，不断试错，如果没有问题就加大流量，如果有问题可以及时告警，同时只是很少的流量会经过这里，即用最小的成本进行试错了）\u003c/p\u003e\n\u003cbr/\u003e\n\n\u003ch2\u003e实现灰度部署需要考虑的点\u003c/h2\u003e\n\u003cbr/\u003e\n\n\u003col\u003e\n\u003cli\u003e什么样的流量让其进入新版本(带权值的负载均衡、带特定标识的header、jwt解析后属于特定用户的流量)\u003c/li\u003e\n\u003cli\u003e当接口错误时如何进行警告，通知开发人员进行修复，并自动降低进入新版本流量的权值\u003c/li\u003e\n\u003cli\u003e当新流量权值变为100或者0时对应用自动进行切换，执行完全的回退或者推进\u003c/li\u003e\n\u003c/ol\u003e\n\u003cbr/\u003e\n\n\u003ch2\u003e最小实践\u003c/h2\u003e\n\u003cbr/\u003e\n\n\u003cp\u003e针对上文指出需要注意的点，这里列出样例(只是提供一种思路，每一个步骤其实都可以自定义，自己控制流量何时伸展，何时收缩)\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e如何定义路由: 部署新容器时，自动修改nginx的配置，配置权重，每隔一段时间进行检查没有异常则不断扩大权重直至完全切换\u003c/li\u003e\n\u003cli\u003e如何定义接口产生异常: 修改nginx配置，每次检查时直接进行简单计数，新版本地址与发生500异常，如果大于0了直接进行版本回退\u003c/li\u003e\n\u003c/ol\u003e\n\u003cbr/\u003e\n\n\u003cimg src=\"/images/blogs/不停机更新.png\" /\u003e\n\n\u003cbr/\u003e\n\n\u003cpre\u003e\u003ccode class=\"hljs language-sh\"\u003e\u003cspan class=\"hljs-comment\"\u003e#!/bin/sh\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# TODO 需要解析log日志判断是否需要动态伸缩容量\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# 当前进程的pid 用于停止旧命令\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003eC_PID=$$\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003eC_DIR=$(\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003ecd\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$(dirname\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$0)\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003epwd\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e)\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# flag文件目录 判断当前是否已经有脚本在执行了\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003eC_FLAG=$C_DIR\u0026quot;/.deployed\u0026quot;\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003eC_INGRESS_CONF=\u0026quot;/etc/nginx/conf.d/ingres.conf\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e# nginx配置文件写入路径\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003eC_LOG_PATH=$C_DIR\u0026quot;/access.log\u0026quot;\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# 初始值\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003echecktime=10\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003eweight1=90\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003eweight2=10\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003estep=10\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e# 步数\u003c/span\u003e\n\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eweight_factory()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003ewei=$1\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e$wei\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e==\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e ]\u003cspan class=\"hljs-string\"\u003e;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ethen\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;down\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eelse\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;weight=$wei\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003efi\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eusage_factory()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(\n        cat \u0026lt;\u0026lt;-EOF\nUsage:\n    deploy: 执行部署\nEOF\n    )\u0026quot;\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eingress_ori_factory()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(\n        cat \u0026lt;\u0026lt;-EOF\nupstream nginx_gray_test {\n    server 127.0.0.1:8004 weight=100 fail_timeout=30;\n    server 127.0.0.1:8005 down fail_timeout=30;\n}\n\nserver {\n    listen       8080;\n    server_name  192.168.110.114;\n\n    location / {\n        proxy_set_header Host nginx_gray_test;\n        proxy_http_version 1.1;\n        proxy_pass http://nginx_gray_test;\n    }\n}\nEOF\n    )\u0026quot;\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eingress_factory()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(\n        cat \u0026lt;\u0026lt;-EOF\nlog_format  debug \u0026#x27;\\$upstream_addr|\\$status|\\$upstream_response_time\u0026#x27;;\n\nupstream nginx_gray_test {\n    server 127.0.0.1:8004 $(weight_factory $weight1) fail_timeout=30;\n    server 127.0.0.1:8005 $(weight_factory $weight2) fail_timeout=30;\n}\n\nserver {\n    listen       8080;\n    server_name  192.168.110.114;\n\n    # 指定access_log的存放路径、格式和缓存大小\n    access_log  $C_LOG_PATH debug;\n\n    location / {\n        proxy_set_header Host nginx_gray_test;\n        proxy_http_version 1.1;\n        proxy_pass http://nginx_gray_test;\n    }\n}\nEOF\n    )\u0026quot;\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edeploy1_factory()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(\n        cat \u0026lt;\u0026lt;-EOF\ndocker pull 192.168.110.114:5000/library/deployecho:latest\ndocker rm -fv deployecho1\ndocker run -d --name=deployecho1 --restart=always \\\n    -p 127.0.0.1:8004:8080 \\\n    192.168.110.114:5000/library/deployecho:latest\nEOF\n    )\u0026quot;\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edeploy1_exist()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(\n        cat \u0026lt;\u0026lt;-EOF\ndocker ps | grep deployecho1\nEOF\n    )\u0026quot;\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edeploy1_remove()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(\n        cat \u0026lt;\u0026lt;-EOF\ndocker stop deployecho1\ndocker rm -fv deployecho1\nEOF\n    )\u0026quot;\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edeploy2_factory()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(\n        cat \u0026lt;\u0026lt;-EOF\ndocker pull 192.168.110.114:5000/library/deployecho:latest\ndocker rm -fv deployecho2\ndocker run -d --name=deployecho2 --restart=always \\\n    -p 127.0.0.1:8005:8080 \\\n    192.168.110.114:5000/library/deployecho:latest\nEOF\n    )\u0026quot;\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edeploy2_exist()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(\n        cat \u0026lt;\u0026lt;-EOF\ndocker ps | grep deployecho2\nEOF\n    )\u0026quot;\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edeploy2_remove()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(\n        cat \u0026lt;\u0026lt;-EOF\ndocker rm -fv deployecho2\nEOF\n    )\u0026quot;\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e# 多行字符串，按照换行进行分割后执行\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# TODO 无法实现多行字符串按照换行符分割\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 写入临时变量后执行\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 示例\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# function deploe() {\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e#     echo \u0026quot;$(\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e#         cat \u0026lt;\u0026lt;-EOF\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# echo 1\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# echo 2\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# EOF\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e#     )\u0026quot;\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# }\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# res=$(run_str_shell \u0026quot;$(deploe)\u0026quot;)\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# echo \u0026quot;$res\u0026quot;\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003erun_str_shell()\u003c/span\u003e {\n    \u003cspan class=\"hljs-comment\"\u003e# fun_str=\u0026quot;$1\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e# array=(${fun_str//\\n/ })\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e# for var in ${array[@]}; do\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e#     echo $var\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e# done\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$1\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026gt;\u0026gt;$C_DIR\u0026quot;/tmp.sh\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003echmod\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e+x\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$C_DIR\u0026quot;/tmp.sh\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003esh\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-x\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$C_DIR\u0026quot;/tmp.sh\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003estatus=$?\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e# 获取上一步执行完成的状态码\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003erm\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-f\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$C_DIR\u0026quot;/tmp.sh\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e# echo \u0026quot;status: $status\u0026quot;\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e# 入口函数\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 需要检查当前脚本只能同时有一个在运行\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 1、gray 手动设置新旧节点的阈值\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 2、deploy 执行部署\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# (1、只要新节点不出错立马切换\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# (2、固定运行一段时间，时间越长，新节点错误日志越少，阈值调得越大\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emain()\u003c/span\u003e {\n    \u003cspan class=\"hljs-comment\"\u003e# 需要注意的是如果执行kill -9 ，这个信号(强制终止)是不能被处理或忽略的，所以最好是使用15(简单终止)\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e# 如果手动退出 将镜像回退\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003etrap\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;rm -f $C_FLAG; exit\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e9\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e14\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e15\u003c/span\u003e\n\n    \u003cspan class=\"hljs-string\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$1\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ein\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;deploy\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003echeck_single\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026gt;$C_LOG_PATH\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003etrap\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;rollback; rm -f $C_FLAG $C_LOG_PATH; exit\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e9\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e14\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e15\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003ecommond_deploy\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$2\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$3\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003e;;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;set\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003ecommond_set\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003e;;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;-h\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(usage_factory)\u0026quot;\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003e;;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e*)\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;error\u0026quot;\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eexit\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003e;;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eesac\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eexit\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e# 1、部署镜像启动新的应用实例\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 2、修改nginx的策略 并不断查看当前新应用的状态并动态修改权重\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 网关配置，\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 1、每隔一段时间检查，如果新节点依然存在，将流量转到新节点的阈值调大\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 2、每隔一段时间检查，如果新节点已经退出，将流量阈值设为0 流量回退到新节点\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 根据上面的nginx配置，判断新节点的端口占用是否导致了50x过多，当超过阈值就将其回退，当没有问题就随着时间不断扩大阈值\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e#\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 现有问题:\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 1、如何判断当前应用的健康状态？简单的凭借应用是否存在并不妥当，还需要判断各个接口的流量情况，\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e#   也就是说需要专门的判断各个接口的运行状态\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 2、是否需要提供手动设置权重的接口\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 3、如果多次发布以谁为准(直接更新替换新节点，因为旧节点是100%没有问题的)\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecommond_deploy()\u003c/span\u003e {\n    \u003cspan class=\"hljs-comment\"\u003e# @args\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e# 循环，不断获取应用的状态更新状态\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003erun_str_shell\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(deploy2_factory)\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eupdate_nginx\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e# 初始状态\u003c/span\u003e\n\n    \u003cspan class=\"hljs-string\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e((i\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ei++));\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003edo\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003esleep\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$checktime\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e# 正式环境设为3m\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003estatus=$(check_status)\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e# 检测当前状态是否正常，正常的话就进行扩充流量\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e$status\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e==\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e ]\u003cspan class=\"hljs-string\"\u003e;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ethen\u003c/span\u003e\n            \u003cspan class=\"hljs-string\"\u003egrayupdate\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eelif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e$status\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e==\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e ]\u003cspan class=\"hljs-string\"\u003e;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ethen\u003c/span\u003e\n            \u003cspan class=\"hljs-string\"\u003erollback\u003c/span\u003e\n            \u003cspan class=\"hljs-string\"\u003ebreak\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eelif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e$status\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e==\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e ]\u003cspan class=\"hljs-string\"\u003e;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ethen\u003c/span\u003e\n            \u003cspan class=\"hljs-string\"\u003eswitch\u003c/span\u003e\n            \u003cspan class=\"hljs-string\"\u003ebreak\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003efi\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003edone\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;do here\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e# 手动修改nginx的weight配置\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ecommond_set()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e# 保证只有一个脚本实例在执行\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003echeck_single()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e-s\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$C_FLAG\u003c/span\u003e ]\u003cspan class=\"hljs-string\"\u003e;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ethen\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e# 存在文件且非空\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eold_pid=$(cat\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$C_FLAG)\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003ekill\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e-9\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$old_pid\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003efi\u003c/span\u003e\n\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$C_PID\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026gt;$C_FLAG\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e# 判断当前的流量状况 0正常扩容 1新环境错误进行回退 2新环境无问题直接切换\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003echeck_status()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eres=$(run_str_shell\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(deploy2_exist)\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e-z\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$res\u0026quot;\u003c/span\u003e ]\u003cspan class=\"hljs-string\"\u003e;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ethen\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eelif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e$(error_strategy)\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e==\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e ]\u003cspan class=\"hljs-string\"\u003e;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ethen\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eelif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e$weight2\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e==\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e ]\u003cspan class=\"hljs-string\"\u003e;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ethen\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eelse\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003efi\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e# 判断新节点出错的依据\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eerror_strategy()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003ecnt=$(grep\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;^127.0.0.1:8005|500\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-c\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$C_LOG_PATH)\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e$cnt\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-gt\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e ]\u003cspan class=\"hljs-string\"\u003e;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ethen\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eelse\u003c/span\u003e\n        \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003efi\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e# 更新nginx配置\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eupdate_nginx()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(ingress_factory)\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026gt;$C_INGRESS_CONF\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003enginx\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-s\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ereload\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e# 回退nginx配置\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003esingle_nginx()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(ingress_ori_factory)\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026gt;$C_INGRESS_CONF\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003enginx\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-s\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ereload\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e# 灰度更新 渐渐扩大流量\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003egrayupdate()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eweight1=$((weight1\u003c/span\u003e \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003estep))\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eweight2=$((weight2\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e+\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003estep))\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eupdate_nginx\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e# 将流量添加到新的节点中\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 1、根据新镜像创建容器1\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 2、weight1为100 weight2为0\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 3、删除新节点的容器\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eswitch()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003eres=$(run_str_shell\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(deploy1_factory)\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003esingle_nginx\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eres=$(run_str_shell\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(deploy2_remove)\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e)\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e# 回退流量到原来的版本\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 1、将weight1全部为100 weight2为0\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# 2、删除新节点的容器\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003erollback()\u003c/span\u003e {\n    \u003cspan class=\"hljs-string\"\u003esingle_nginx\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003eres=$(run_str_shell\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;$(deploy2_remove)\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e)\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-string\"\u003emain\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$@\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e","frontMatter":{"readingTime":{"text":"12 min read","minutes":11.825,"time":709500,"words":2365},"slug":"如何使用nginx实现灰度部署","fileName":"如何使用nginx实现灰度部署.md","title":"如何使用nginx实现灰度部署","date":"2022-03-31T00:00:00.000Z","tags":["实践","云原生"],"draft":false,"summary":"灰度部署"}},"prev":{"title":"数据变更记录工具","date":"2022-03-15T00:00:00.000Z","tags":["实践","云原生"],"draft":false,"summary":"kubernetes环境搭建记录","slug":"一次k8s环境搭建记录"},"next":{"title":"tekton使用示例","date":"2022-05-20T00:00:00.000Z","tags":["实践","云原生"],"draft":false,"summary":"tekton作为云原生中的cd工具，能够轻易的做到task复用，减少重复代码编写","slug":"tekton使用示例"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["如何使用nginx实现灰度部署"]},"buildId":"xycpTPo5G1XEQLx5GlDdu","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>