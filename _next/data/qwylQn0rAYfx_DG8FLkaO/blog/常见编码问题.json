{"pageProps":{"post":{"mdxSource":"<h2>å†…å­˜æ³„æ¼å®ä¾‹</h2>\n<p>1ã€</p>\n<pre><code class=\"hljs language-go\">package main\n\n<span class=\"hljs-keyword\">import</span> (\n    <span class=\"hljs-string\">&quot;fmt&quot;</span>\n    <span class=\"hljs-string\">&quot;io/ioutil&quot;</span>\n    <span class=\"hljs-string\">&quot;net/http&quot;</span>\n    <span class=\"hljs-string\">&quot;runtime&quot;</span>\n)\n\nfunc <span class=\"hljs-title function_\">main</span>(<span class=\"hljs-params\"></span>) {\n    num := <span class=\"hljs-number\">6</span>\n    <span class=\"hljs-keyword\">for</span> index := <span class=\"hljs-number\">0</span>; index &lt; num; index++ {\n        resp, _ := http.<span class=\"hljs-title class_\">Get</span>(<span class=\"hljs-string\">&quot;https://www.baidu.com&quot;</span>)\n        _, _ = ioutil.<span class=\"hljs-title class_\">ReadAll</span>(resp.<span class=\"hljs-property\">Body</span>)\n    }\n    fmt.<span class=\"hljs-title class_\">Printf</span>(<span class=\"hljs-string\">&quot;æ­¤æ—¶goroutineä¸ªæ•°= %d\\n&quot;</span>, runtime.<span class=\"hljs-title class_\">NumGoroutine</span>())\n}\n</code></pre><blockquote>\n<p>æ³¨æ„ï¼Œå¦‚æœä»å•å…ƒæµ‹è¯•ä¸­è¿›è¡Œæµ‹è¯•ï¼Œé‚£ä¹ˆå°±æ˜¯4ä¸ªï¼Œå› ä¸ºå•å…ƒæµ‹è¯•å‡½æ•°å…¥å£ä¹Ÿä¼šç®—ä¸€ä¸ªğŸ˜¹</p>\n</blockquote>\n<ul>\n<li>è™½ç„¶æ‰§è¡Œäº† 6 æ¬¡å¾ªç¯ï¼Œè€Œä¸”æ¯æ¬¡éƒ½æ²¡æœ‰æ‰§è¡Œ Body.Close() ,å°±æ˜¯å› ä¸ºæ‰§è¡Œäº†ioutil.ReadAll()æŠŠå†…å®¹éƒ½è¯»å‡ºæ¥äº†ï¼Œè¿æ¥å¾—ä»¥å¤ç”¨ï¼Œå› æ­¤åªæ³„æ¼äº†ä¸€ä¸ªè¯»goroutineå’Œä¸€ä¸ªå†™goroutineï¼Œæœ€ååŠ ä¸Šmain goroutineï¼Œæ‰€ä»¥ç­”æ¡ˆå°±æ˜¯3ä¸ªgoroutineã€‚</li>\n<li>ä»å¦å¤–ä¸€ä¸ªè§’åº¦è¯´ï¼Œæ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬çš„ä»£ç éƒ½ä¼šæ‰§è¡Œ ioutil.ReadAll()ï¼Œä½†å¦‚æœæ­¤æ—¶å¿˜äº† resp.Body.Close()ï¼Œç¡®å®ä¼šå¯¼è‡´æ³„æ¼ã€‚ä½†å¦‚æœä½ è°ƒç”¨çš„åŸŸåä¸€ç›´æ˜¯åŒä¸€ä¸ªçš„è¯ï¼Œé‚£ä¹ˆåªä¼šæ³„æ¼ä¸€ä¸ª è¯»goroutine å’Œä¸€ä¸ªå†™goroutineï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä»£ç æ˜æ˜ä¸è§„èŒƒä½†å´çœ‹ä¸åˆ°æ˜æ˜¾å†…å­˜æ³„æ¼çš„åŸå› ã€‚</li>\n</ul>\n<p>2ã€</p>\n<pre><code class=\"hljs language-go\">func <span class=\"hljs-title function_\">fn</span>(<span class=\"hljs-params\"></span>) {\n    pub := <span class=\"hljs-title function_\">func</span>(<span class=\"hljs-params\">start int</span>) {\n        <span class=\"hljs-keyword\">for</span> j := start; j &lt; count; j += concurrency {\n            select {\n            <span class=\"hljs-keyword\">case</span> subscribers[j] &lt;- <span class=\"hljs-attr\">msg</span>:\n        <span class=\"hljs-keyword\">case</span> &lt;-time.After(time.Millisecond * 5):\n            case &lt;-b.exit:\n                return\n            }\n        }\n    }\n    \n    for i := 0; i &lt; concurrency; i++ {\n        go pub(i)\n    }\n}\n</code></pre><p>è¢«é—å¼ƒçš„time.Afterå®šæ—¶ä»»åŠ¡è¿˜æ˜¯åœ¨æ—¶é—´å †é‡Œé¢ï¼Œå®šæ—¶ä»»åŠ¡æœªåˆ°æœŸä¹‹å‰ï¼Œæ˜¯ä¸ä¼šè¢«gcæ¸…ç†çš„ï¼Œæ‰€ä»¥è¿™å°±æ˜¯ä¼šé€ æˆå†…å­˜æ³„æ¼çš„åŸå› </p>\n<p><code>time.After</code>è™½ç„¶è°ƒç”¨çš„æ˜¯<code>timer</code>å®šæ—¶å™¨ï¼Œä½†æ˜¯ä»–æ²¡æœ‰ä½¿ç”¨<code>time.Reset()</code>Â æ–¹æ³•å†æ¬¡æ¿€æ´»å®šæ—¶å™¨ï¼Œæ‰€ä»¥æ¯ä¸€æ¬¡éƒ½æ˜¯æ–°åˆ›å»ºçš„å®ä¾‹ï¼Œæ‰ä¼šé€ æˆçš„å†…å­˜æ³„æ¼ï¼Œæˆ‘ä»¬æ·»åŠ ä¸Š<code>time.Reset</code>æ¯æ¬¡é‡æ–°æ¿€æ´»å®šæ—¶å™¨ï¼Œå³å¯å®Œæˆè§£å†³é—®é¢˜ã€‚</p>\n<pre><code class=\"hljs language-go\">func <span class=\"hljs-title function_\">fn2</span>(<span class=\"hljs-params\">msg interface{}, subscribers []chan interface{}</span>) {\n    count := <span class=\"hljs-number\">100</span>\n    concurrency := <span class=\"hljs-number\">1</span>\n\n    <span class=\"hljs-comment\">//é‡‡ç”¨Timer è€Œä¸æ˜¯ä½¿ç”¨time.After åŸå› ï¼štime.Afterä¼šäº§ç”Ÿå†…å­˜æ³„æ¼ åœ¨è®¡æ—¶å™¨è§¦å‘ä¹‹å‰ï¼Œåƒåœ¾å›æ”¶å™¨ä¸ä¼šå›æ”¶Timer</span>\n    pub := <span class=\"hljs-title function_\">func</span>(<span class=\"hljs-params\">start int</span>) {\n        idleDuration := <span class=\"hljs-number\">5</span> * time.<span class=\"hljs-property\">Millisecond</span>\n        idleTimeout := time.<span class=\"hljs-title class_\">NewTimer</span>(idleDuration)\n        defer idleTimeout.<span class=\"hljs-title class_\">Stop</span>()\n        <span class=\"hljs-keyword\">for</span> j := start; j &lt; count; j += concurrency {\n        <span class=\"hljs-comment\">// å¦‚æœæ˜ç¡®timeå·²ç»expiredï¼Œå¹¶ä¸”t.Cå·²ç»è¯»å–è¿‡å€¼ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ä½¿ç”¨Resetï¼›å¦‚æœç¨‹åºä¹‹å‰æ²¡æœ‰ä»t.Cä¸­è¯»å–è¿‡å€¼ï¼Œè¿™æ—¶éœ€è¦é¦–å…ˆè°ƒç”¨Stop()ï¼Œå¦‚æœè¿”å›trueï¼Œè¯´æ˜timerè¿˜æ²¡æœ‰expireï¼ŒstopæˆåŠŸåˆ é™¤timerï¼Œå¯ç›´æ¥resetï¼›å¦‚æœè¿”å›falseï¼Œè¯´æ˜stopå‰å·²ç»expireï¼Œéœ€è¦æ˜¾å¼drain channelã€‚</span>\n            <span class=\"hljs-keyword\">if</span> !idleTimeout.<span class=\"hljs-title class_\">Stop</span>() {\n                select {\n                <span class=\"hljs-keyword\">case</span> &lt;-idleTimeout.C:\n                // é¿å…hangä½ æœ‰å¯èƒ½å·²ç»è¢«è¯»å–è¿‡äº†\n                default:\n                }\n            }\n        \n        // å®ƒçš„è¿”å›å€¼ä¸ä»£è¡¨é‡è®¾å®šæ—¶å™¨æˆåŠŸæˆ–å¤±è´¥ï¼Œè€Œæ˜¯åœ¨è¡¨è¾¾å®šæ—¶å™¨åœ¨é‡è®¾å‰çš„çŠ¶æ€ï¼š-   å½“Timerå·²ç»åœæ­¢æˆ–è€…è¶…æ—¶ï¼Œè¿”å›falseã€‚, -   å½“å®šæ—¶å™¨æœªè¶…æ—¶æ—¶ï¼Œè¿”å›trueã€‚\nidleTimeout.Reset(idleDuration)\n            select {\n            case subscribers[j] &lt;- msg:\n            case &lt;-idleTimeout.C:\n            }\n        }\n    }\n    for i := 0; i &lt; concurrency; i++ {\n        go pub(i)\n    }\n}\n</code></pre>","frontMatter":{"readingTime":{"text":"4 min read","minutes":3.87,"time":232200,"words":774},"slug":"å¸¸è§ç¼–ç é—®é¢˜","fileName":"å¸¸è§ç¼–ç é—®é¢˜.md","title":"golangç¼–ç¨‹ä¸­å¸¸è§çš„é—®é¢˜","date":"2022-10-10T00:00:00.000Z","tags":["Golang"],"draft":false,"summary":"golangç¼–ç¨‹ä¸­å¸¸è§çš„é—®é¢˜"}},"prev":{"title":"æ“ä½œç³»ç»Ÿæ€§èƒ½åˆ†æå·¥å…·","date":"2022-10-10T00:00:00.000Z","tags":["æ“ä½œç³»ç»Ÿ"],"draft":false,"summary":"æ“ä½œç³»ç»Ÿæ€§èƒ½åˆ†æå·¥å…·","slug":"æ“ä½œç³»ç»Ÿæ€§èƒ½åˆ†æå·¥å…·"},"next":{"title":"golangå‘½ä»¤å·¥å…·","date":"2022-10-10T00:00:00.000Z","tags":["Golang"],"draft":false,"summary":"golangå‘½ä»¤å·¥å…·","slug":"goå‘½ä»¤å·¥å…·"}},"__N_SSG":true}