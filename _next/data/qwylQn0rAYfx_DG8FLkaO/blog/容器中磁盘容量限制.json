{"pageProps":{"post":{"mdxSource":"<h1>èƒŒæ™¯</h1>\n<p>å®¹å™¨ä¸å®¿ä¸»æœºå…±äº«ç£ç›˜ç©ºé—´ï¼Œå¦‚æœä¸åšå®¹é‡é™åˆ¶ï¼Œä¼šå­˜åœ¨å†™æ»¡å®¿ä¸»æœºçš„å¯èƒ½</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\"># ä¸‹é¢çš„å°±æ˜¯åœ¨å®¹å™¨ä¸­æŸ¥çœ‹åˆ°çš„ï¼Œå®é™…çš„ç©ºé—´é‡å°±æ˜¯å®¿ä¸»æœºä¸Šçš„</span>\n$ df -h\nFilesystem      Size  Used Avail Use% Mounted on\noverlay          49G   22G   25G  <span class=\"hljs-number\">47</span>% /\n</code></pre><p>overlayæ–‡ä»¶ç³»ç»Ÿä¸­å¹¶æ²¡æœ‰ç›´æ¥é™åˆ¶ç£ç›˜quotaçš„åŠŸèƒ½</p>\n<p>å½“ä½¿ç”¨dockeræ—¶é™åˆ¶çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯ç”¨ XFS Quota æ¥é™åˆ¶å®¹å™¨çš„ OverlayFS å¤§å°ï¼Œé™åˆ¶upperdirçš„ç›®å½•å¤§å°</p>\n<blockquote>\n<p>swarmæ¨¡å¼ä¸‹ä¸æ”¯æŒé™åˆ¶å®¹å™¨çš„ç£ç›˜quota(æˆ–è€…æš‚æ—¶ä¸çŸ¥é“ğŸ¤”</p>\n</blockquote>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\"># dockeræ¨¡å¼ä¸‹</span>\n$docker run -it --rm --storage-opt size=10M ubuntu:<span class=\"hljs-number\">22.10</span> bash\ndocker: Error response <span class=\"hljs-keyword\">from</span> daemon: --storage-opt <span class=\"hljs-keyword\">is</span> supported only <span class=\"hljs-keyword\">for</span> overlay over xfs <span class=\"hljs-keyword\">with</span> <span class=\"hljs-string\">&#x27;pquota&#x27;</span> mount option.\n</code></pre><p>æŸ¥çœ‹dockeræºç ä¸­ä¼šå‘ç°ä½¿ç”¨äº†xfsçš„projectæœºåˆ¶,ä¸‹é¢æ˜¯æ ¸å¿ƒä»£ç </p>\n<pre><code class=\"hljs language-go\"><span class=\"hljs-comment\">// moby/quota/projectquota.go</span>\n<span class=\"hljs-comment\">// setProjectQuota - set the quota for project id on xfs block device</span>\n<span class=\"hljs-function\">func <span class=\"hljs-title\">setProjectQuota</span><span class=\"hljs-params\">(backingFsBlockDev string, projectID uint32, quota Quota)</span> error </span>{\n    var d C.<span class=\"hljs-type\">fs_disk_quota_t</span>\n    d.d_version = C.FS_DQUOT_VERSION\n    d.d_id = C.__u32(projectID)\n    d.d_flags = C.XFS_PROJ_QUOTA\n\n    d.d_fieldmask = C.FS_DQ_BHARD | C.FS_DQ_BSOFT\n    d.d_blk_hardlimit = C.__u64(quota.Size / <span class=\"hljs-number\">512</span>)\n    d.d_blk_softlimit = d.d_blk_hardlimit\n\n    var cs = C.<span class=\"hljs-built_in\">CString</span>(backingFsBlockDev)\n    defer C.<span class=\"hljs-built_in\">free</span>(unsafe.<span class=\"hljs-built_in\">Pointer</span>(cs))\n\n    _, _, errno := unix.<span class=\"hljs-built_in\">Syscall6</span>(unix.SYS_QUOTACTL, C.Q_XSETPQLIM,\n        <span class=\"hljs-built_in\">uintptr</span>(unsafe.<span class=\"hljs-built_in\">Pointer</span>(cs)), <span class=\"hljs-built_in\">uintptr</span>(d.d_id),\n        <span class=\"hljs-built_in\">uintptr</span>(unsafe.<span class=\"hljs-built_in\">Pointer</span>(&amp;d)), <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>)\n    <span class=\"hljs-keyword\">if</span> errno != <span class=\"hljs-number\">0</span> {\n        <span class=\"hljs-keyword\">return</span> errors.<span class=\"hljs-built_in\">Wrapf</span>(errno, <span class=\"hljs-string\">&quot;failed to set quota limit for projid %d on %s&quot;</span>,\n            projectID, backingFsBlockDev)\n    }\n\n    <span class=\"hljs-keyword\">return</span> nil\n}\n</code></pre><h1>dockerç¯å¢ƒä¸‹å®éªŒ</h1>\n<p>å‰é¢çœ‹åˆ°ä¸åšç‰¹æ®Šå¤„ç†çš„dockeræ˜¯æ— æ³•ä½¿ç”¨ç£ç›˜quotaé™åˆ¶çš„</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-string\">$</span> <span class=\"hljs-string\">docker</span> <span class=\"hljs-string\">info</span>\n<span class=\"hljs-string\">...</span>\n<span class=\"hljs-attr\">Storage Driver:</span> <span class=\"hljs-string\">overlay2</span>\n  <span class=\"hljs-attr\">Backing Filesystem:</span> <span class=\"hljs-string\">extfs</span>\n  <span class=\"hljs-attr\">Supports d_type:</span> <span class=\"hljs-literal\">true</span>\n  <span class=\"hljs-attr\">Native Overlay Diff:</span> <span class=\"hljs-literal\">true</span>\n  <span class=\"hljs-attr\">userxattr:</span> <span class=\"hljs-literal\">false</span>\n<span class=\"hljs-string\">...</span>\n</code></pre><p>ç›®å‰åç«¯çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯extfsï¼Œéœ€è¦åˆ‡æ¢è‡³xfs</p>\n<pre><code class=\"hljs language-bash\">$ docker info | grep <span class=\"hljs-string\">&quot;Docker Root Dir&quot;</span>\n<span class=\"hljs-title class_\">Docker</span> <span class=\"hljs-title class_\">Root</span> <span class=\"hljs-title class_\">Dir</span>: <span class=\"hljs-regexp\">/var/</span>lib/docker\n\n$ df -T -h /<span class=\"hljs-keyword\">var</span>/lib/docker\n<span class=\"hljs-title class_\">Filesystem</span>     <span class=\"hljs-title class_\">Type</span>  <span class=\"hljs-title class_\">Size</span>  <span class=\"hljs-title class_\">Used</span> <span class=\"hljs-title class_\">Avail</span> <span class=\"hljs-title class_\">Use</span>% <span class=\"hljs-title class_\">Mounted</span> on\n/dev/sda3      ext4   49G   22G   25G  <span class=\"hljs-number\">47</span>% /\n</code></pre><blockquote>\n<p>èšŒåŸ ä½äº†, dockerç›´æ¥å®‰è£…åœ¨çš„æ ¹ç›®å½•ï¼Œæ–‡ä»¶ç³»ç»Ÿæ˜¯ext4ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»é‡æ–°å®‰è£…dockeråœ¨xfsæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹ä¸Š</p>\n</blockquote>\n<h1>åœ¨xfsæ–‡ä»¶ç³»ç»Ÿä¸Šå®éªŒ</h1>\n<p>å®éªŒä¸€ä¸‹æ‰‹åŠ¨é™åˆ¶</p>\n<p>è¦ä½¿ç”¨ XFS Quota ç‰¹æ€§ï¼Œå¿…é¡»åœ¨æ–‡ä»¶ç³»ç»ŸæŒ‚è½½çš„æ—¶å€™åŠ ä¸Šå¯¹åº”çš„ Quota é€‰é¡¹ï¼Œæ¯”å¦‚éœ€è¦é…ç½® Project Quotaï¼Œé‚£ä¹ˆè¿™ä¸ªæŒ‚è½½å‚æ•°å°±æ˜¯&quot;pquota&quot;ã€‚</p>\n<blockquote>\n<p>å¯¹äºæ ¹ç›®å½•æ¥è¯´ï¼Œè¿™ä¸ªå‚æ•°å¿…é¡»ä½œä¸ºä¸€ä¸ªå†…æ ¸å¯åŠ¨çš„å‚æ•°&quot;rootflags=pquota&quot;ï¼Œè¿™æ ·è®¾ç½®å°±å¯ä»¥ä¿è¯æ ¹ç›®å½•åœ¨å¯åŠ¨æŒ‚è½½çš„æ—¶å€™ï¼Œå¸¦ä¸Š XFS Quota çš„ç‰¹æ€§å¹¶ä¸”æ”¯æŒ Project æ¨¡å¼ã€‚</p>\n</blockquote>\n<p>ç”±äºæˆ‘çš„æ ¹ç›®å½•æ˜¯ext4æ–‡ä»¶æ ¼å¼ï¼Œæ‰€ä»¥æ–°åˆ›å»ºä¸€ä¸ªåˆ†åŒºï¼Œæ ¼å¼åŒ–ä¸ºxfsç³»ç»Ÿï¼Œå¹¶ä¸”é…ç½®ä¸ºproject quota</p>\n<blockquote>\n<p>This disk is currently in use - repartitioning is probably a bad idea.\nIt&#39;s recommended to umount all file systems, and swapoff all swap\npartitions on this disk.\nä¸ºæ­£åœ¨ä½¿ç”¨çš„ç£ç›˜å»ºç«‹åˆ†åŒºä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œè¦ä¹ˆæ–°å»ºä¸€ä¸ªç£ç›˜ï¼Œæˆ‘è¿™é‡Œç”±äºä½¿ç”¨çš„æ˜¯è™šæ‹Ÿæœºï¼Œå°±ç”¨è™šæ‹Ÿæœºæ·»åŠ ä¸€å—ç¡¬ç›˜</p>\n</blockquote>\n<pre><code class=\"hljs language-bash\">$ sudo apt-get install xfsprogs  <span class=\"hljs-comment\"># xfsæ–‡ä»¶ç³»ç»Ÿç›¸å…³å·¥å…·é›†</span>\n\n$ fdisk -l\n\n$ fdisk /dev/sdb\nCommand (m <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): n     &lt;- æ–°å»ºåˆ†åŒº\nCommand action              &lt;- é€‰æ‹©è¦åˆ›å»ºçš„åˆ†åŒºç±»å‹\n   e   extended &lt;- æ‰©å±•åˆ†åŒº\n   p   primary partition (<span class=\"hljs-number\">1</span>-<span class=\"hljs-number\">4</span>) &lt;- ä¸»åˆ†åŒº\np &lt;- è¾“å…¥å»ºç«‹ä¸»åˆ†åŒº\nPartition number (<span class=\"hljs-number\">1</span>-<span class=\"hljs-number\">4</span>):<span class=\"hljs-number\">1</span>    &lt;- åˆ†åŒºç¼–å·\nFirst sector (<span class=\"hljs-number\">2048</span>-<span class=\"hljs-number\">20971519</span>, default <span class=\"hljs-number\">2048</span>): &lt;- ç›´æ¥å›è½¦é»˜è®¤\nLast sector, +/-sectors <span class=\"hljs-keyword\">or</span> +/-size{K,M,G,T,P} (<span class=\"hljs-number\">2048</span>-<span class=\"hljs-number\">20971519</span>, default <span class=\"hljs-number\">20971519</span>):     +1G  &lt;-åˆ†åŒºå¤§å°\nCommand (m <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): w     &lt;- ä¿å­˜åˆ†åŒºè¡¨, å®Œæ¯•ä¼šé€€å‡ºfdiskå‘½ä»¤\nThe partition table has been altered!\n\nCalling ioctl() to re-read partition table.\nSyncing disks.\n\n$ fdisk /dev/sdb <span class=\"hljs-comment\"># æŸ¥çœ‹åˆ†åŒºæ˜¯å¦åˆ›å»ºæˆåŠŸ</span>\nCommand (m <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>): p     &lt;- æ‰“å°å½“å‰ç£ç›˜çš„åˆ†åŒºä¿¡æ¯\n...\nDevice     Boot Start     End Sectors Size Id <span class=\"hljs-type\">Type</span>\n/dev/sdb1        <span class=\"hljs-number\">2048</span> <span class=\"hljs-number\">2099199</span> <span class=\"hljs-number\">2097152</span>   1G <span class=\"hljs-number\">83</span> Linux\n...\n\n$ mkfs.xfs /dev/sdb1 <span class=\"hljs-comment\"># ä¸ºåˆ†åŒºæ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿ, å¦‚æœå‡ºç°`The device apparently does not exist; did you specify it correctly?`,éœ€è¦é‡å¯ç³»ç»Ÿç„¶åæ ¼å¼åŒ–</span>\n</code></pre><p>æŒ‚è½½åˆ†åŒºï¼Œè¦ä½¿ç”¨Project Quota åŠŸèƒ½ï¼Œéœ€è¦åœ¨æŒ‚è½½æ—¶æŒ‡å®š<code>-o prjquota</code>å‚æ•°ï¼Œå¹¶ä¸”è¿™ä¸ªå‚æ•°è¿˜ä¸èƒ½å’Œusrquotaã€grpquotaä¸€èµ·ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå¼€å¯Project Quotaå°±æ— æ³•ä½¿ç”¨é’ˆå¯¹ç”¨æˆ·å’Œç”¨æˆ·ç»„çš„é…é¢é™åˆ¶ã€‚</p>\n<pre><code class=\"hljs language-bash\">$ rm -rf /xfstest &amp;&amp; mkdir /xfstest &amp;&amp; mount -o prjquota /dev/sdb1 /xfstest\n\n$ rm -rf /xfstest &amp;&amp; mkdir /xfstest &amp;&amp; mount -o pquota /dev/sdb1 /xfstest\n\n$ df -lhT\nFilesystem     <span class=\"hljs-type\">Type</span>     Size  Used Avail Use% Mounted on\n...\n/dev/sdb1      xfs     1014M   40M  975M   <span class=\"hljs-number\">4</span>% /xfstest\n\n$ cat /proc/mounts | grep prjquota <span class=\"hljs-comment\"># æ£€éªŒæ˜¯å¦ç”Ÿæ•ˆ</span>\n/dev/sdb1 /xfstest xfs rw,relatime,attr2,inode64,logbufs=<span class=\"hljs-number\">8</span>,logbsize=32k,prjquota <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>\n</code></pre><p>ç»™ä¸€ä¸ªæŒ‡å®šçš„ç›®å½•æ‰“ä¸Šä¸€ä¸ª Project IDï¼Œå¯¹æ‰“å¥½project idçš„åšä¸Šèµ„æºé™åˆ¶</p>\n<pre><code class=\"hljs language-bash\">$ mkdir -p /xfstest/xfs_prjquota \n\n$ xfs_quota -x -c <span class=\"hljs-string\">&#x27;project -s -p /xfstest/xfs_prjquota 1&#x27;</span> <span class=\"hljs-comment\"># ä¸ºæ–‡ä»¶å¤¹åˆ†é…ProjectID 1</span>\n\n$ xfs_quota -x -c <span class=\"hljs-string\">&#x27;limit -p bhard=10m 1&#x27;</span> /xfstest  <span class=\"hljs-comment\"># åé¢çš„/xfstestå°±æ˜¯è¿™ä¸ªxfsæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹</span>\n</code></pre><p>å®éªŒä¸€ä¸‹èƒ½å¦å®Œæˆèµ„æºé™åˆ¶</p>\n<pre><code class=\"hljs language-bash\">$ dd <span class=\"hljs-keyword\">if</span>=/dev/zero of=/xfstest/xfs_prjquota/test.file bs=<span class=\"hljs-number\">1024</span> count=<span class=\"hljs-number\">20000</span>  <span class=\"hljs-comment\"># 20000ä¸ª1024å¤§å°çš„åŒºå—ï¼Œ20m</span>\ndd: error writing <span class=\"hljs-string\">&#x27;/xfstest/xfs_prjquota/test.file&#x27;</span>: No space left on device\n<span class=\"hljs-number\">10241</span>+<span class=\"hljs-number\">0</span> records <span class=\"hljs-keyword\">in</span>\n<span class=\"hljs-number\">10240</span>+<span class=\"hljs-number\">0</span> records out\n<span class=\"hljs-number\">10485760</span> <span class=\"hljs-built_in\">bytes</span> (<span class=\"hljs-number\">10</span> MB, <span class=\"hljs-number\">10</span> MiB) copied, <span class=\"hljs-number\">0.0514849</span> s, <span class=\"hljs-number\">204</span> MB/s\n\n$ du -h /xfstest\n10M\t/xfstest/xfs_prjquota\n10M\t/xfstest\n</code></pre><p>å®éªŒæˆåŠŸ</p>\n<blockquote>\n<p>dockeréƒ¨åˆ†é‡æ–°å®‰è£…é‚£ä»£ä»·æœ‰ç‚¹å¤§ï¼Œä¸‹æ¬¡æœ‰ç©ºå†è¯•ğŸ˜‚</p>\n</blockquote>\n","frontMatter":{"readingTime":{"text":"7 min read","minutes":6.87,"time":412200,"words":1374},"slug":"å®¹å™¨ä¸­ç£ç›˜å®¹é‡é™åˆ¶","fileName":"å®¹å™¨ä¸­ç£ç›˜å®¹é‡é™åˆ¶.md","title":"å®¹å™¨ä¸­ç£ç›˜å®¹é‡é™åˆ¶å®è·µ","date":"2022-11-02T00:00:00.000Z","tags":["å®è·µ"],"draft":false,"summary":"å®¹å™¨ä¸­ç£ç›˜å®¹é‡é™åˆ¶å®è·µ"}},"prev":{"title":"overlayæ–‡ä»¶ç³»ç»Ÿ","date":"2022-11-01T00:00:00.000Z","tags":["å®è·µ"],"draft":false,"summary":"overlayæ–‡ä»¶ç³»ç»Ÿå®è·µï¼Œæ¢ç´¢å®¹å™¨åŸç†","slug":"overlayæ–‡ä»¶ç³»ç»Ÿå®éªŒ"},"next":{"title":"ä»€ä¹ˆæ˜¯è¿›ç¨‹","date":"2023-02-28T00:00:00.000Z","tags":["è®¡ç®—æœºåŸç†"],"draft":false,"summary":"ä»€ä¹ˆæ˜¯è¿›ç¨‹","slug":"ä»€ä¹ˆæ˜¯è¿›ç¨‹"}},"__N_SSG":true}