{"pageProps":{"post":{"mdxSource":"<p>在cgroup1中，限制cpu的参数是</p>\n<ul>\n<li>cpu.cfs_quota_us(CFS调度周期)</li>\n<li>cpu.cfs_period_us(在一个调度周期中允许执行的时间)</li>\n<li>cpu.shares，控制组之间的CPU分配比例</li>\n</ul>\n<p>在v2中只有两个参数了</p>\n<ul>\n<li>cpu.max</li>\n<li>cpu.weight</li>\n</ul>\n<h2>实验</h2>\n<p>一个两个cpu耗时的程序</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\">#!/bin/bash</span>\n<span class=\"hljs-string\">if</span> [ <span class=\"hljs-string\">$#</span> <span class=\"hljs-type\">!=</span> <span class=\"hljs-number\">1</span> ] <span class=\"hljs-string\">;</span> <span class=\"hljs-string\">then</span>\n    <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&quot;USAGE: $0 &lt;CPUs&gt;&quot;</span>\n    <span class=\"hljs-string\">exit</span> <span class=\"hljs-number\">1</span><span class=\"hljs-string\">;</span>\n<span class=\"hljs-string\">fi</span>\n\n<span class=\"hljs-string\">function</span> <span class=\"hljs-string\">endless_loop()</span>\n{\n    <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">-ne</span> <span class=\"hljs-string\">&quot;i=0;\n    while true\n    do\n    i=i+100;\n    i=100\n    done&quot;</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">/bin/bash</span> <span class=\"hljs-string\">&amp;</span>\n}\n\n<span class=\"hljs-string\">for</span> <span class=\"hljs-string\">i</span> <span class=\"hljs-string\">in</span> <span class=\"hljs-string\">`seq</span> <span class=\"hljs-string\">$1`;</span> <span class=\"hljs-string\">do</span>\n    <span class=\"hljs-string\">endless_loop</span>\n    <span class=\"hljs-string\">pid_array[$i]=$!</span> <span class=\"hljs-string\">;</span>\n<span class=\"hljs-string\">done</span>\n\n<span class=\"hljs-string\">for</span> <span class=\"hljs-string\">i</span> <span class=\"hljs-string\">in</span> <span class=\"hljs-string\">&quot;${pid_array[@]}&quot;</span><span class=\"hljs-string\">;</span> <span class=\"hljs-string\">do</span>\n    <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">&#x27;kill &#x27;</span> <span class=\"hljs-string\">$i</span> <span class=\"hljs-string\">&#x27;;&#x27;</span><span class=\"hljs-string\">;</span>\n<span class=\"hljs-string\">done</span>\n</code></pre><p>在<code>/sys/fs/cgroup</code>中添加一个进程组，设为ctest</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\"># 启动程序 这个shell脚本传入几就占用几个cpu，不过也同样的会有多个进程，所以需要把这多个进程一起加入到cgroup中</span>\n\n<span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">$?</span> <span class=\"hljs-string\">&gt;&gt;</span> <span class=\"hljs-string\">/sys/fs/cgroup/ctest/cgroup.procs</span>\n</code></pre><p>使用top查看这个进程的CPU占用情况</p>\n<p>加入cgroup资源限制条件</p>\n<pre><code class=\"hljs language-bash\">echo <span class=\"hljs-number\">100</span> &gt;&gt; /sys/fs/cgroup/ctest/cpu.weight\n\necho <span class=\"hljs-number\">50000</span> &gt;&gt; /sys/fs/cgroup/ctest/cpu.<span class=\"hljs-built_in\">max</span> <span class=\"hljs-comment\"># 0.5个CPU</span>\n</code></pre><p>继续查看资源消耗</p>\n<p>实验结果</p>\n<img src=\"/images/blogs/cgroupcpu实验.png\" />\n\n<p>可以看到两个加起来只占了0.5个，说明成功了</p>\n","frontMatter":{"readingTime":{"text":"2 min read","minutes":1.715,"time":102900,"words":343},"slug":"CPU限制实践","fileName":"CPU限制实践.md","title":"CPU限制实战","date":"2022-10-30T00:00:00.000Z","tags":["实践"],"draft":false,"summary":"cgroup-cpu限制实践"}},"prev":{"title":"内存限制实战","date":"2022-10-30T00:00:00.000Z","tags":["实践"],"draft":false,"summary":"cgroup-内存限制实践","slug":"内存限制实践"},"next":{"title":"手动建立容器网络实践","date":"2022-10-31T00:00:00.000Z","tags":["实践"],"draft":false,"summary":"amespace-网络配置实践","slug":"从none网络实践容器的网络配置"}},"__N_SSG":true}